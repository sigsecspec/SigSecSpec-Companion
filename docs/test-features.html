<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feature Test ‚Äî Security Companion</title>
  <link rel="stylesheet" href="app-styles.css">
  <script src="push-notifications.js"></script>
  <script src="app-common.js"></script>
</head>
<body class="bg-pattern">
  <header class="app-header">
    <div class="flex items-center gap-3">
      <div class="app-logo">
        <img src="patch-bg.png" alt="Security Logo">
      </div>
      <div class="header-content">
        <h1>Feature Test</h1>
        <p>Test new mission and patrol features</p>
      </div>
    </div>
  </header>

  <main class="main-content">
    <section class="mobile-card mb-6">
      <h2 class="text-xl font-bold mb-4">Mission System Test</h2>
      <div class="space-y-3">
        <button class="touch-btn primary w-full" onclick="testStartMission()">
          üöÄ Test Start Mission
        </button>
        <button class="touch-btn w-full" onclick="testScheduleMission()">
          üìÖ Test Schedule Mission
        </button>
        <button class="touch-btn w-full" onclick="testPatrolNotification()">
          üö∂ Test Patrol Notification
        </button>
        <button class="touch-btn w-full" onclick="testMissionReminder()">
          üîî Test Mission Reminder
        </button>
        <button class="touch-btn danger w-full" onclick="clearAllData()">
          üßπ Clear All Test Data
        </button>
      </div>
    </section>

    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-3">Current State</h3>
      <div id="currentState" class="space-y-2 text-sm">
        <!-- State info will be populated here -->
      </div>
    </section>

    <section class="mobile-card">
      <h3 class="text-lg font-semibold mb-3">Test Results</h3>
      <div id="testResults" class="space-y-2 text-sm">
        <div>Ready to run tests...</div>
      </div>
    </section>
  </main>

  <nav class="bottom-nav">
    <div class="nav-grid">
      <a href="index.html" class="nav-item">
        <div class="nav-icon">üè†</div>
        <span>Home</span>
      </a>
      <a href="patrol.html" class="nav-item">
        <div class="nav-icon">üö∂</div>
        <span>Patrol</span>
      </a>
    </div>
  </nav>

  <script>
    function addTestResult(message, type = 'info') {
      const container = document.getElementById('testResults');
      const div = document.createElement('div');
      div.className = `p-2 rounded text-sm ${type === 'success' ? 'bg-green-900 text-green-100' : type === 'error' ? 'bg-red-900 text-red-100' : 'bg-blue-900 text-blue-100'}`;
      div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      container.insertBefore(div, container.firstChild);
    }

    function updateCurrentState() {
      const container = document.getElementById('currentState');
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
      const missionHistory = JSON.parse(localStorage.getItem('missionHistory') || '[]');
      const completedPatrols = JSON.parse(localStorage.getItem('completedPatrols') || '[]');

      container.innerHTML = `
        <div><strong>Active Mission:</strong> ${activeMission ? 'Yes (' + activeMission.status + ')' : 'None'}</div>
        <div><strong>Scheduled Missions:</strong> ${scheduledMissions.length}</div>
        <div><strong>Mission History:</strong> ${missionHistory.length}</div>
        <div><strong>Completed Patrols:</strong> ${completedPatrols.length}</div>
        <div><strong>Notifications:</strong> ${window.securityNotifications?.isInitialized ? 'Enabled' : 'Disabled'}</div>
      `;
    }

    function testStartMission() {
      try {
        const mission = {
          id: Date.now(),
          startTime: new Date().toISOString(),
          status: 'active',
          type: 'test'
        };
        
        localStorage.setItem('activeMission', JSON.stringify(mission));
        addTestResult('Mission started successfully', 'success');
        updateCurrentState();
      } catch (error) {
        addTestResult('Failed to start mission: ' + error.message, 'error');
      }
    }

    function testScheduleMission() {
      try {
        const mission = {
          id: Date.now(),
          title: 'Test Mission',
          date: new Date().toISOString().split('T')[0],
          startTime: new Date(Date.now() + 60000).toTimeString().slice(0, 5), // 1 minute from now
          endTime: new Date(Date.now() + 3660000).toTimeString().slice(0, 5), // 1 hour 1 minute from now
          location: 'Test Location',
          description: 'This is a test mission',
          enableNotifications: true,
          status: 'scheduled',
          createdAt: new Date().toISOString()
        };

        const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
        scheduledMissions.push(mission);
        localStorage.setItem('scheduledMissions', JSON.stringify(scheduledMissions));
        
        addTestResult('Mission scheduled successfully', 'success');
        updateCurrentState();
      } catch (error) {
        addTestResult('Failed to schedule mission: ' + error.message, 'error');
      }
    }

    function testPatrolNotification() {
      try {
        if (window.securityNotifications) {
          window.securityNotifications.sendPatrolReminder('test area', 'Active mission in progress');
          addTestResult('Patrol notification sent', 'success');
        } else {
          addTestResult('Notification system not available', 'error');
        }
      } catch (error) {
        addTestResult('Failed to send patrol notification: ' + error.message, 'error');
      }
    }

    function testMissionReminder() {
      try {
        if (window.securityNotifications) {
          const testMission = {
            id: 'test-mission',
            title: 'Test Mission Reminder'
          };
          window.securityNotifications.sendMissionReminder(testMission, 'in 30 minutes');
          addTestResult('Mission reminder sent', 'success');
        } else {
          addTestResult('Notification system not available', 'error');
        }
      } catch (error) {
        addTestResult('Failed to send mission reminder: ' + error.message, 'error');
      }
    }

    function clearAllData() {
      if (confirm('This will clear all test data. Continue?')) {
        localStorage.removeItem('activeMission');
        localStorage.removeItem('scheduledMissions');
        localStorage.removeItem('missionHistory');
        localStorage.removeItem('completedPatrols');
        addTestResult('All test data cleared', 'success');
        updateCurrentState();
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initTheme();
      updateCurrentState();
      setInterval(updateCurrentState, 5000); // Update every 5 seconds
    });
  </script>
</body>
</html>