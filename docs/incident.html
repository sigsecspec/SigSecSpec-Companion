<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Incident Report â€” Security Companion</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="patch-bg.png">
  <link rel="icon" type="image/png" href="patch-bg.png">
</head>
<body>
  <!-- Background -->
  <div class="app-background"></div>

  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <div class="logo-wrapper">
        <div class="logo-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
          <span style="font-size: 24px;">ğŸ“</span>
        </div>
        <div class="logo-text">
          <div class="logo-title">Incident Report</div>
          <div class="logo-subtitle">Professional Narrative Generator</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button class="theme-toggle" onclick="app.theme.toggleTheme()" aria-label="Toggle theme">
          <span class="theme-toggle-icon moon">ğŸŒ™</span>
          <span class="theme-toggle-icon sun">â˜€ï¸</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content Split View -->
  <main class="main-content" style="display: flex; flex-direction: column; gap: 1rem;">
    <!-- Top Section - Generated Report Preview -->
    <section class="card" style="flex: 1; min-height: 300px; max-height: 40vh; overflow-y: auto;">
      <div class="flex justify-between items-center mb-3">
        <div>
          <h2 class="text-xl font-bold">Generated Report & Narrative</h2>
          <div id="reportStatus" class="text-sm text-secondary mt-1">Fill in the fields below to generate report</div>
        </div>
        <div class="flex gap-2">
          <button class="btn" onclick="incidentPage.saveDraft()">
            <span>ğŸ’¾</span>
            <span class="hidden sm:inline">Draft</span>
          </button>
          <button class="btn" onclick="incidentPage.loadDraft()">
            <span>ğŸ“‚</span>
            <span class="hidden sm:inline">Load</span>
          </button>
          <button class="btn btn-primary" onclick="incidentPage.saveReport()">
            <span>âœ…</span>
            <span class="hidden sm:inline">Save</span>
          </button>
          <button class="btn btn-success" onclick="incidentPage.copyReport()">
            <span>ğŸ“‹</span>
            <span class="hidden sm:inline">Copy</span>
          </button>
        </div>
      </div>
      
      <!-- Report Display -->
      <div class="bg-quaternary rounded-lg p-4" style="font-family: 'Courier New', monospace;">
        <pre id="reportNarrative" class="text-sm whitespace-pre-wrap" style="color: var(--text-secondary);">
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          INCIDENT REPORT - NOT GENERATED YET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Please fill in the incident details below to generate a comprehensive report.
The system will automatically:
â€¢ Anonymize all names (Victim1, Suspect1, Witness1, etc.)
â€¢ Generate a detailed, professional narrative
â€¢ Format everything properly for official use

Start by filling in the basic incident information below...</pre>
      </div>
    </section>

    <!-- Bottom Section - Input Form -->
    <section class="card" style="flex: 1; overflow-y: auto;">
      <h3 class="text-lg font-semibold mb-3">ğŸ“ Incident Details - Fill in the Blanks</h3>
      <p class="text-sm text-secondary mb-4">Complete all fields to generate a detailed report. All names will be anonymized automatically.</p>

      <div class="space-y-4">
        <!-- When & Where -->
        <div class="bg-tertiary rounded-lg p-4">
          <h4 class="font-semibold mb-3 text-accent">â° When & Where</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-secondary mb-1">Date & Time of Incident</label>
              <input type="datetime-local" id="incidentDateTime" class="input" onchange="incidentPage.generateReport()">
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Report Filed Date & Time</label>
              <input type="datetime-local" id="reportDateTime" class="input" onchange="incidentPage.generateReport()">
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Location/Property Name</label>
              <input type="text" id="location" class="input" placeholder="e.g., ABC Shopping Mall" onchange="incidentPage.generateReport()">
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Specific Area/Address</label>
              <input type="text" id="specificLocation" class="input" placeholder="e.g., North Parking Lot, Level 2" onchange="incidentPage.generateReport()">
            </div>
          </div>
        </div>

        <!-- Incident Classification -->
        <div class="bg-tertiary rounded-lg p-4">
          <h4 class="font-semibold mb-3 text-accent">ğŸš¨ Incident Classification</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-secondary mb-1">Incident Type</label>
              <select id="incidentType" class="input" onchange="incidentPage.generateReport()">
                <option value="">Select Type...</option>
                <option value="Trespassing">Trespassing</option>
                <option value="Theft">Theft</option>
                <option value="Vandalism">Vandalism/Property Damage</option>
                <option value="Assault">Assault</option>
                <option value="Disturbance">Disturbance</option>
                <option value="Suspicious Activity">Suspicious Activity</option>
                <option value="Medical Emergency">Medical Emergency</option>
                <option value="Fire/Smoke">Fire/Smoke</option>
                <option value="Alarm Response">Alarm Response</option>
                <option value="Vehicle Incident">Vehicle Incident</option>
                <option value="Slip and Fall">Slip and Fall</option>
                <option value="Lost Property">Lost Property</option>
                <option value="Found Property">Found Property</option>
                <option value="Parking Violation">Parking Violation</option>
                <option value="Access Control">Access Control Issue</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Severity Level</label>
              <select id="severity" class="input" onchange="incidentPage.generateReport()">
                <option value="Low">Low - Minor Incident</option>
                <option value="Medium">Medium - Moderate Concern</option>
                <option value="High">High - Serious Incident</option>
                <option value="Critical">Critical - Emergency Response</option>
              </select>
            </div>
          </div>
        </div>

        <!-- People Involved -->
        <div class="bg-tertiary rounded-lg p-4">
          <h4 class="font-semibold mb-3 text-accent">ğŸ‘¥ People Involved</h4>
          <div id="peopleContainer" class="space-y-2 mb-3">
            <!-- Dynamic people entries will be added here -->
            <div class="text-sm text-muted text-center py-4">No people added yet. Use buttons below to add involved parties.</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-danger" onclick="incidentPage.addPerson('victim')">+ Add Victim</button>
            <button class="btn btn-warning" onclick="incidentPage.addPerson('suspect')">+ Add Suspect</button>
            <button class="btn btn-info" onclick="incidentPage.addPerson('witness')">+ Add Witness</button>
            <button class="btn" onclick="incidentPage.showAddPersonModal()">+ Add Custom</button>
          </div>
        </div>

        <!-- Narrative Section -->
        <div class="bg-tertiary rounded-lg p-4">
          <h4 class="font-semibold mb-3 text-accent">ğŸ“‹ Incident Narrative</h4>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-secondary mb-1">How did the incident begin? (Initial Contact/Discovery)</label>
              <textarea id="initialContact" class="textarea" rows="2" placeholder="e.g., While conducting routine patrol at 1430 hours, I observed..." onchange="incidentPage.generateReport()"></textarea>
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Describe what happened (Sequence of Events)</label>
              <div class="mb-2">
                <textarea id="incidentDescription" class="textarea" rows="4" placeholder="Describe the incident in detail - what you saw, heard, and did..." onchange="incidentPage.generateReport()"></textarea>
              </div>
              <button class="btn w-full" onclick="incidentPage.showNarrativeHelper()">
                <span>ğŸ¤–</span>
                <span>Use Narrative Assistant</span>
              </button>
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">What action did you take?</label>
              <textarea id="actionTaken" class="textarea" rows="3" placeholder="e.g., Approached the individual, called for backup, secured the area..." onchange="incidentPage.generateReport()"></textarea>
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">How was the incident resolved?</label>
              <textarea id="resolution" class="textarea" rows="2" placeholder="e.g., Subject left property, police arrived and took over, medical transported patient..." onchange="incidentPage.generateReport()"></textarea>
            </div>
          </div>
        </div>

        <!-- Evidence and Documentation -->
        <div class="bg-tertiary rounded-lg p-4">
          <h4 class="font-semibold mb-3 text-accent">ğŸ“¸ Evidence & Documentation</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-secondary mb-1">Property Damage/Loss</label>
              <textarea id="propertyDamage" class="textarea" rows="2" placeholder="Describe any damage or stolen items..." onchange="incidentPage.generateReport()"></textarea>
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Injuries Sustained</label>
              <textarea id="injuries" class="textarea" rows="2" placeholder="Describe any injuries to persons..." onchange="incidentPage.generateReport()"></textarea>
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Evidence Collected</label>
              <input type="text" id="evidence" class="input" placeholder="e.g., CCTV footage, photos, physical items..." onchange="incidentPage.generateReport()">
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Police Report #</label>
              <input type="text" id="policeReport" class="input" placeholder="If applicable" onchange="incidentPage.generateReport()">
            </div>
          </div>
        </div>

        <!-- Officer Information -->
        <div class="bg-tertiary rounded-lg p-4">
          <h4 class="font-semibold mb-3 text-accent">ğŸ‘® Reporting Officer</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-sm text-secondary mb-1">Officer Name</label>
              <input type="text" id="officerName" class="input" placeholder="Your name" onchange="incidentPage.generateReport()">
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Badge/ID Number</label>
              <input type="text" id="badgeNumber" class="input" placeholder="Badge #" onchange="incidentPage.generateReport()">
            </div>
            <div>
              <label class="block text-sm text-secondary mb-1">Post/Assignment</label>
              <input type="text" id="post" class="input" placeholder="e.g., Main Gate, Patrol Unit 3" onchange="incidentPage.generateReport()">
            </div>
          </div>
        </div>

        <!-- Additional Notes -->
        <div class="bg-tertiary rounded-lg p-4">
          <h4 class="font-semibold mb-3 text-accent">ğŸ“ Additional Information</h4>
          <label class="block text-sm text-secondary mb-1">Other Relevant Details / Follow-up Required</label>
          <textarea id="additionalNotes" class="textarea" rows="3" placeholder="Any other important information, recommendations, or follow-up actions needed..." onchange="incidentPage.generateReport()"></textarea>
        </div>
      </div>
    </section>
  </main>

  <!-- Person Modal -->
  <div id="personModal" class="modal-overlay">
    <div class="modal-content max-w-md">
      <div class="p-6">
        <h3 class="text-xl font-bold mb-4">Add Person to Report</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm text-secondary mb-1">Role</label>
            <select id="personRole" class="input">
              <option value="victim">Victim</option>
              <option value="suspect">Suspect</option>
              <option value="witness">Witness</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">Name (will be anonymized)</label>
            <input type="text" id="personName" class="input" placeholder="John Doe">
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">Description (age, gender, build)</label>
            <input type="text" id="personDescription" class="input" placeholder="Male, 30s, medium build">
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">Clothing</label>
            <input type="text" id="personClothing" class="input" placeholder="Black shirt, blue jeans">
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">ID/License (if obtained)</label>
            <input type="text" id="personId" class="input" placeholder="DL# or other ID">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mt-6">
          <button class="btn" onclick="incidentPage.closePersonModal()">Cancel</button>
          <button class="btn btn-primary" onclick="incidentPage.savePerson()">Add Person</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Narrative Helper Modal -->
  <div id="narrativeModal" class="modal-overlay">
    <div class="modal-content max-w-lg">
      <div class="p-6">
        <h3 class="text-xl font-bold mb-4">ğŸ¤– Narrative Assistant</h3>
        <p class="text-secondary mb-4">Answer these questions to build your narrative:</p>
        <div class="space-y-3">
          <div>
            <label class="block text-sm text-secondary mb-1">What were you doing when the incident occurred?</label>
            <input type="text" id="narrativeActivity" class="input" placeholder="e.g., Conducting routine patrol">
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">What first caught your attention?</label>
            <input type="text" id="narrativeAttention" class="input" placeholder="e.g., Heard loud shouting">
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">What did you observe?</label>
            <textarea id="narrativeObservation" class="textarea" rows="3" placeholder="Describe what you saw..."></textarea>
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">What was the subject doing?</label>
            <textarea id="narrativeSubjectAction" class="textarea" rows="2" placeholder="Describe subject's actions..."></textarea>
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">What did you say or do?</label>
            <textarea id="narrativeOfficerAction" class="textarea" rows="2" placeholder="Describe your response..."></textarea>
          </div>
          <div>
            <label class="block text-sm text-secondary mb-1">How did the subject respond?</label>
            <textarea id="narrativeSubjectResponse" class="textarea" rows="2" placeholder="Describe subject's response..."></textarea>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mt-6">
          <button class="btn" onclick="incidentPage.closeNarrativeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="incidentPage.applyNarrative()">Build Narrative</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-grid">
      <a href="index.html" class="nav-item">
        <div class="nav-icon">ğŸ </div>
        <span>Home</span>
      </a>
      <a href="codes.html" class="nav-item">
        <div class="nav-icon">ğŸ“Ÿ</div>
        <span>Codes</span>
      </a>
      <a href="incident.html" class="nav-item active">
        <div class="nav-icon">ğŸ“</div>
        <span>Report</span>
      </a>
      <a href="patrol.html" class="nav-item">
        <div class="nav-icon">ğŸš¶</div>
        <span>Patrol</span>
      </a>
      <a href="profile.html" class="nav-item">
        <div class="nav-icon">ğŸ‘¤</div>
        <span>Profile</span>
      </a>
    </div>
  </nav>

  <!-- Scripts -->
  <script src="app.js"></script>
  <script>
    class IncidentPage {
      constructor() {
        this.peopleList = [];
        this.currentReport = '';
        this.init();
      }

      init() {
        this.setDefaultDateTime();
        this.loadProfile();
        this.generateReport();
      }

      setDefaultDateTime() {
        const now = new Date();
        const localDateTime = now.toISOString().slice(0, 16);
        document.getElementById('incidentDateTime').value = localDateTime;
        document.getElementById('reportDateTime').value = localDateTime;
      }

      loadProfile() {
        const profile = app.profile.getProfile();
        if (profile.name) document.getElementById('officerName').value = profile.name;
        if (profile.badge) document.getElementById('badgeNumber').value = profile.badge;
        if (profile.post) document.getElementById('post').value = profile.post;
      }

      addPerson(role) {
        const person = {
          id: Utils.generateId(),
          role: role,
          name: '',
          description: '',
          clothing: '',
          identification: ''
        };
        this.peopleList.push(person);
        this.renderPeople();
        this.generateReport();
      }

      showAddPersonModal() {
        app.modalManager.open('personModal');
      }

      closePersonModal() {
        app.modalManager.close('personModal');
        document.getElementById('personName').value = '';
        document.getElementById('personDescription').value = '';
        document.getElementById('personClothing').value = '';
        document.getElementById('personId').value = '';
      }

      savePerson() {
        const person = {
          id: Utils.generateId(),
          role: document.getElementById('personRole').value,
          name: document.getElementById('personName').value,
          description: document.getElementById('personDescription').value,
          clothing: document.getElementById('personClothing').value,
          identification: document.getElementById('personId').value
        };
        this.peopleList.push(person);
        this.renderPeople();
        this.generateReport();
        this.closePersonModal();
      }

      removePerson(id) {
        this.peopleList = this.peopleList.filter(p => p.id !== id);
        this.renderPeople();
        this.generateReport();
      }

      updatePerson(id, field, value) {
        const person = this.peopleList.find(p => p.id === id);
        if (person) {
          person[field] = value;
          this.generateReport();
        }
      }

      renderPeople() {
        const container = document.getElementById('peopleContainer');
        
        if (this.peopleList.length === 0) {
          container.innerHTML = '<div class="text-sm text-muted text-center py-4">No people added yet. Use buttons below to add involved parties.</div>';
          return;
        }

        const roleColors = {
          'victim': 'bg-error',
          'suspect': 'bg-warning',
          'witness': 'bg-info',
          'other': 'bg-secondary'
        };

        container.innerHTML = this.peopleList.map(person => {
          const roleIndex = this.peopleList.filter(p => p.role === person.role).indexOf(person) + 1;
          const anonymizedName = `${person.role.charAt(0).toUpperCase() + person.role.slice(1)}${roleIndex}`;
          
          return `
            <div class="p-3 rounded-lg border border-primary" style="background: var(--bg-quaternary);">
              <div class="flex justify-between items-center mb-2">
                <span class="badge badge-${person.role === 'victim' ? 'error' : person.role === 'suspect' ? 'warning' : 'info'}">
                  ${anonymizedName}
                </span>
                <button onclick="incidentPage.removePerson('${person.id}')" class="text-error hover:text-red-400 text-sm">Remove</button>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <input type="text" placeholder="Real name (will be anonymized)" value="${person.name}" 
                       onchange="incidentPage.updatePerson('${person.id}', 'name', this.value)"
                       class="input text-sm">
                <input type="text" placeholder="Description (age, gender, build)" value="${person.description}"
                       onchange="incidentPage.updatePerson('${person.id}', 'description', this.value)"
                       class="input text-sm">
                <input type="text" placeholder="Clothing description" value="${person.clothing}"
                       onchange="incidentPage.updatePerson('${person.id}', 'clothing', this.value)"
                       class="input text-sm">
                <input type="text" placeholder="ID/License (if obtained)" value="${person.identification}"
                       onchange="incidentPage.updatePerson('${person.id}', 'identification', this.value)"
                       class="input text-sm">
              </div>
            </div>
          `;
        }).join('');
      }

      showNarrativeHelper() {
        app.modalManager.open('narrativeModal');
      }

      closeNarrativeModal() {
        app.modalManager.close('narrativeModal');
      }

      applyNarrative() {
        const activity = document.getElementById('narrativeActivity').value;
        const attention = document.getElementById('narrativeAttention').value;
        const observation = document.getElementById('narrativeObservation').value;
        const subjectAction = document.getElementById('narrativeSubjectAction').value;
        const officerAction = document.getElementById('narrativeOfficerAction').value;
        const subjectResponse = document.getElementById('narrativeSubjectResponse').value;

        let narrative = '';
        if (activity) narrative += `While ${activity.toLowerCase()}, `;
        if (attention) narrative += `I ${attention.toLowerCase()}. `;
        if (observation) narrative += `Upon investigation, I observed ${observation.toLowerCase()}. `;
        if (subjectAction) narrative += `The subject was ${subjectAction.toLowerCase()}. `;
        if (officerAction) narrative += `I ${officerAction.toLowerCase()}. `;
        if (subjectResponse) narrative += `The subject ${subjectResponse.toLowerCase()}.`;

        document.getElementById('incidentDescription').value = narrative;
        this.generateReport();
        this.closeNarrativeModal();
      }

      collectFormData() {
        return {
          incidentDateTime: document.getElementById('incidentDateTime').value,
          reportDateTime: document.getElementById('reportDateTime').value,
          location: document.getElementById('location').value,
          specificLocation: document.getElementById('specificLocation').value,
          type: document.getElementById('incidentType').value,
          severity: document.getElementById('severity').value,
          initialContact: document.getElementById('initialContact').value,
          incidentDescription: document.getElementById('incidentDescription').value,
          actionTaken: document.getElementById('actionTaken').value,
          resolution: document.getElementById('resolution').value,
          propertyDamage: document.getElementById('propertyDamage').value,
          injuries: document.getElementById('injuries').value,
          evidence: document.getElementById('evidence').value,
          policeReport: document.getElementById('policeReport').value,
          officerName: document.getElementById('officerName').value,
          badgeNumber: document.getElementById('badgeNumber').value,
          post: document.getElementById('post').value,
          additionalNotes: document.getElementById('additionalNotes').value,
          people: this.peopleList
        };
      }

      generateReport() {
        const data = this.collectFormData();
        
        // Check if minimum required fields are filled
        if (!data.incidentDateTime || !data.location || !data.type || !data.incidentDescription || !data.officerName) {
          document.getElementById('reportStatus').textContent = 'Fill in required fields to generate report';
          document.getElementById('reportStatus').className = 'text-sm text-warning mt-1';
          return;
        }

        try {
          this.currentReport = app.reportGenerator.generateReport('incident', data);
          document.getElementById('reportNarrative').textContent = this.currentReport;
          document.getElementById('reportStatus').textContent = 'âœ… Report generated successfully';
          document.getElementById('reportStatus').className = 'text-sm text-success mt-1';
        } catch (error) {
          console.error('Report generation error:', error);
          document.getElementById('reportStatus').textContent = 'âŒ Error generating report';
          document.getElementById('reportStatus').className = 'text-sm text-error mt-1';
        }
      }

      saveDraft() {
        const data = this.collectFormData();
        StorageManager.save('incidentDraft', data);
        Utils.showToast('Draft saved successfully!', 'success');
      }

      loadDraft() {
        const draft = StorageManager.load('incidentDraft', null);
        if (!draft) {
          Utils.showToast('No draft found', 'warning');
          return;
        }

        // Load form fields
        Object.keys(draft).forEach(key => {
          if (key !== 'people') {
            const element = document.getElementById(key);
            if (element) element.value = draft[key] || '';
          }
        });

        // Load people
        this.peopleList = draft.people || [];
        this.renderPeople();
        this.generateReport();
        
        Utils.showToast('Draft loaded successfully!', 'success');
      }

      saveReport() {
        const data = this.collectFormData();
        
        if (!this.currentReport) {
          Utils.showToast('Please complete the report before saving', 'warning');
          return;
        }

        const report = {
          id: 'INC-' + Date.now(),
          timestamp: new Date().toISOString(),
          data: data,
          narrative: this.currentReport
        };

        const reports = StorageManager.load(APP_CONFIG.storageKeys.incidents, []);
        reports.unshift(report);
        StorageManager.save(APP_CONFIG.storageKeys.incidents, reports);

        // Add to activity
        const activity = {
          id: Utils.generateId(),
          title: `Incident Report: ${data.type}`,
          timestamp: report.timestamp,
          status: 'online'
        };
        
        const activities = StorageManager.load('recentActivity', []);
        activities.unshift(activity);
        StorageManager.save('recentActivity', activities.slice(0, 50));

        Utils.showToast('Report saved successfully!', 'success');
      }

      async copyReport() {
        if (!this.currentReport) {
          Utils.showToast('No report to copy', 'warning');
          return;
        }

        const success = await Utils.copyToClipboard(this.currentReport);
        Utils.showToast(success ? 'Report copied to clipboard!' : 'Copy failed', success ? 'success' : 'error');
      }
    }

    // Initialize page
    const incidentPage = new IncidentPage();
  </script>
</body>
</html>