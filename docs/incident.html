<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Incident Report — Signature Security Specialist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#0f0f0f; --card:#121212; --muted:#bfc0b0; --accent:#aeae5a; --accent-2:#5c6249; --glass:rgba(255,255,255,0.04); }
    html,body{ background:#0f0f0f url('patch-bg.png') center center / 300px no-repeat; color:#fff; height:100%; margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; display:flex; flex-direction:column; }
    .app-card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,0.04); border-radius:12px; padding:1rem; }
    #bottomNav{ position:fixed; left:0; right:0; bottom:0; width:100%; height:var(--bottom-nav-height,56px); display:flex; justify-content:space-around; align-items:center; gap:.25rem; background:rgba(17,17,17,0.9); backdrop-filter:saturate(180%) blur(10px); border-top:1px solid rgba(255,255,255,0.06); z-index:60; padding:0 .5rem calc(env(safe-area-inset-bottom,0px)); }
    #bottomNav a{ flex:1 1 0; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nav-link{ border-radius:10px; padding:.5rem .75rem; transition:background 160ms ease; }
    .nav-link[aria-current="page"]{ background:rgba(255,255,255,0.08); }
    #mainContent{ padding-bottom: calc(var(--bottom-nav-height,56px) + env(safe-area-inset-bottom,0px) + 12px); }
    .accent{ color:var(--accent); }
    @media print{
      html,body{ background:#fff !important; color:#000 !important; }
      header,#bottomNav{ display:none !important; }
      #mainContent{ padding:0 !important; }
      #formControls,#statusLine,.controls-bar{ display:none !important; }
      #templatePreview{ border:0 !important; padding:0 !important; color:#000 !important; font-size:12pt; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; }
    }
  </style>
</head>
<body>
  <header class="p-4 pb-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-extrabold">Signature Security Specialist</h1>
      <p class="text-sm text-gray-400">Incident Report — fill, preview, copy</p>
    </div>
    <div class="flex space-x-2">
      <button onclick="toggleLarge()" class="bg-[#111] px-3 py-2 rounded-md border border-white/10">A+</button>
    </div>
  </header>

  <main id="mainContent" class="flex-1 overflow-auto p-5">
    <section class="max-w-6xl mx-auto space-y-4">
      <!-- TOP HALF: Report Display and Controls -->
      <div class="app-card">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-white">📝 Generated Incident Report</h2>
          <div class="flex flex-wrap gap-2">
            <button id="btnImportIncident" class="px-3 py-2 rounded-md bg-[#2a2a2a] border border-white/20 hover:bg-[#333] transition-colors">📥 Import Latest</button>
            <button id="btnSaveDraft" class="px-3 py-2 rounded-md bg-[#2a2a2a] border border-white/20 hover:bg-[#333] transition-colors">💾 Save Draft</button>
            <button id="btnLoadDraft" class="px-3 py-2 rounded-md bg-[#2a2a2a] border border-white/20 hover:bg-[#333] transition-colors">📂 Load Draft</button>
            <button id="btnClear" class="px-3 py-2 rounded-md bg-[#2a2a2a] border border-white/20 hover:bg-[#333] transition-colors">🗑️ Clear</button>
            <button id="btnSaveReport" class="px-3 py-2 rounded-md bg-green-700 border border-green-600 hover:bg-green-600 transition-colors text-white font-semibold">💾 Save Report</button>
            <button id="btnCopy" class="px-3 py-2 rounded-md bg-blue-700 border border-blue-600 hover:bg-blue-600 transition-colors text-white font-semibold">📋 Copy Report</button>
          </div>
        </div>
        <div id="statusLine" class="text-sm text-gray-400 mb-3"></div>
        <div class="bg-[#0a0a0a] border border-white/10 rounded-lg p-4 max-h-96 overflow-y-auto">
          <pre id="templatePreview" class="whitespace-pre-wrap text-sm text-gray-200 font-mono leading-relaxed" style="direction: ltr; text-align: left;"></pre>
        </div>
      </div>

      <!-- BOTTOM HALF: Input Forms -->
      <div class="app-card">
        <h2 class="text-xl font-bold text-white mb-4">📋 Fill Out Incident Details</h2>
        <div class="text-sm text-gray-400 mb-4">Complete the fields below and the system will automatically generate a professional incident report above.</div>
        <div id="formControls" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </section>
  </main>

  <nav id="bottomNav">
    <a href="index.html" class="nav-link">Home</a>
    <a href="codes.html" class="nav-link">Codes</a>
    <a href="radio.html" class="nav-link">Phonetics</a>
    <a href="incident.html" class="nav-link" aria-current="page">Incident</a>
    <a href="shift.html" class="nav-link">Shift</a>
    <a href="reports.html" class="nav-link">Reports</a>
  </nav>

  <script>
    function toggleLarge(){ document.body.classList.toggle('text-lg'); localStorage.setItem('sss_large', document.body.classList.contains('text-lg')); }
    document.addEventListener('DOMContentLoaded',()=>{ if(localStorage.getItem('sss_large')==='true') document.body.classList.add('text-lg'); });
    // Fixed bottom nav; no scroll toggling required

    const STORE_KEYS = { profile:'sss_profile', incidents:'sss_incidents', templateDrafts:'sss_template_drafts', savedIncidentReports:'sss_saved_incident_reports' };
    function loadJson(key,fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; } }
    function saveJson(key,value){ localStorage.setItem(key, JSON.stringify(value)); }

    const fieldsContainer = document.getElementById('formControls');
    const previewEl = document.getElementById('templatePreview');
    const statusEl = document.getElementById('statusLine');
    const btnImport = document.getElementById('btnImportIncident');
    const btnSave = document.getElementById('btnSaveDraft');
    const btnLoad = document.getElementById('btnLoadDraft');
    const btnClear = document.getElementById('btnClear');
    const btnCopy = document.getElementById('btnCopy');
    const btnSaveReport = document.getElementById('btnSaveReport');

    const TEMPLATE = {
      id: 'incident_report',
      name: 'Incident Report',
      fields: [
        { key:'dateTime', label:'📅 Date / Time of Incident', type:'datetime-local' },
        { key:'guardName', label:'👮 Reporting Officer Name', type:'text' },
        { key:'post', label:'🏢 Assigned Post / Location', type:'text' },
        { key:'location', label:'📍 Incident Location (Address/Building)', type:'text' },
        { key:'locationDetails', label:'🗺️ Specific Location Details (Room, Floor, etc.)', type:'text' },
        { key:'incidentType', label:'⚠️ Type of Incident', type:'select', options:['Trespass','Disturbance','Theft','Assault','Medical Emergency','Property Damage','Suspicious Activity','Alarm Response','Vehicle Incident','Fire/Safety','Other'] },
        { key:'participants', label:'👥 People Involved', type:'participants', roles:['Suspect','Victim','Witness','Complainant'] },
        { key:'what', label:'📝 What Happened (Narrative)', type:'textarea', rows:6, placeholder:'Describe what happened in chronological order. Be objective and factual. Use tokens like suspect1, victim1, witness1 which will be anonymized in the final report. Example: "At approximately 14:30, suspect1 was observed entering the restricted area without authorization. When approached by security, suspect1 became verbally aggressive..."' },
        { key:'howDiscovered', label:'🔍 How Was Incident Discovered?', type:'select', options:['Direct Observation','Alarm Activation','Radio Call','Phone Call','Patrol Check','Reported by Staff','Reported by Public','Video Surveillance','Other'] },
        { key:'details', label:'🎯 Actions Taken by Officer', type:'textarea', rows:4, placeholder:'Detail all actions you took: notifications made, people contacted, areas secured, evidence preserved, etc.' },
        { key:'injuries', label:'🏥 Injuries / Medical Attention', type:'textarea', rows:3, placeholder:'Describe any injuries sustained and medical attention provided. If none, state "No injuries reported."' },
        { key:'propertyDamage', label:'💰 Property Damage', type:'textarea', rows:2, placeholder:'Describe any property damage. Include estimated costs if known. If none, state "No property damage observed."' },
        { key:'evidence', label:'📸 Evidence / Property Involved', type:'textarea', rows:3, placeholder:'List evidence collected, photos taken, property involved, etc.' },
        { key:'witnesses', label:'👁️ Additional Witness Information', type:'textarea', rows:2, placeholder:'Any additional witness details not captured above' },
        { key:'notifications', label:'📞 Notifications Made', type:'textarea', rows:3, placeholder:'List who was notified: supervisor, police, EMS, client, etc. Include times if known.' },
        { key:'followUp', label:'📋 Follow-up Required', type:'select', options:['None Required','Police Report Filed','Supervisor Review','Client Notification','Investigation Pending','Court Appearance','Other'] },
        { key:'reportingParty', label:'📱 Reporting Party (if different from officer)', type:'text' },
        { key:'weatherConditions', label:'🌤️ Weather/Environmental Conditions', type:'text', placeholder:'e.g., Clear, Rainy, Dark, Well-lit, etc.' }
      ],
      body: (
        '=== SECURITY INCIDENT REPORT ===\n\n' +
        'REPORT NUMBER: [To be assigned]\n' +
        'INCIDENT DATE/TIME: {when}\n' +
        'REPORT FILED: {currentDateTime}\n' +
        'REPORTING OFFICER: {guardName}\n' +
        'ASSIGNED POST: {post}\n' +
        'INCIDENT CLASSIFICATION: {incidentType}\n' +
        'WEATHER CONDITIONS: {weatherConditions}\n\n' +
        '--- INCIDENT LOCATION ---\n' +
        'PRIMARY LOCATION: {location}\n' +
        'SPECIFIC DETAILS: {locationDetails}\n\n' +
        '--- INCIDENT DISCOVERY ---\n' +
        'DISCOVERED BY: {howDiscovered}\n\n' +
        '--- PARTIES INVOLVED ---\n' +
        '{whoSection}\n\n' +
        '--- DETAILED NARRATIVE ---\n' +
        'On {when}, while assigned to {post}, I {howDiscovered} a {incidentType} incident at {location}.\n\n' +
        'CHRONOLOGICAL SEQUENCE OF EVENTS:\n' +
        '{whatExpanded}\n\n' +
        '--- OFFICER ACTIONS TAKEN ---\n' +
        '{detailsExpanded}\n\n' +
        '--- NOTIFICATIONS MADE ---\n' +
        '{notifications}\n\n' +
        '--- INJURIES/MEDICAL ATTENTION ---\n' +
        '{injuries}\n\n' +
        '--- PROPERTY DAMAGE ASSESSMENT ---\n' +
        '{propertyDamage}\n\n' +
        '--- EVIDENCE/PROPERTY INVOLVED ---\n' +
        '{evidence}\n\n' +
        '--- WITNESS INFORMATION ---\n' +
        '{witnesses}\n\n' +
        '--- REPORTING PARTY ---\n' +
        'Initial Reporter: {reportingParty}\n\n' +
        '--- CASE STATUS ---\n' +
        'Follow-up Required: {followUp}\n' +
        'Case Status: Open - Under Review\n' +
        'Supervisor Review Required: Yes\n\n' +
        '--- OFFICER CERTIFICATION ---\n' +
        'I certify that the information contained in this report is true and accurate to the best of my knowledge and belief.\n\n' +
        'Reporting Officer: {guardName}\n' +
        'Badge/Employee ID: [To be filled]\n' +
        'Officer Signature: ________________________\n' +
        'Date Signed: _______________\n\n' +
        '--- SUPERVISOR REVIEW ---\n' +
        'Reviewed By: ________________________\n' +
        'Supervisor Signature: ________________________\n' +
        'Date Reviewed: _______________\n' +
        'Comments: ________________________\n\n' +
        'END OF REPORT'
      )
    };

    let fieldValues = {};

    function toDisplay(value){ return (value==null || String(value).trim()==='') ? 'N/A' : String(value); }
    function ensureArray(v){ return Array.isArray(v) ? v : []; }
    function normalizeRole(role){
      const r = String(role||'').toLowerCase();
      if (r.startsWith('sus')) return 'suspect';
      if (r.startsWith('vic')) return 'victim';
      if (r.startsWith('wit')) return 'witness';
      if (r.startsWith('comp')) return 'complainant';
      if (r.startsWith('subj')) return 'suspect';
      return r || 'other';
    }
      function groupParticipants(list){
        const groups = { suspect: [], victim: [], witness: [], complainant: [], other: [] };
        ensureArray(list).forEach(p => {
          const name = (p && p.name) ? String(p.name).trim() : '';
          const role = normalizeRole(p && p.role);
          groups[role] = groups[role] || [];
          groups[role].push(name);
        });
        Object.keys(groups).forEach(k => { groups[k] = groups[k].filter(Boolean); });
        return groups;
      }
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
      function buildTokenMap(groups){
        const map = {};
        const add = (base, names) => { names.forEach((nm, idx) => { if (!nm) return; map[base + String(idx+1)] = base.charAt(0).toUpperCase() + base.slice(1) + String(idx+1); }); };
        add('suspect', groups.suspect||[]);
        add('subject', groups.suspect||[]);
        add('victim', groups.victim||[]);
        add('witness', groups.witness||[]);
        add('complainant', groups.complainant||[]);
        return map;
      }
    function expandTokens(text, tokenMap){
      const keys = Object.keys(tokenMap);
      if (!text || keys.length === 0) return text || '';
      const pattern = new RegExp('\\b(' + keys.map(escapeRegExp).join('|') + ')\\b', 'gi');
      return text.replace(pattern, (m) => tokenMap[m.toLowerCase()] || m);
    }
      function buildWhoSection(groups){
        const lines = [];
        const pushLines = (label, arr) => { arr.forEach((nm, i) => { lines.push(`- ${label} ${i+1}: ${label}${i+1}`); }); };
        if ((groups.suspect||[]).length) pushLines('Suspect', groups.suspect);
        if ((groups.victim||[]).length) pushLines('Victim', groups.victim);
        if ((groups.witness||[]).length) pushLines('Witness', groups.witness);
        if ((groups.complainant||[]).length) pushLines('Complainant', groups.complainant);
        return lines.length ? lines.join('\n') : 'N/A';
      }
    function insertAtCursor(textarea, text){
      if(!textarea) return;
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const before = textarea.value.slice(0, start);
      const after = textarea.value.slice(end);
      textarea.value = before + text + after;
      const pos = start + text.length;
      textarea.selectionStart = textarea.selectionEnd = pos;
      textarea.focus();
    }
    function insertTokenIntoNarrative(token){
      const ta = document.querySelector('textarea[data-key="what"]');
      const toInsert = (token || '').trim();
      if(!ta || !toInsert) return;
      insertAtCursor(ta, toInsert + ' ');
      ta.dispatchEvent(new Event('input', { bubbles:true }));
    }
      function compileBody(){
        const participants = ensureArray(fieldValues.participants);
        const groups = groupParticipants(participants);
        const tokenMap = buildTokenMap(groups);
        const whenText = toDisplay(fieldValues.dateTime);
        const whereText = toDisplay([fieldValues.location||'', fieldValues.locationDetails||''].filter(Boolean).join(' — '));
        const currentDateTime = new Date().toLocaleString();
        const computed = {
          whoSection: buildWhoSection(groups),
          when: whenText,
          where: whereText,
          currentDateTime: currentDateTime,
          whatExpanded: expandTokens(fieldValues.what || '', tokenMap),
          detailsExpanded: expandTokens(fieldValues.details || '', tokenMap),
          location: toDisplay(fieldValues.location),
          locationDetails: toDisplay(fieldValues.locationDetails),
          howDiscovered: toDisplay(fieldValues.howDiscovered).toLowerCase(),
          injuries: toDisplay(fieldValues.injuries),
          propertyDamage: toDisplay(fieldValues.propertyDamage),
          evidence: toDisplay(fieldValues.evidence),
          witnesses: toDisplay(fieldValues.witnesses),
          notifications: toDisplay(fieldValues.notifications),
          followUp: toDisplay(fieldValues.followUp),
          weatherConditions: toDisplay(fieldValues.weatherConditions)
        };
        return TEMPLATE.body.replace(/\{(.*?)\}/g, (_,k)=> (k in computed) ? computed[k] : toDisplay(fieldValues[k]));
      }

    function saveIncidentReport(){
      if (!isIncidentWsComplete()) { statusEl.textContent='Please complete Officer Name, Incident Type, Date/Time, Location, People Involved, and Narrative before saving.'; return; }
      const bodyText = compileBody();
      const arr = loadJson(STORE_KEYS.savedIncidentReports, []);
      const record = {
        id: 'inc_'+Date.now(),
        category: 'incident',
        templateId: TEMPLATE.id,
        at: Date.now(),
        fields: { ...fieldValues },
        meta: {
          dateTime: fieldValues.dateTime || '',
          type: fieldValues.incidentType || '',
          post: fieldValues.post || '',
          where: [fieldValues.location||'', fieldValues.locationDetails||''].filter(Boolean).join(' — ')
        },
        body: bodyText
      };
      arr.unshift(record);
      saveJson(STORE_KEYS.savedIncidentReports, arr);
      statusEl.textContent = 'Incident report saved.';
    }

    function formatDateTimeForInput(iso){ try{ if(!iso) return ''; const d=new Date(iso); if(isNaN(d.getTime())) return ''; const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }catch{return '';} }

    function createInput(field){
      const commonCls = 'w-full bg-[#111] border border-white/10 rounded-md px-3 py-2';
      let el;
      if(field.type==='textarea'){
        el=document.createElement('textarea'); el.className=commonCls; el.rows=field.rows||3; if(field.placeholder) el.placeholder=field.placeholder; el.value=fieldValues[field.key]||''; el.addEventListener('input',onChange);
      } else if(field.type==='participants'){
        const container = document.createElement('div');
        container.className = 'space-y-2';
        const roles = Array.isArray(field.roles) && field.roles.length ? field.roles : ['Suspect','Victim','Witness'];
        if (!Array.isArray(fieldValues[field.key])) fieldValues[field.key] = [];

        function renderRows(){
          container.innerHTML = '';
          const list = ensureArray(fieldValues[field.key]);
          const counters = {};
          list.forEach((p) => { const r = normalizeRole(p.role||''); counters[r] = (counters[r]||0) + 1; p._idx = counters[r]; });
          list.forEach((p, idx) => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';

            const roleSel = document.createElement('select');
            roleSel.className = 'bg-[#111] border border-white/10 rounded-md px-2 py-2';
            roles.forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; roleSel.appendChild(o); });
            roleSel.value = p.role || roles[0];

            const label = document.createElement('button');
            label.type = 'button';
            label.className = 'text-xs text-gray-400 w-24 text-left underline decoration-dotted decoration-white/20 cursor-pointer';
            label.textContent = `${roleSel.value} ${p._idx || 1}`;
            label.title = 'Tap to insert role token into Narrative';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Name';
            nameInput.className = 'flex-1 ' + commonCls;
            nameInput.value = p.name || '';

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'px-2 py-2 bg-[#111] border border-white/10 rounded-md';
            delBtn.textContent = 'Remove';

            const insertBtn = document.createElement('button');
            insertBtn.type = 'button';
            insertBtn.className = 'px-2 py-2 bg-[#111] border border-white/10 rounded-md';
            insertBtn.textContent = 'Insert to Narrative';

            roleSel.addEventListener('change', () => {
              const arr = ensureArray(fieldValues[field.key]);
              if (!arr[idx]) return; arr[idx].role = roleSel.value; renderRows(); updatePreview();
            });
            nameInput.addEventListener('input', () => {
              const arr = ensureArray(fieldValues[field.key]);
              if (!arr[idx]) return; arr[idx].name = nameInput.value; updatePreview();
            });
            delBtn.addEventListener('click', () => {
              const arr = ensureArray(fieldValues[field.key]);
              arr.splice(idx,1); fieldValues[field.key] = arr; renderRows(); updatePreview();
            });

            label.addEventListener('click', () => {
              const base = normalizeRole(roleSel.value);
              const token = `${base}${p._idx || 1}`;
              insertTokenIntoNarrative(token);
            });
            insertBtn.addEventListener('click', () => {
              const arr = ensureArray(fieldValues[field.key]);
              const current = arr[idx] || {};
              const name = String(current.name||'').trim();
              const base = normalizeRole(roleSel.value);
              const fallback = `${base}${p._idx || 1}`;
              insertTokenIntoNarrative(name || fallback);
            });

            row.appendChild(roleSel);
            row.appendChild(label);
            row.appendChild(nameInput);
            row.appendChild(delBtn);
            row.appendChild(insertBtn);
            container.appendChild(row);
          });

          const btnRow = document.createElement('div');
          btnRow.className = 'flex flex-wrap gap-2';
          roles.forEach(r => {
            const btn = document.createElement('button');
            btn.type = 'button'; btn.className = 'px-2 py-2 bg-[#111] border border-white/10 rounded-md'; btn.textContent = `Add ${r}`;
            btn.addEventListener('click', () => {
              const arr = ensureArray(fieldValues[field.key]); arr.push({ role: r, name: '' }); fieldValues[field.key] = arr; renderRows(); updatePreview();
            });
            btnRow.appendChild(btn);
          });
          const hint = document.createElement('div'); hint.className = 'text-xs text-gray-400'; hint.textContent = 'Tip: Tap role label to insert token or use Insert to add the name. Tokens expand to full names in preview/copy.';
          container.appendChild(btnRow);
          container.appendChild(hint);
        }
        renderRows();
        el = container;
      } else if(field.type==='select'){
        el=document.createElement('select'); el.className=commonCls; (field.options||[]).forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; el.appendChild(o); }); el.value=fieldValues[field.key]|| (field.options?.[0]||''); el.addEventListener('change',onChange);
      } else {
        el=document.createElement('input'); el.type=field.type||'text'; el.className=commonCls; el.value=fieldValues[field.key]||''; el.addEventListener('input',onChange);
      }
      el.dataset.key = field.key; return el;
    }

    function renderFields(){
      fieldsContainer.innerHTML='';
      TEMPLATE.fields.forEach(field=>{
        const wrap=document.createElement('label'); wrap.className='block';
        const title=document.createElement('div'); title.className='text-sm text-gray-300 mb-1'; title.textContent=field.label;
        const input=createInput(field);
        wrap.appendChild(title); wrap.appendChild(input); fieldsContainer.appendChild(wrap);
      });
      updatePreview();
    }

    function updatePreview(){ previewEl.textContent = compileBody(); }
    function onChange(e){ const key=e.target.dataset.key; if(!key) return; fieldValues[key] = (e.target.type==='checkbox') ? e.target.checked : e.target.value; updatePreview(); }

    function prefillDefaults(){
      const prof=loadJson(STORE_KEYS.profile,{});
      if('guardName' in fieldValues && !fieldValues.guardName) fieldValues.guardName = prof.name || '';
      const nowIso = new Date().toISOString();
      TEMPLATE.fields.forEach(f=>{
        if(f.type==='datetime-local' && !fieldValues[f.key]) fieldValues[f.key] = formatDateTimeForInput(nowIso);
      });
    }

    function importFromIncident(){
      const inc = (loadJson(STORE_KEYS.incidents, [])[0]) || null;
      if(!inc){ statusEl.textContent='No incident found to import.'; return; }
      const map = { dateTime: formatDateTimeForInput(inc.at), post: inc.post||'', incidentType: inc.type||'', summary: inc.desc||'' };
      Object.keys(map).forEach(k=>{ if(k in fieldValues) fieldValues[k] = map[k]; });
      statusEl.textContent='Imported latest incident.';
      renderFields();
    }

    function saveDraft(){ const drafts = loadJson(STORE_KEYS.templateDrafts, {}); drafts[TEMPLATE.id] = fieldValues; saveJson(STORE_KEYS.templateDrafts, drafts); statusEl.textContent='Draft saved.'; }
    function loadDraft(){ const drafts = loadJson(STORE_KEYS.templateDrafts, {}); fieldValues = { ...(drafts[TEMPLATE.id] || {}) }; statusEl.textContent=drafts[TEMPLATE.id]?'Draft loaded.':'No draft saved.'; renderFields(); }
    function clearFields(){ fieldValues={}; prefillDefaults(); statusEl.textContent='Cleared.'; renderFields(); }

    function isIncidentWsComplete(){
      const hasWhat = String(fieldValues.what||'').trim().length > 0;
      const hasWhen = String(fieldValues.dateTime||'').trim().length > 0;
      const hasWhere = String(fieldValues.location||'').trim().length > 0;
      const hasType = String(fieldValues.incidentType||'').trim().length > 0;
      const hasOfficer = String(fieldValues.guardName||'').trim().length > 0;
      const participants = ensureArray(fieldValues.participants);
      const hasWho = participants.some(p => (p && String(p.name||'').trim().length > 0));
      return hasWhat && hasWhen && hasWhere && hasType && hasOfficer && hasWho;
    }

    async function copyToClipboard(){
      if (!isIncidentWsComplete()) { statusEl.textContent='Please complete Officer Name, Incident Type, Date/Time, Location, People Involved, and Narrative before copying.'; return; }
      const text = compileBody();
      try{ await navigator.clipboard.writeText(text); statusEl.textContent='Report copied to clipboard successfully!'; }
      catch{
        try{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); statusEl.textContent='Copied to clipboard.'; }
        catch{ statusEl.textContent='Copy failed. Select and copy manually.'; }
      }
    }

    btnImport.addEventListener('click', importFromIncident);
    btnSave.addEventListener('click', saveDraft);
    btnLoad.addEventListener('click', loadDraft);
    btnClear.addEventListener('click', clearFields);
    btnCopy.addEventListener('click', copyToClipboard);
    btnSaveReport.addEventListener('click', saveIncidentReport);

    // init
    fieldValues = {};
    prefillDefaults();
    renderFields();
  </script>
</body>
</html>
