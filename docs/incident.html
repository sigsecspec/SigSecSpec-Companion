<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Incident Report — Security Companion</title>
  <link rel="stylesheet" href="app-styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f0f0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="push-notifications.js"></script>
  <style>
    .narrative-display { 
      background: var(--bg-tertiary); 
      border: 1px solid var(--border-primary); 
      border-radius: 12px; 
      padding: 1rem; 
      font-family: ui-monospace, 'Courier New', monospace; 
      line-height: 1.6; 
      font-size: 0.875rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .incident-type-badge { 
      display: inline-block; 
      padding: 0.25rem 0.75rem; 
      background: var(--accent-secondary); 
      color: #fff; 
      border-radius: 20px; 
      font-size: 0.875rem; 
      font-weight: 500;
    }
    .field-group { 
      background: var(--bg-tertiary); 
      border: 1px solid var(--border-primary); 
      padding: 1rem; 
      border-radius: 12px; 
      margin-bottom: 1rem;
    }
    .report-section {
      position: sticky;
      top: 1rem;
      z-index: 50;
      max-height: 50vh;
      display: flex;
      flex-direction: column;
    }
    .report-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .person-entry {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .person-entry.victim {
      border-color: rgba(239, 68, 68, 0.3);
      background: rgba(239, 68, 68, 0.05);
    }
    .person-entry.suspect {
      border-color: rgba(245, 158, 11, 0.3);
      background: rgba(245, 158, 11, 0.05);
    }
    .person-entry.witness {
      border-color: rgba(59, 130, 246, 0.3);
      background: rgba(59, 130, 246, 0.05);
    }
    .narrative-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    @media print {
      .narrative-display { 
        color: #000 !important; 
        font-size: 12pt; 
        border: 0 !important; 
        padding: 0 !important; 
        background: white !important;
      }
    }
  </style>
</head>
<body class="bg-pattern">
  <header class="app-header">
    <div class="flex items-center gap-3">
      <div class="app-logo">
        <img src="patch-bg.png" alt="Security Logo">
      </div>
      <div class="header-content">
        <h1>Incident Report</h1>
        <p>Professional report generator</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>
      <button class="touch-btn" onclick="toggleTextSize()" aria-label="Toggle text size">A+</button>
    </div>
  </header>

  <main class="main-content">
    <section class="max-w-6xl mx-auto">
      <!-- TOP HALF: Generated Report with Action Buttons -->
      <div class="mobile-card report-section mb-4">
        <div class="flex justify-between items-start mb-3 flex-wrap gap-2">
          <div class="flex-1">
            <h2 class="text-xl font-bold">📊 Generated Report & Narrative</h2>
            <div id="reportStatus" class="text-sm mt-1" style="color: var(--text-secondary)">Fill in the fields below to generate report</div>
          </div>
          <div class="report-actions">
            <button id="btnSaveDraft" class="touch-btn" title="Save as draft">💾</button>
            <button id="btnLoadDraft" class="touch-btn" title="Load draft">📂</button>
            <button id="btnExport" class="touch-btn" title="Print/Export PDF">🖨️</button>
            <button id="btnEmail" class="touch-btn" title="Email report">📧</button>
            <button id="btnSaveReport" class="touch-btn primary" title="Save to reports">✅ Save</button>
            <button id="btnCopy" class="touch-btn primary" title="Copy to clipboard">📋 Copy</button>
          </div>
        </div>
        <div class="narrative-display" style="flex: 1; overflow-y: auto; min-height: 200px;">
          <div id="incidentTypeBadge" class="mb-3 hidden">
            <span class="incident-type-badge"></span>
          </div>
          <div id="reportNarrative" style="color: var(--text-secondary)">
═══════════════════════════════════════════════════════════════════════════════
                          INCIDENT REPORT - NOT GENERATED YET
═══════════════════════════════════════════════════════════════════════════════

Please fill in the incident details below to generate a comprehensive report.
The system will automatically:
• Anonymize all names (Victim1, Suspect1, Witness1, etc.)
• Generate a detailed, professional narrative
• Format everything properly for official use

Start by filling in the basic incident information below...
          </div>
        </div>
      </div>

      <!-- BOTTOM HALF: Input Forms -->

      <div class="mobile-card">
        <div class="mb-4 pb-3" style="border-bottom: 1px solid var(--border-primary);">
          <h3 class="text-xl font-semibold">📝 Report Details - Fill in the Blanks</h3>
          <p class="text-sm mt-1" style="color: var(--text-secondary)">Complete the fields below. The system automatically generates a professional report with anonymized names (Victim1, Suspect1, Witness1, etc.)</p>
        </div>

        <div class="space-y-3">
          <!-- Basic Information -->
          <div class="field-group">
            <h4 class="font-semibold mb-3">⏰ When & Where</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Date & Time of Incident</span>
                <input type="datetime-local" id="dateTime" class="form-input mt-1">
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Report Filed Date & Time</span>
                <input type="datetime-local" id="reportDateTime" class="form-input mt-1">
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Location/Property Name</span>
                <input type="text" id="location" placeholder="e.g., ABC Shopping Mall" class="form-input mt-1">
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Specific Area/Address</span>
                <input type="text" id="specificLocation" placeholder="e.g., North Parking Lot, Level 2" class="form-input mt-1">
              </label>
            </div>
          </div>

          <!-- Incident Type -->
          <div class="field-group">
            <h4 class="font-semibold mb-3">🚨 Incident Classification</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Incident Type</span>
                <select id="incidentType" class="form-select mt-1">
                  <option value="">Select Type...</option>
                  <option value="Trespassing">Trespassing</option>
                  <option value="Theft">Theft</option>
                  <option value="Vandalism">Vandalism/Property Damage</option>
                  <option value="Assault">Assault</option>
                  <option value="Disturbance">Disturbance</option>
                  <option value="Suspicious Activity">Suspicious Activity</option>
                  <option value="Medical Emergency">Medical Emergency</option>
                  <option value="Fire/Smoke">Fire/Smoke</option>
                  <option value="Alarm Response">Alarm Response</option>
                  <option value="Vehicle Incident">Vehicle Incident</option>
                  <option value="Other">Other</option>
                </select>
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Severity Level</span>
                <select id="severity" class="form-select mt-1">
                  <option value="Low">Low - Minor Incident</option>
                  <option value="Medium">Medium - Moderate Concern</option>
                  <option value="High">High - Serious Incident</option>
                  <option value="Critical">Critical - Emergency Response</option>
                </select>
              </label>
            </div>
          </div>

          <!-- People Involved -->
          <div class="field-group">
            <h4 class="font-semibold mb-3">👥 People Involved</h4>
            <div id="peopleContainer" class="space-y-2">
              <!-- Dynamic people entries will be added here -->
            </div>
            <div class="flex gap-2 mt-3">
              <button onclick="addPerson('Victim')" class="touch-btn">+ Add Victim</button>
              <button onclick="addPerson('Suspect')" class="touch-btn">+ Add Suspect</button>
              <button onclick="addPerson('Witness')" class="touch-btn">+ Add Witness</button>
            </div>
          </div>

          <!-- Incident Details -->
          <div class="field-group">
            <h4 class="font-semibold mb-3">📋 What Happened</h4>
            <label class="block mb-3">
              <span class="text-sm" style="color: var(--text-secondary)">How did the incident begin? (Initial Contact/Discovery)</span>
              <textarea id="initialContact" rows="2" placeholder="e.g., While conducting routine patrol at 1430 hours, I observed..." class="form-textarea mt-1"></textarea>
            </label>
            <label class="block mb-3">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm" style="color: var(--text-secondary)">Describe what happened (Sequence of Events)</span>
                <button type="button" class="touch-btn" style="min-height: 32px; padding: 0.25rem 0.75rem; font-size: 0.875rem;" onclick="toggleNarrativeMode()">
                  <span id="narrativeModeIcon">📝</span> <span id="narrativeModeText">Type Freely</span>
                </button>
              </div>
              <textarea id="incidentDescription" rows="6" placeholder="Describe the incident in detail - what you saw, heard, and did..." class="form-textarea mt-1"></textarea>
              <div class="narrative-tools">
                <button type="button" class="touch-btn" onclick="insertPersonReference('Victim')">+ Insert Victim</button>
                <button type="button" class="touch-btn" onclick="insertPersonReference('Suspect')">+ Insert Suspect</button>
                <button type="button" class="touch-btn" onclick="insertPersonReference('Witness')">+ Insert Witness</button>
                <button type="button" class="touch-btn" onclick="insertPersonReference('Officer')">+ Insert Officer</button>
              </div>
            </label>
            <label class="block mb-3">
              <span class="text-sm" style="color: var(--text-secondary)">What action did you take?</span>
              <textarea id="actionTaken" rows="3" placeholder="e.g., Approached the individual, called for backup, secured the area..." class="form-textarea mt-1"></textarea>
            </label>
            <label class="block">
              <span class="text-sm" style="color: var(--text-secondary)">How was the incident resolved?</span>
              <textarea id="resolution" rows="2" placeholder="e.g., Subject left property, police arrived and took over, medical transported patient..." class="form-textarea mt-1"></textarea>
            </label>
          </div>

          <!-- Evidence and Documentation -->
          <div class="field-group">
            <h4 class="font-semibold mb-3">📸 Evidence & Documentation</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Property Damage/Loss</span>
                <textarea id="propertyDamage" rows="2" placeholder="Describe any damage or stolen items..." class="form-textarea mt-1"></textarea>
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Injuries Sustained</span>
                <textarea id="injuries" rows="2" placeholder="Describe any injuries to persons..." class="form-textarea mt-1"></textarea>
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Evidence Collected</span>
                <input type="text" id="evidence" placeholder="e.g., CCTV footage, photos, physical items..." class="form-input mt-1">
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Police Report #</span>
                <input type="text" id="policeReport" placeholder="If applicable" class="form-input mt-1">
              </label>
            </div>
          </div>

          <!-- Officer Information -->
          <div class="field-group">
            <h4 class="font-semibold mb-3">👮 Reporting Officer</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Officer Name</span>
                <input type="text" id="officerName" placeholder="Your name" class="form-input mt-1">
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Badge/ID Number</span>
                <input type="text" id="badgeNumber" placeholder="Badge #" class="form-input mt-1">
              </label>
              <label class="block">
                <span class="text-sm" style="color: var(--text-secondary)">Post/Assignment</span>
                <input type="text" id="post" placeholder="e.g., Main Gate, Patrol Unit 3" class="form-input mt-1">
              </label>
            </div>
          </div>

          <!-- Additional Notes -->
          <div class="field-group">
            <h4 class="font-semibold mb-3">📝 Additional Information</h4>
            <label class="block">
              <span class="text-sm" style="color: var(--text-secondary)">Other Relevant Details / Follow-up Required</span>
              <textarea id="additionalNotes" rows="3" placeholder="Any other important information, recommendations, or follow-up actions needed..." class="form-textarea mt-1"></textarea>
            </label>
          </div>
        </div>
      </div>
    </section>
  </main>

  <nav class="bottom-nav">
    <div class="nav-grid">
      <a href="index.html" class="nav-item"><div class="nav-icon">🏠</div><span>Home</span></a>
      <a href="codes.html" class="nav-item"><div class="nav-icon">📟</div><span>Codes</span></a>
      <div class="nav-item reports-dropdown active" onclick="toggleReportsDropdown()"><div class="nav-icon">📝</div><span>Reports</span></div>
      <a href="patrol.html" class="nav-item"><div class="nav-icon">🚶</div><span>Patrol</span></a>
      <a href="profile.html" class="nav-item"><div class="nav-icon">👤</div><span>Profile</span></a>
    </div>
  </nav>

  <div id="reportsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="mobile-card max-w-sm mx-4">
      <h3 class="text-xl font-bold mb-4">📝 Reports</h3>
      <div class="space-y-3">
        <a href="incident.html" class="touch-btn primary w-full">📝 Create Incident Report</a>
        <a href="shift.html" class="touch-btn primary w-full">📋 Create Shift Report</a>
        <a href="reports.html" class="touch-btn w-full">📑 View Saved Reports</a>
      </div>
      <button class="touch-btn w-full mt-4" onclick="closeReports()">Close</button>
    </div>
  </div>

  <script>
    // Theme and text size
    function toggleTheme(){ const cur = document.documentElement.getAttribute('data-theme'); const next = cur==='light'?'dark':'light'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('theme', next); }
    function initTheme(){ const saved = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', saved); }
    function toggleTextSize(){ document.body.classList.toggle('text-lg'); localStorage.setItem('largeText', document.body.classList.contains('text-lg')); }
    function initTextSize(){ if(localStorage.getItem('largeText')==='true') document.body.classList.add('text-lg'); }

    // Reports functions
    function toggleReportsDropdown() {
      document.getElementById('reportsModal').classList.remove('hidden');
      document.getElementById('reportsModal').classList.add('flex');
    }

    function closeReports() {
      document.getElementById('reportsModal').classList.add('hidden');
      document.getElementById('reportsModal').classList.remove('flex');
    }
    
    document.addEventListener('DOMContentLoaded',()=>{
      initTheme();
      initTextSize();
      initializeForm();
      setDefaultDateTime();
    });

    // Storage Functions
    const STORE_KEYS = { 
      profile:'sss_profile', 
      savedIncidentReports:'sss_saved_incident_reports',
      incidentDrafts:'sss_incident_drafts'
    };
    
    function loadJson(key,fallback){ 
      try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch{ return fallback; } 
    }
    
    function saveJson(key,value){ 
      localStorage.setItem(key, JSON.stringify(value)); 
    }

    // People Management
    let peopleList = [];
    
    function addPerson(role) {
      const id = Date.now();
      const person = { id, role, name: '', description: '', clothing: '', identification: '' };
      peopleList.push(person);
      renderPeople();
    }
    
    function removePerson(id) {
      peopleList = peopleList.filter(p => p.id !== id);
      renderPeople();
    }
    
    function updatePerson(id, field, value) {
      const person = peopleList.find(p => p.id === id);
      if (person) {
        person[field] = value;
        generateReport();
      }
    }
    
    function renderPeople() {
      const container = document.getElementById('peopleContainer');
      
      if (peopleList.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-sm">No people added yet. Use buttons below to add victims, suspects, or witnesses.</div>';
        generateReport();
        return;
      }
      
      container.innerHTML = peopleList.map(person => {
        const roleClasses = {
          'Victim': 'person-entry victim',
          'Suspect': 'person-entry suspect',
          'Witness': 'person-entry witness'
        };
        
        return `
          <div class="${roleClasses[person.role] || 'person-entry'}">
            <div class="flex justify-between items-center mb-3">
              <span class="font-semibold">${person.role} ${getPersonIndex(person)}</span>
              <button onclick="removePerson(${person.id})" class="touch-btn danger" style="min-height: 32px; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Remove</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input type="text" placeholder="Name (will be anonymized)" value="${person.name}" 
                     onchange="updatePerson(${person.id}, 'name', this.value)"
                     class="form-input">
              <input type="text" placeholder="Description (age, gender, build)" value="${person.description}"
                     onchange="updatePerson(${person.id}, 'description', this.value)"
                     class="form-input">
              <input type="text" placeholder="Clothing description" value="${person.clothing}"
                     onchange="updatePerson(${person.id}, 'clothing', this.value)"
                     class="form-input">
              <input type="text" placeholder="ID/License (if obtained)" value="${person.identification}"
                     onchange="updatePerson(${person.id}, 'identification', this.value)"
                     class="form-input">
            </div>
          </div>
        `;
      }).join('');
      
      generateReport();
    }
    
    function getPersonIndex(person) {
      const sameRole = peopleList.filter(p => p.role === person.role);
      return sameRole.indexOf(person) + 1;
    }

    // Report Generation
    function generateReport() {
      const data = collectFormData();
      
      if (!isFormValid(data)) {
        document.getElementById('reportNarrative').textContent = generateEmptyReport();
        document.getElementById('reportStatus').textContent = 'Fill in required fields to generate report';
        document.getElementById('reportStatus').className = 'text-sm text-yellow-400 mt-1';
        return;
      }
      
      const narrative = generateDetailedNarrative(data);
      document.getElementById('reportNarrative').textContent = narrative;
      document.getElementById('reportStatus').textContent = '✅ Report generated successfully';
      document.getElementById('reportStatus').className = 'text-sm text-green-400 mt-1';
      
      // Show incident type badge
      if (data.incidentType) {
        const badge = document.getElementById('incidentTypeBadge');
        badge.classList.remove('hidden');
        badge.querySelector('.incident-type-badge').textContent = data.incidentType.toUpperCase();
      }
    }
    
    function collectFormData() {
      return {
        dateTime: document.getElementById('dateTime').value,
        reportDateTime: document.getElementById('reportDateTime').value,
        location: document.getElementById('location').value,
        specificLocation: document.getElementById('specificLocation').value,
        incidentType: document.getElementById('incidentType').value,
        severity: document.getElementById('severity').value,
        initialContact: document.getElementById('initialContact').value,
        incidentDescription: document.getElementById('incidentDescription').value,
        actionTaken: document.getElementById('actionTaken').value,
        resolution: document.getElementById('resolution').value,
        propertyDamage: document.getElementById('propertyDamage').value,
        injuries: document.getElementById('injuries').value,
        evidence: document.getElementById('evidence').value,
        policeReport: document.getElementById('policeReport').value,
        officerName: document.getElementById('officerName').value,
        badgeNumber: document.getElementById('badgeNumber').value,
        post: document.getElementById('post').value,
        additionalNotes: document.getElementById('additionalNotes').value,
        people: peopleList
      };
    }
    
    function isFormValid(data) {
      return data.dateTime && data.location && data.incidentType && 
             data.incidentDescription && data.officerName;
    }
    
    function generateEmptyReport() {
      return `═══════════════════════════════════════════════════════════════════════════════
                          INCIDENT REPORT - INCOMPLETE
═══════════════════════════════════════════════════════════════════════════════

⚠️ Required fields missing. Please complete:
   □ Date & Time of incident
   □ Location
   □ Incident type
   □ Description of what happened
   □ Officer name

Fill in the fields below to generate a complete professional report.`;
    }
    
    function generateDetailedNarrative(data) {
      // Process people into anonymized format
      const victims = data.people.filter(p => p.role === 'Victim');
      const suspects = data.people.filter(p => p.role === 'Suspect');
      const witnesses = data.people.filter(p => p.role === 'Witness');
      
      // Format date and time
      const incidentDate = data.dateTime ? new Date(data.dateTime) : new Date();
      const reportDate = data.reportDateTime ? new Date(data.reportDateTime) : new Date();
      
      const formatDateTime = (date) => {
        const options = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        };
        return date.toLocaleString('en-US', options);
      };
      
      const formatTime = (date) => {
        return date.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit', 
          hour12: false 
        });
      };

      // Build the comprehensive narrative
      let narrative = `═══════════════════════════════════════════════════════════════════════════════
                            SECURITY INCIDENT REPORT
═══════════════════════════════════════════════════════════════════════════════

REPORT NUMBER: INC-${Date.now().toString().slice(-8)}
CLASSIFICATION: ${data.incidentType.toUpperCase()} - ${data.severity.toUpperCase()} PRIORITY

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                              INCIDENT SUMMARY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

DATE OF INCIDENT:     ${formatDateTime(incidentDate)}
DATE OF REPORT:       ${formatDateTime(reportDate)}
TIME REPORTED:        ${formatTime(reportDate)}

LOCATION:             ${data.location || 'Not specified'}
SPECIFIC AREA:        ${data.specificLocation || 'Not specified'}
POST/ASSIGNMENT:      ${data.post || 'Not specified'}

REPORTING OFFICER:    ${data.officerName}
BADGE NUMBER:         ${data.badgeNumber || 'Not specified'}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                           INVOLVED PARTIES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;

      // Add Victims
      if (victims.length > 0) {
        narrative += '\nVICTIMS:\n';
        victims.forEach((v, i) => {
          narrative += `\n  VICTIM ${i + 1}:\n`;
          narrative += `    • Description: ${v.description || 'Not provided'}\n`;
          narrative += `    • Clothing: ${v.clothing || 'Not described'}\n`;
          if (v.identification) {
            narrative += `    • ID Obtained: Yes - On file\n`;
          }
        });
      }
      
      // Add Suspects
      if (suspects.length > 0) {
        narrative += '\nSUSPECTS:\n';
        suspects.forEach((s, i) => {
          narrative += `\n  SUSPECT ${i + 1}:\n`;
          narrative += `    • Description: ${s.description || 'Not provided'}\n`;
          narrative += `    • Clothing: ${s.clothing || 'Not described'}\n`;
          if (s.identification) {
            narrative += `    • ID Obtained: Yes - On file\n`;
          }
        });
      }
      
      // Add Witnesses
      if (witnesses.length > 0) {
        narrative += '\nWITNESSES:\n';
        witnesses.forEach((w, i) => {
          narrative += `\n  WITNESS ${i + 1}:\n`;
          narrative += `    • Description: ${w.description || 'Not provided'}\n`;
          if (w.identification) {
            narrative += `    • Contact Information: On file\n`;
          }
        });
      }
      
      if (data.people.length === 0) {
        narrative += '\n  No involved parties documented.\n';
      }

      narrative += `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                           NARRATIVE OF INCIDENT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

INITIAL CONTACT:
${formatNarrativeText(data.initialContact || 'Security officer discovered/was alerted to the incident during routine duties.')}

SEQUENCE OF EVENTS:
${formatNarrativeText(data.incidentDescription, true)}

OFFICER RESPONSE & ACTIONS TAKEN:
${formatNarrativeText(data.actionTaken || 'Standard security protocols were followed.')}

INCIDENT RESOLUTION:
${formatNarrativeText(data.resolution || 'Incident was resolved without further escalation.')}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        DAMAGES, INJURIES & EVIDENCE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;

      // Add property damage section
      narrative += '\nPROPERTY DAMAGE/LOSS:\n';
      if (data.propertyDamage) {
        narrative += formatNarrativeText(data.propertyDamage) + '\n';
      } else {
        narrative += '  None reported.\n';
      }
      
      // Add injuries section
      narrative += '\nINJURIES:\n';
      if (data.injuries) {
        narrative += formatNarrativeText(data.injuries) + '\n';
      } else {
        narrative += '  No injuries reported.\n';
      }
      
      // Add evidence section
      narrative += '\nEVIDENCE COLLECTED:\n';
      if (data.evidence) {
        narrative += '  • ' + data.evidence + '\n';
      } else {
        narrative += '  None collected at scene.\n';
      }
      
      // Add police report if applicable
      if (data.policeReport) {
        narrative += `\nLAW ENFORCEMENT INVOLVEMENT:\n`;
        narrative += `  Police Report Number: ${data.policeReport}\n`;
      }

      // Add additional notes section if present
      if (data.additionalNotes) {
        narrative += `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                         ADDITIONAL INFORMATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${formatNarrativeText(data.additionalNotes)}
`;
      }

      narrative += `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                         REPORT CERTIFICATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

I certify that the information contained in this report is true and accurate to
the best of my knowledge and belief.

REPORTING OFFICER: ${data.officerName}
BADGE NUMBER: ${data.badgeNumber || 'Not specified'}
DATE/TIME: ${formatDateTime(reportDate)}

═══════════════════════════════════════════════════════════════════════════════
                           END OF REPORT
═══════════════════════════════════════════════════════════════════════════════`;

      // Replace actual names with anonymized references
      narrative = anonymizeNarrative(narrative, data.people);
      
      return narrative;
    }
    
    function formatNarrativeText(text, detailed = false) {
      if (!text) return '  No information provided.';
      
      // Clean up the text and ensure proper formatting
      let formatted = text.trim();
      
      // Add proper indentation
      formatted = formatted.split('\n').map(line => '  ' + line).join('\n');
      
      // Ensure the narrative flows properly
      if (detailed && formatted.length > 100) {
        // Add some structure to longer narratives
        formatted = formatted.replace(/\. /g, '.\n  ');
      }
      
      return formatted;
    }
    
    function anonymizeNarrative(text, people) {
      // Replace any occurrence of actual names with anonymized versions
      people.forEach((person) => {
        if (person.name && person.name.trim()) {
          const roleIndex = getPersonIndex(person);
          const anonymizedName = `${person.role}${roleIndex}`;
          
          // Create multiple variations of the name to catch different formats
          const nameVariations = [
            person.name.trim(),
            person.name.trim().toLowerCase(),
            person.name.trim().toUpperCase(),
            // Handle first name only
            person.name.trim().split(' ')[0],
            // Handle last name only
            person.name.trim().split(' ').pop()
          ].filter(Boolean);
          
          nameVariations.forEach(nameVar => {
            if (nameVar.length > 2) { // Only replace names longer than 2 characters
              const nameRegex = new RegExp(`\\b${escapeRegExp(nameVar)}\\b`, 'gi');
              text = text.replace(nameRegex, anonymizedName);
            }
          });
        }
      });
      
      // Also replace any remaining personal identifiers
      text = text.replace(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g, (match) => {
        // Check if this name is already anonymized
        if (match.match(/^(Victim|Suspect|Witness|Officer)\d+$/)) {
          return match;
        }
        // Replace with generic identifier
        return 'Individual';
      });
      
      return text;
    }
    
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Narrative mode toggle and person insertion
    let narrativeMode = false;
    function toggleNarrativeMode() {
      narrativeMode = !narrativeMode;
      const icon = document.getElementById('narrativeModeIcon');
      const text = document.getElementById('narrativeModeText');
      if (narrativeMode) {
        icon.textContent = '🔄';
        text.textContent = 'Auto-Generate';
      } else {
        icon.textContent = '📝';
        text.textContent = 'Type Freely';
      }
    }

    function insertPersonReference(role) {
      const textarea = document.getElementById('incidentDescription');
      const cursorPos = textarea.selectionStart;
      const textBefore = textarea.value.substring(0, cursorPos);
      const textAfter = textarea.value.substring(cursorPos);
      
      // Count how many of this role already exist in the people list
      const existingCount = peopleList.filter(p => p.role === role).length;
      const nextNumber = existingCount + 1;
      const reference = `[${role}${nextNumber}]`;
      
      // Insert the reference at cursor position
      textarea.value = textBefore + reference + textAfter;
      
      // Move cursor after the inserted reference
      textarea.selectionStart = textarea.selectionEnd = cursorPos + reference.length;
      textarea.focus();
      
      // Trigger auto-generation
      generateReport();
      
      // Show a helpful tip
      showStatus(`Inserted ${reference}. Add this person below in "People Involved" section.`, 'info');
    }

    // Form initialization and event handlers
    function initializeForm() {
      // Add event listeners to all form fields
      const fields = [
        'dateTime', 'reportDateTime', 'location', 'specificLocation', 
        'incidentType', 'severity', 'initialContact', 'incidentDescription',
        'actionTaken', 'resolution', 'propertyDamage', 'injuries',
        'evidence', 'policeReport', 'officerName', 'badgeNumber', 
        'post', 'additionalNotes'
      ];
      
      fields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
          element.addEventListener('input', generateReport);
          element.addEventListener('change', generateReport);
        }
      });
      
      // Load profile data if available
      const profile = loadJson(STORE_KEYS.profile, {});
      if (profile.name) {
        document.getElementById('officerName').value = profile.name;
      }
      
      // Initialize buttons
      document.getElementById('btnSaveDraft').addEventListener('click', saveDraft);
      document.getElementById('btnLoadDraft').addEventListener('click', loadDraft);
      document.getElementById('btnSaveReport').addEventListener('click', saveReport);
      document.getElementById('btnCopy').addEventListener('click', copyToClipboard);
      document.getElementById('btnExport').addEventListener('click', exportPDF);
      document.getElementById('btnEmail').addEventListener('click', emailReport);
    }
    
    function setDefaultDateTime() {
      const now = new Date();
      const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      
      document.getElementById('dateTime').value = localDateTime;
      document.getElementById('reportDateTime').value = localDateTime;
    }

    // Save/Load Functions
    function saveDraft() {
      const data = collectFormData();
      saveJson(STORE_KEYS.incidentDrafts, data);
      showStatus('Draft saved successfully!', 'success');
    }
    
    function loadDraft() {
      const draft = loadJson(STORE_KEYS.incidentDrafts, null);
      if (!draft) {
        showStatus('No draft found', 'error');
        return;
      }
      
      // Load simple fields
      Object.keys(draft).forEach(key => {
        if (key !== 'people') {
          const element = document.getElementById(key);
          if (element) {
            element.value = draft[key] || '';
          }
        }
      });
      
      // Load people
      peopleList = draft.people || [];
      renderPeople();
      
      showStatus('Draft loaded successfully!', 'success');
    }
    
    function saveReport() {
      const data = collectFormData();
      if (!isFormValid(data)) {
        showStatus('Please complete required fields before saving', 'error');
        return;
      }
      
      const reports = loadJson(STORE_KEYS.savedIncidentReports, []);
      const report = {
        id: 'inc_' + Date.now(),
        category: 'incident',
        at: Date.now(),
        fields: data,
        meta: {
          dateTime: data.dateTime,
          type: data.incidentType,
          post: data.post,
          where: data.location + ' - ' + data.specificLocation
        },
        body: document.getElementById('reportNarrative').textContent
      };
      
      reports.unshift(report);
      saveJson(STORE_KEYS.savedIncidentReports, reports);
      showStatus('Report saved successfully!', 'success');
      
      // Send notification about saved report
      if (window.securityNotifications) {
        window.securityNotifications.sendIncidentNotification(
          data.incidentType || 'Incident',
          data.location || 'Unknown location',
          data.severity || 'Medium'
        );
      }
    }
    
    async function copyToClipboard() {
      const text = document.getElementById('reportNarrative').textContent;
      try {
        await navigator.clipboard.writeText(text);
        showStatus('Report copied to clipboard!', 'success');
      } catch (err) {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showStatus('Report copied to clipboard!', 'success');
      }
    }
    
    function exportPDF() {
      window.print();
    }
    
    function emailReport() {
      const subject = 'Incident Report - ' + document.getElementById('incidentType').value;
      const body = encodeURIComponent(document.getElementById('reportNarrative').textContent);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }
    
    function showStatus(message, type) {
      const status = document.getElementById('reportStatus');
      status.textContent = message;
      status.className = type === 'success' ? 'text-sm text-green-400 mt-1' : 
                         type === 'error' ? 'text-sm text-red-400 mt-1' : 
                         'text-sm text-yellow-400 mt-1';
      
      setTimeout(() => {
        status.textContent = '';
        generateReport();
      }, 3000);
    }
  </script>
</body>
</html>