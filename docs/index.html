<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Security Companion — Professional Security Management</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Professional security management app for security guards">
  <link rel="apple-touch-icon" href="patch-bg.png">
  <link rel="icon" type="image/png" href="patch-bg.png">
</head>
<body>
  <!-- Background -->
  <div class="app-background"></div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="fixed inset-0 bg-primary z-100 flex items-center justify-center transition-opacity duration-500">
    <div class="text-center">
      <div class="w-24 h-24 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-green-600 to-green-800 p-4 animate-pulse">
        <img src="patch-bg.png" alt="Logo" class="w-full h-full object-contain">
      </div>
      <h2 class="text-xl font-bold text-primary mb-2">Security Companion</h2>
      <div class="loading-spinner mx-auto"></div>
    </div>
  </div>

  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <div class="logo-wrapper">
        <div class="logo-icon">
          <img src="patch-bg.png" alt="Security Companion">
        </div>
        <div class="logo-text">
          <div class="logo-title">Security Companion</div>
          <div class="logo-subtitle">
            <span class="status-dot online"></span>
            <span id="statusText">On Duty</span> • <span data-current-time>--:--</span>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button class="theme-toggle" onclick="app.theme.toggleTheme()" aria-label="Toggle theme">
          <span class="theme-toggle-icon moon">🌙</span>
          <span class="theme-toggle-icon sun">☀️</span>
        </button>
        <button class="btn" onclick="app.notifications.sendTestNotification()">
          <span class="text-xl">🔔</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Welcome Card -->
    <div class="card mb-4 fade-in">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h2 class="text-2xl font-bold mb-1">Welcome, <span data-officer-name>Officer</span></h2>
          <p class="text-secondary">Your professional security management companion</p>
        </div>
        <div class="badge badge-primary">
          <span data-notification-status>Notifications: OFF</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button class="btn btn-primary" onclick="app.startPatrol()">
          <span class="text-xl">🚶</span>
          <span>Start Patrol</span>
        </button>
        <button class="btn btn-success" onclick="app.checkIn()">
          <span class="text-xl">📍</span>
          <span>Check In</span>
        </button>
      </div>

      <!-- Status Cards -->
      <div class="grid grid-cols-3 gap-2">
        <div class="text-center p-3 bg-tertiary rounded-lg">
          <div class="text-2xl mb-1">📋</div>
          <div class="text-sm text-secondary">Shift Active</div>
          <div class="font-bold" id="shiftTimer">00:00</div>
        </div>
        <div class="text-center p-3 bg-tertiary rounded-lg">
          <div class="text-2xl mb-1">🚨</div>
          <div class="text-sm text-secondary">Incidents</div>
          <div class="font-bold" id="incidentCount">0</div>
        </div>
        <div class="text-center p-3 bg-tertiary rounded-lg">
          <div class="text-2xl mb-1">✅</div>
          <div class="text-sm text-secondary">Patrols</div>
          <div class="font-bold" id="patrolCount">0</div>
        </div>
      </div>
    </div>

    <!-- Core Features Grid -->
    <section class="mb-6">
      <h3 class="text-lg font-semibold mb-3 text-accent">Core Features</h3>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
        <a href="incident.html" class="card card-interactive text-center">
          <div class="text-3xl mb-2">📝</div>
          <div class="font-semibold">Incident Report</div>
          <div class="text-sm text-secondary">Create detailed reports</div>
        </a>

        <a href="shift.html" class="card card-interactive text-center">
          <div class="text-3xl mb-2">📋</div>
          <div class="font-semibold">Shift Report</div>
          <div class="text-sm text-secondary">End of shift summary</div>
        </a>

        <a href="patrol.html" class="card card-interactive text-center">
          <div class="text-3xl mb-2">🚶</div>
          <div class="font-semibold">Patrol Log</div>
          <div class="text-sm text-secondary">Track patrol routes</div>
        </a>

        <a href="codes.html" class="card card-interactive text-center">
          <div class="text-3xl mb-2">📟</div>
          <div class="font-semibold">10-Codes</div>
          <div class="text-sm text-secondary">Quick reference</div>
        </a>

        <a href="radio.html" class="card card-interactive text-center">
          <div class="text-3xl mb-2">📻</div>
          <div class="font-semibold">Phonetics</div>
          <div class="text-sm text-secondary">NATO alphabet</div>
        </a>

        <a href="reports.html" class="card card-interactive text-center">
          <div class="text-3xl mb-2">📑</div>
          <div class="font-semibold">View Reports</div>
          <div class="text-sm text-secondary">Saved documents</div>
        </a>

        <button onclick="app.toggleFlashlight()" class="card card-interactive text-center">
          <div class="text-3xl mb-2" id="flashlightIcon">🔦</div>
          <div class="font-semibold">Flashlight</div>
          <div class="text-sm text-secondary" id="flashlightStatus">Tap to activate</div>
        </button>

        <button onclick="app.openContacts()" class="card card-interactive text-center">
          <div class="text-3xl mb-2">📞</div>
          <div class="font-semibold">Emergency</div>
          <div class="text-sm text-secondary">Quick dial</div>
        </button>
      </div>
    </section>

    <!-- Recent Activity -->
    <section class="card mb-6">
      <h3 class="text-lg font-semibold mb-3">Recent Activity</h3>
      <div id="recentActivity" class="space-y-2">
        <!-- Activity items will be populated here -->
        <div class="p-3 bg-tertiary rounded-lg flex justify-between items-center">
          <div>
            <div class="font-medium">Shift Started</div>
            <div class="text-sm text-secondary">Today at <span id="shiftStartTime">--:--</span></div>
          </div>
          <div class="status-dot online"></div>
        </div>
      </div>
    </section>

    <!-- Quick Notes -->
    <section class="card">
      <h3 class="text-lg font-semibold mb-3">Quick Notes</h3>
      <textarea class="textarea mb-3" id="quickNotes" rows="3" placeholder="Add quick notes for your shift..."></textarea>
      <button class="btn btn-primary w-full" onclick="app.saveQuickNote()">
        <span class="text-xl">💾</span>
        <span>Save Note</span>
      </button>
    </section>
  </main>

  <!-- Emergency Button -->
  <button class="emergency-btn" onclick="app.triggerEmergency()" aria-label="Emergency Alert">
    <span>🚨</span>
  </button>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-grid">
      <a href="index.html" class="nav-item active">
        <div class="nav-icon">🏠</div>
        <span>Home</span>
      </a>
      <a href="codes.html" class="nav-item">
        <div class="nav-icon">📟</div>
        <span>Codes</span>
      </a>
      <a href="incident.html" class="nav-item">
        <div class="nav-icon">📝</div>
        <span>Report</span>
      </a>
      <a href="patrol.html" class="nav-item">
        <div class="nav-icon">🚶</div>
        <span>Patrol</span>
      </a>
      <a href="profile.html" class="nav-item">
        <div class="nav-icon">👤</div>
        <span>Profile</span>
      </a>
    </div>
  </nav>

  <!-- Emergency Modal -->
  <div id="emergencyModal" class="modal-overlay">
    <div class="modal-content max-w-sm">
      <div class="p-6">
        <h3 class="text-xl font-bold text-error mb-4">🚨 Emergency Alert</h3>
        <p class="text-secondary mb-6">This will send an emergency alert to dispatch and your supervisor. Continue?</p>
        <div class="grid grid-cols-2 gap-3">
          <button class="btn" onclick="app.modalManager.close('emergencyModal')">Cancel</button>
          <button class="btn btn-danger" onclick="app.confirmEmergency()">Send Alert</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contacts Modal -->
  <div id="contactsModal" class="modal-overlay">
    <div class="modal-content max-w-sm">
      <div class="p-6">
        <h3 class="text-xl font-bold mb-4">📞 Emergency Contacts</h3>
        <div class="space-y-3">
          <a href="tel:911" class="btn btn-danger w-full">
            <span class="text-xl">🚨</span>
            <span>911 Emergency</span>
          </a>
          <a href="tel:555-0123" class="btn w-full" id="supervisorContact">
            <span class="text-xl">👮</span>
            <span>Supervisor</span>
          </a>
          <a href="tel:555-0124" class="btn w-full" id="dispatchContact">
            <span class="text-xl">🏢</span>
            <span>Dispatch</span>
          </a>
          <a href="tel:555-0125" class="btn w-full" id="medicalContact">
            <span class="text-xl">🚑</span>
            <span>Medical</span>
          </a>
        </div>
        <button class="btn w-full mt-4" onclick="app.modalManager.close('contactsModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="app.js"></script>
  <script>
    // Page-specific functionality
    class HomePage {
      constructor() {
        this.shiftStartTime = null;
        this.shiftTimer = null;
        this.flashlightStream = null;
        this.init();
      }

      init() {
        this.loadDashboardData();
        this.startShiftTimer();
        this.loadRecentActivity();
        this.loadQuickNotes();
        
        // Hide loading screen
        setTimeout(() => {
          const loadingScreen = document.getElementById('loadingScreen');
          if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => loadingScreen.remove(), 500);
          }
        }, 1000);
      }

      loadDashboardData() {
        // Load counts from storage
        const incidents = StorageManager.load(APP_CONFIG.storageKeys.incidents, []);
        const patrols = StorageManager.load(APP_CONFIG.storageKeys.patrols, []);
        
        document.getElementById('incidentCount').textContent = incidents.length;
        document.getElementById('patrolCount').textContent = patrols.length;
        
        // Load shift start time
        const currentShift = StorageManager.load('currentShift', null);
        if (currentShift && currentShift.startTime) {
          this.shiftStartTime = new Date(currentShift.startTime);
          const timeStr = this.shiftStartTime.toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit'
          });
          document.getElementById('shiftStartTime').textContent = timeStr;
        } else {
          // Start new shift
          this.startNewShift();
        }
      }

      startNewShift() {
        this.shiftStartTime = new Date();
        const shift = {
          id: Utils.generateId(),
          startTime: this.shiftStartTime.toISOString(),
          officer: app.profile.getProfile().name
        };
        StorageManager.save('currentShift', shift);
        
        const timeStr = this.shiftStartTime.toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('shiftStartTime').textContent = timeStr;
      }

      startShiftTimer() {
        const updateTimer = () => {
          if (!this.shiftStartTime) return;
          
          const now = new Date();
          const diff = now - this.shiftStartTime;
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          
          const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
          document.getElementById('shiftTimer').textContent = display;
        };
        
        updateTimer();
        this.shiftTimer = setInterval(updateTimer, 60000); // Update every minute
      }

      loadRecentActivity() {
        const activities = StorageManager.load('recentActivity', []);
        const container = document.getElementById('recentActivity');
        
        if (activities.length > 0) {
          const html = activities.slice(0, 5).map(activity => `
            <div class="p-3 bg-tertiary rounded-lg flex justify-between items-center">
              <div>
                <div class="font-medium">${activity.title}</div>
                <div class="text-sm text-secondary">${Utils.formatDateTime(activity.timestamp)}</div>
              </div>
              <div class="status-dot ${activity.status || 'online'}"></div>
            </div>
          `).join('');
          
          container.innerHTML += html;
        }
      }

      loadQuickNotes() {
        const notes = StorageManager.load('quickNotes', '');
        document.getElementById('quickNotes').value = notes;
      }

      async toggleFlashlight() {
        const icon = document.getElementById('flashlightIcon');
        const status = document.getElementById('flashlightStatus');
        
        if (!this.flashlightStream) {
          try {
            this.flashlightStream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: 'environment' }
            });
            
            const track = this.flashlightStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            
            if (capabilities.torch) {
              await track.applyConstraints({
                advanced: [{ torch: true }]
              });
              icon.textContent = '💡';
              status.textContent = 'Flashlight ON';
              status.classList.add('text-success');
            } else {
              throw new Error('Torch not supported');
            }
          } catch (error) {
            // Fallback to screen flash
            document.body.style.background = 'white';
            icon.textContent = '💡';
            status.textContent = 'Screen flash ON';
            status.classList.add('text-warning');
          }
        } else {
          // Turn off
          if (this.flashlightStream) {
            const track = this.flashlightStream.getVideoTracks()[0];
            if (track) {
              await track.applyConstraints({
                advanced: [{ torch: false }]
              });
            }
            this.flashlightStream.getTracks().forEach(track => track.stop());
          }
          
          document.body.style.background = '';
          this.flashlightStream = null;
          icon.textContent = '🔦';
          status.textContent = 'Tap to activate';
          status.classList.remove('text-success', 'text-warning');
        }
      }

      saveQuickNote() {
        const notes = document.getElementById('quickNotes').value;
        StorageManager.save('quickNotes', notes);
        
        // Add to activity
        const activity = {
          id: Utils.generateId(),
          title: 'Note Added',
          timestamp: new Date().toISOString(),
          status: 'online'
        };
        
        const activities = StorageManager.load('recentActivity', []);
        activities.unshift(activity);
        StorageManager.save('recentActivity', activities.slice(0, 50));
        
        Utils.showToast('Note saved successfully!', 'success');
        this.loadRecentActivity();
      }

      async checkIn() {
        const location = await app.getCurrentLocation();
        const checkIn = {
          id: Utils.generateId(),
          timestamp: new Date().toISOString(),
          location: location,
          officer: app.profile.getProfile().name
        };
        
        const checkIns = StorageManager.load('checkIns', []);
        checkIns.push(checkIn);
        StorageManager.save('checkIns', checkIns);
        
        Utils.showToast('Check-in successful!', 'success');
        Utils.vibrate([200]);
      }

      startPatrol() {
        window.location.href = 'patrol.html';
      }

      openContacts() {
        app.modalManager.open('contactsModal');
      }
    }

    // Extend the main app with page-specific functions
    app.homePage = null;

    // Override init for home page
    const originalInit = app.initHomePage;
    app.initHomePage = function() {
      if (originalInit) originalInit.call(this);
      app.homePage = new HomePage();
      
      // Bind functions to app
      app.toggleFlashlight = app.homePage.toggleFlashlight.bind(app.homePage);
      app.saveQuickNote = app.homePage.saveQuickNote.bind(app.homePage);
      app.checkIn = app.homePage.checkIn.bind(app.homePage);
      app.startPatrol = app.homePage.startPatrol.bind(app.homePage);
      app.openContacts = app.homePage.openContacts.bind(app.homePage);
    };

    // Initialize emergency confirmation
    app.confirmEmergency = function() {
      app.modalManager.close('emergencyModal');
      
      // Trigger actual emergency
      Utils.vibrate([200, 100, 200, 100, 200]);
      
      const emergency = {
        id: Utils.generateId(),
        timestamp: new Date().toISOString(),
        officer: app.profile.getProfile().name,
        location: 'Getting location...'
      };
      
      // Get location async
      app.getCurrentLocation().then(location => {
        emergency.location = location;
        const emergencies = StorageManager.load('emergencies', []);
        emergencies.push(emergency);
        StorageManager.save('emergencies', emergencies);
      });
      
      // Send notification
      app.notifications.showLocalNotification(
        '🚨 EMERGENCY ALERT SENT',
        'Dispatch has been notified. Help is on the way.',
        { requireInteraction: true }
      );
      
      Utils.showToast('Emergency alert sent to dispatch!', 'error', 5000);
    };
  </script>
</body>
</html>