<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test End Shift Functionality</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn {
      background: #007AFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-size: 16px;
    }
    .btn:hover {
      background: #0056CC;
    }
    .btn.danger {
      background: #FF3B30;
    }
    .btn.danger:hover {
      background: #CC2E24;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .status.success {
      background: #D4F6D4;
      color: #2D7D32;
    }
    .status.error {
      background: #FFEBEE;
      color: #C62828;
    }
    .status.info {
      background: #E3F2FD;
      color: #1976D2;
    }
  </style>
</head>
<body>
  <h1>🧪 End Shift Functionality Test</h1>
  
  <div class="test-card">
    <h2>Test Scenarios</h2>
    <p>This page tests the new end shift validation functionality:</p>
    <ul>
      <li>✅ Early end attempt shows popup with time remaining</li>
      <li>✅ Different messages based on time remaining</li>
      <li>✅ Shift report requirement enforcement</li>
      <li>✅ Mission-specific shift report linking</li>
    </ul>
  </div>

  <div class="test-card">
    <h3>Test Controls</h3>
    <button class="btn" onclick="createTestMission(6)">Create Mission (6 hours remaining)</button>
    <button class="btn" onclick="createTestMission(1)">Create Mission (1 hour remaining)</button>
    <button class="btn" onclick="createTestMission(0.25)">Create Mission (15 minutes remaining)</button>
    <button class="btn" onclick="createTestMission(-1)">Create Mission (ended 1 hour ago)</button>
    <button class="btn danger" onclick="clearMission()">Clear Mission</button>
    <button class="btn" onclick="testEndShift()">Test End Shift</button>
  </div>

  <div class="test-card">
    <h3>Mission Status</h3>
    <div id="missionStatus" class="status info">No active mission</div>
  </div>

  <div class="test-card">
    <h3>Test Results</h3>
    <div id="testResults"></div>
  </div>

  <script>
    function createTestMission(hoursRemaining) {
      const now = new Date();
      const startTime = new Date(now.getTime() - 2 * 60 * 60 * 1000); // Started 2 hours ago
      const endTime = new Date(now.getTime() + hoursRemaining * 60 * 60 * 1000);
      
      const testMission = {
        id: Date.now(),
        startTime: startTime.toISOString(),
        status: 'active',
        type: 'scheduled',
        originalMission: {
          date: now.toISOString().split('T')[0],
          startTime: startTime.toTimeString().slice(0, 5),
          endTime: endTime.toTimeString().slice(0, 5),
          title: `Test Mission (${hoursRemaining > 0 ? hoursRemaining + 'h remaining' : Math.abs(hoursRemaining) + 'h overdue'})`,
          location: 'Test Location'
        }
      };
      
      localStorage.setItem('activeMission', JSON.stringify(testMission));
      updateMissionStatus();
      
      const status = hoursRemaining > 0 ? 
        `Mission created with ${hoursRemaining} hours remaining` :
        `Mission created (ended ${Math.abs(hoursRemaining)} hours ago)`;
      
      addTestResult(status, 'success');
    }

    function clearMission() {
      localStorage.removeItem('activeMission');
      updateMissionStatus();
      addTestResult('Mission cleared', 'info');
    }

    function testEndShift() {
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      
      if (!activeMission) {
        addTestResult('No active mission to test', 'error');
        return;
      }

      // Simulate the end shift validation logic
      const now = new Date();
      const missionStartTime = new Date(activeMission.startTime);
      
      let scheduledEndTime = null;
      if (activeMission.originalMission && activeMission.originalMission.endTime) {
        const missionDate = activeMission.originalMission.date;
        scheduledEndTime = new Date(missionDate + 'T' + activeMission.originalMission.endTime);
      } else {
        scheduledEndTime = new Date(missionStartTime.getTime() + 8 * 60 * 60 * 1000);
      }
      
      const timeUntilEnd = scheduledEndTime - now;
      
      if (timeUntilEnd > 0) {
        const hours = Math.floor(timeUntilEnd / (1000 * 60 * 60));
        const minutes = Math.floor((timeUntilEnd % (1000 * 60 * 60)) / (1000 * 60));
        
        let message;
        if (timeUntilEnd > 2 * 60 * 60 * 1000) {
          message = `🛑 Whoa, not so fast! ${hours}h ${minutes}m remaining`;
        } else if (timeUntilEnd > 30 * 60 * 1000) {
          message = `⏰ Hold on there! ${hours > 0 ? hours + 'h ' : ''}${minutes}m remaining`;
        } else {
          message = `⏱️ Almost there! ${minutes}m remaining`;
        }
        
        addTestResult(message, 'error');
      } else {
        // Check for shift report
        const savedShiftReports = JSON.parse(localStorage.getItem('sss_saved_shift_reports') || '[]');
        const missionShiftReport = savedShiftReports.find(report => {
          return report.meta && report.meta.missionId === activeMission.id;
        });
        
        if (!missionShiftReport) {
          addTestResult('✅ Mission time ended, but no shift report found for this mission', 'error');
        } else {
          addTestResult('✅ Mission can be ended - shift report exists', 'success');
        }
      }
    }

    function updateMissionStatus() {
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      const statusEl = document.getElementById('missionStatus');
      
      if (activeMission) {
        const startTime = new Date(activeMission.startTime);
        const endTime = activeMission.originalMission ? 
          new Date(activeMission.originalMission.date + 'T' + activeMission.originalMission.endTime) :
          new Date(startTime.getTime() + 8 * 60 * 60 * 1000);
        
        const now = new Date();
        const timeUntilEnd = endTime - now;
        const hours = Math.floor(Math.abs(timeUntilEnd) / (1000 * 60 * 60));
        const minutes = Math.floor((Math.abs(timeUntilEnd) % (1000 * 60 * 60)) / (1000 * 60));
        
        const timeText = timeUntilEnd > 0 ? 
          `${hours}h ${minutes}m remaining` : 
          `${hours}h ${minutes}m overdue`;
        
        statusEl.innerHTML = `
          <strong>Active Mission:</strong> ${activeMission.originalMission?.title || 'Test Mission'}<br>
          <strong>Started:</strong> ${startTime.toLocaleString()}<br>
          <strong>Ends:</strong> ${endTime.toLocaleString()}<br>
          <strong>Status:</strong> ${timeText}
        `;
        statusEl.className = 'status ' + (timeUntilEnd > 0 ? 'info' : 'error');
      } else {
        statusEl.textContent = 'No active mission';
        statusEl.className = 'status info';
      }
    }

    function addTestResult(message, type) {
      const resultsEl = document.getElementById('testResults');
      const timestamp = new Date().toLocaleTimeString();
      const resultDiv = document.createElement('div');
      resultDiv.className = `status ${type}`;
      resultDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      resultsEl.appendChild(resultDiv);
      resultsEl.scrollTop = resultsEl.scrollHeight;
    }

    // Initialize
    updateMissionStatus();
    addTestResult('Test page loaded. Create a mission and test end shift functionality.', 'info');
  </script>
</body>
</html>