<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile â€” Security Companion</title>
  <link rel="stylesheet" href="app-styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f0f0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="push-notifications.js"></script>
  <script src="emergency-common.js"></script>
  <script src="popup-system.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      margin: 0 auto 1rem;
    }

    .contact-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      margin-bottom: 0.75rem;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .contact-item:hover {
      border-color: var(--accent-primary);
      transform: translateY(-1px);
    }

    .contact-item:active {
      transform: scale(0.98);
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-secondary);
    }

    .setting-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body class="bg-pattern">
  <!-- Header -->
  <header class="app-header">
    <div class="flex items-center gap-3">
      <div class="app-logo">
        <img src="patch-bg.png" alt="Security Logo">
      </div>
      <div class="header-content">
        <h1>Profile & Settings</h1>
        <p>Manage your account and preferences</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>
    </div>
  </header>

  <!-- Emergency Button - Bottom Right -->
  <button class="emergency-btn-fixed" onclick="triggerEmergency()" aria-label="Emergency alert">
    ğŸš¨
  </button>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Profile Section -->
    <section class="mobile-card mb-6">
      <div class="text-center">
        <div class="avatar" id="profileAvatar">ğŸ‘¤</div>
        <h2 class="text-xl font-bold mb-2" id="profileName">Officer Name</h2>
        <p style="color: var(--text-secondary)" id="profileBadge">Badge #12345</p>
      </div>
      
      <div class="mt-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Full Name</label>
          <input type="text" id="officerName" class="form-input" placeholder="Enter your full name">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Badge Number</label>
          <input type="text" id="badgeNumber" class="form-input" placeholder="Enter badge number">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Department</label>
          <input type="text" id="department" class="form-input" placeholder="Enter department">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Shift</label>
          <select id="shiftType" class="form-input">
            <option value="">Select shift</option>
            <option value="day">Day Shift (6 AM - 6 PM)</option>
            <option value="night">Night Shift (6 PM - 6 AM)</option>
            <option value="swing">Swing Shift (2 PM - 10 PM)</option>
            <option value="rotating">Rotating</option>
          </select>
        </div>
        
        <button class="touch-btn primary w-full" onclick="saveProfile()">
          <span class="mr-2">ğŸ’¾</span> Save Profile
        </button>
      </div>
    </section>

    <!-- Emergency Contacts -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-4">ğŸ“ Emergency Contacts</h3>
      
      <a href="tel:911" class="contact-item">
        <div class="text-2xl mr-4">ğŸš¨</div>
        <div class="flex-1">
          <div class="font-semibold">Emergency Services</div>
          <div class="text-sm" style="color: var(--text-secondary)">911</div>
        </div>
        <div style="color: var(--text-muted)">â†’</div>
      </a>
      
      <a href="tel:555-0123" class="contact-item">
        <div class="text-2xl mr-4">ğŸ‘®</div>
        <div class="flex-1">
          <div class="font-semibold">Supervisor</div>
          <div class="text-sm" style="color: var(--text-secondary)" id="supervisorPhone">555-0123</div>
        </div>
        <div style="color: var(--text-muted)">â†’</div>
      </a>
      
      <a href="tel:555-0124" class="contact-item">
        <div class="text-2xl mr-4">ğŸ¢</div>
        <div class="flex-1">
          <div class="font-semibold">Dispatch Center</div>
          <div class="text-sm" style="color: var(--text-secondary)" id="dispatchPhone">555-0124</div>
        </div>
        <div style="color: var(--text-muted)">â†’</div>
      </a>
      
      <a href="tel:555-0125" class="contact-item">
        <div class="text-2xl mr-4">ğŸš‘</div>
        <div class="flex-1">
          <div class="font-semibold">Medical Emergency</div>
          <div class="text-sm" style="color: var(--text-secondary)" id="medicalPhone">555-0125</div>
        </div>
        <div style="color: var(--text-muted)">â†’</div>
      </a>
      
      <button class="touch-btn w-full mt-4" onclick="editContacts()">
        <span class="mr-2">âœï¸</span> Edit Contacts
      </button>
    </section>

    <!-- App Settings -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-4">âš™ï¸ App Settings</h3>
      
      <div class="setting-item">
        <div>
          <div class="font-medium">Dark Mode</div>
          <div class="text-sm" style="color: var(--text-secondary)">Switch between light and dark themes</div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()"></button>
      </div>
      
      <div class="setting-item">
        <div>
          <div class="font-medium">Large Text</div>
          <div class="text-sm" style="color: var(--text-secondary)">Increase text size for better readability</div>
        </div>
        <button class="touch-btn" onclick="toggleTextSize()" id="textSizeBtn">A+</button>
      </div>
      
      <div class="setting-item">
        <div>
          <div class="font-medium">Location Services</div>
          <div class="text-sm" style="color: var(--text-secondary)">Allow app to access your location</div>
        </div>
        <button class="touch-btn" onclick="requestLocation()" id="locationBtn">Enable</button>
      </div>
      
      <div class="setting-item">
        <div>
          <div class="font-medium">Notifications</div>
          <div class="text-sm" style="color: var(--text-secondary)">Receive alerts and reminders</div>
        </div>
        <button class="touch-btn" onclick="requestNotifications()" id="notificationBtn" data-notification-toggle>Enable</button>
      </div>
    </section>

    <!-- Data Management -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-4">ğŸ’¾ Data Management</h3>
      
      <div class="space-y-3">
        <button class="touch-btn w-full" onclick="exportData()">
          <span class="mr-2">ğŸ“¤</span> Export Data
        </button>
        
        <button class="touch-btn w-full" onclick="importData()">
          <span class="mr-2">ğŸ“¥</span> Import Data
        </button>
        
        <button class="touch-btn w-full" onclick="clearCache()">
          <span class="mr-2">ğŸ—‘ï¸</span> Clear Cache
        </button>
        
        <button class="touch-btn danger w-full" onclick="resetApp()">
          <span class="mr-2">âš ï¸</span> Reset All Data
        </button>
      </div>
    </section>

    <!-- App Information -->
    <section class="mobile-card">
      <h3 class="text-lg font-semibold mb-4">â„¹ï¸ App Information</h3>
      
      <div class="space-y-3 text-sm">
        <div class="flex justify-between">
          <span>Version</span>
          <span style="color: var(--text-secondary)">1.0.0</span>
        </div>
        
        <div class="flex justify-between">
          <span>Last Updated</span>
          <span style="color: var(--text-secondary)" id="lastUpdated">Today</span>
        </div>
        
        <div class="flex justify-between">
          <span>Storage Used</span>
          <span style="color: var(--text-secondary)" id="storageUsed">--</span>
        </div>
        
        <div class="flex justify-between">
          <span>Device</span>
          <span style="color: var(--text-secondary)" id="deviceInfo">--</span>
        </div>
      </div>
      
      <div class="mt-6 pt-4 border-t" style="border-color: var(--border-secondary)">
        <div class="text-center text-sm" style="color: var(--text-muted)">
          Security Companion v1.0<br>
          Built for security professionals
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-grid">
      <a href="index.html" class="nav-item">
        <div class="nav-icon">ğŸ </div>
        <span>Home</span>
      </a>
      <a href="schedule.html" class="nav-item">
        <div class="nav-icon">ğŸ“‹</div>
        <span>Schedule</span>
      </a>
      <a href="reports.html" class="nav-item">
        <div class="nav-icon">ğŸ“</div>
        <span>Reports</span>
      </a>
      <a href="patrol.html" class="nav-item">
        <div class="nav-icon">ğŸš¶</div>
        <span>Patrol</span>
      </a>
      <a href="profile.html" class="nav-item active">
        <div class="nav-icon">ğŸ‘¤</div>
        <span>Profile</span>
      </a>
    </div>
  </nav>

  <!-- Contact Edit Modal -->
  <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="mobile-card max-w-sm mx-4">
      <h3 class="text-xl font-bold mb-4">âœï¸ Edit Emergency Contacts</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Supervisor Phone</label>
          <input type="tel" id="editSupervisor" class="form-input" placeholder="555-0123">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Dispatch Phone</label>
          <input type="tel" id="editDispatch" class="form-input" placeholder="555-0124">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Medical Phone</label>
          <input type="tel" id="editMedical" class="form-input" placeholder="555-0125">
        </div>
      </div>
      
      <div class="flex gap-3 mt-6">
        <button class="touch-btn flex-1" onclick="cancelEditContacts()">Cancel</button>
        <button class="touch-btn primary flex-1" onclick="saveContacts()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Theme management
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
    }

    // Text size toggle
    function toggleTextSize() {
      document.body.classList.toggle('text-lg');
      const isLarge = document.body.classList.contains('text-lg');
      localStorage.setItem('largeText', isLarge);
      document.getElementById('textSizeBtn').textContent = isLarge ? 'A-' : 'A+';
    }

    function initTextSize() {
      if (localStorage.getItem('largeText') === 'true') {
        document.body.classList.add('text-lg');
        document.getElementById('textSizeBtn').textContent = 'A-';
      }
    }

    // Profile management
    function loadProfile() {
      const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
      
      document.getElementById('officerName').value = profile.name || '';
      document.getElementById('badgeNumber').value = profile.badge || '';
      document.getElementById('department').value = profile.department || '';
      document.getElementById('shiftType').value = profile.shift || '';
      
      // Update display
      document.getElementById('profileName').textContent = profile.name || 'Officer Name';
      document.getElementById('profileBadge').textContent = profile.badge ? `Badge #${profile.badge}` : 'Badge #12345';
      
      // Update avatar
      const avatar = document.getElementById('profileAvatar');
      if (profile.name) {
        avatar.textContent = profile.name.charAt(0).toUpperCase();
      }
    }

    function saveProfile() {
      const profile = {
        name: document.getElementById('officerName').value.trim(),
        badge: document.getElementById('badgeNumber').value.trim(),
        department: document.getElementById('department').value.trim(),
        shift: document.getElementById('shiftType').value
      };
      
      localStorage.setItem('userProfile', JSON.stringify(profile));
      localStorage.setItem('officerName', profile.name); // For other pages
      
      // Update display
      document.getElementById('profileName').textContent = profile.name || 'Officer Name';
      document.getElementById('profileBadge').textContent = profile.badge ? `Badge #${profile.badge}` : 'Badge #12345';
      
      // Update avatar
      const avatar = document.getElementById('profileAvatar');
      if (profile.name) {
        avatar.textContent = profile.name.charAt(0).toUpperCase();
      }
      
      showSuccess('Profile saved successfully!');
    }

    // Contact management
    function loadContacts() {
      const contacts = JSON.parse(localStorage.getItem('emergencyContacts') || '{}');
      
      document.getElementById('supervisorPhone').textContent = contacts.supervisor || '555-0123';
      document.getElementById('dispatchPhone').textContent = contacts.dispatch || '555-0124';
      document.getElementById('medicalPhone').textContent = contacts.medical || '555-0125';
      
      // Update links
      document.querySelector('a[href^="tel:555-0123"]').href = `tel:${contacts.supervisor || '555-0123'}`;
      document.querySelector('a[href^="tel:555-0124"]').href = `tel:${contacts.dispatch || '555-0124'}`;
      document.querySelector('a[href^="tel:555-0125"]').href = `tel:${contacts.medical || '555-0125'}`;
    }

    function editContacts() {
      const contacts = JSON.parse(localStorage.getItem('emergencyContacts') || '{}');
      
      document.getElementById('editSupervisor').value = contacts.supervisor || '';
      document.getElementById('editDispatch').value = contacts.dispatch || '';
      document.getElementById('editMedical').value = contacts.medical || '';
      
      document.getElementById('contactModal').classList.remove('hidden');
      document.getElementById('contactModal').classList.add('flex');
    }

    function cancelEditContacts() {
      document.getElementById('contactModal').classList.add('hidden');
      document.getElementById('contactModal').classList.remove('flex');
    }

    function saveContacts() {
      const contacts = {
        supervisor: document.getElementById('editSupervisor').value.trim(),
        dispatch: document.getElementById('editDispatch').value.trim(),
        medical: document.getElementById('editMedical').value.trim()
      };
      
      localStorage.setItem('emergencyContacts', JSON.stringify(contacts));
      loadContacts();
      cancelEditContacts();
      showSuccess('Emergency contacts saved!');
    }

    // Permission requests
    async function requestLocation() {
      try {
        const permission = await navigator.permissions.query({ name: 'geolocation' });
        if (permission.state === 'granted') {
          document.getElementById('locationBtn').textContent = 'Enabled';
          document.getElementById('locationBtn').classList.add('primary');
        } else {
          navigator.geolocation.getCurrentPosition(
            () => {
              document.getElementById('locationBtn').textContent = 'Enabled';
              document.getElementById('locationBtn').classList.add('primary');
            },
            () => {
              showWarning('Location access denied. Please enable in browser settings.');
            }
          );
        }
      } catch (error) {
        console.error('Location permission error:', error);
      }
    }

    async function requestNotifications() {
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          document.getElementById('notificationBtn').textContent = 'Enabled';
          document.getElementById('notificationBtn').classList.add('primary');
          new Notification('Security Companion', {
            body: 'Notifications enabled successfully!',
            icon: '/icon-192.png'
          });
        } else {
          showWarning('Notification permission denied.');
        }
      } catch (error) {
        console.error('Notification permission error:', error);
      }
    }

    // Data management
    function exportData() {
      try {
        // Get all data
        const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
        const contacts = JSON.parse(localStorage.getItem('emergencyContacts') || '{}');
        const patrols = JSON.parse(localStorage.getItem('completedPatrols') || '[]');
        const incidents = JSON.parse(localStorage.getItem('savedIncidentReports') || '[]');
        const shifts = JSON.parse(localStorage.getItem('savedShiftReports') || '[]');
        const settings = {
          theme: localStorage.getItem('theme') || 'dark',
          largeText: localStorage.getItem('largeText') || 'false'
        };
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // PDF styling
        const primaryColor = [15, 15, 15]; // Dark theme primary
        const accentColor = [0, 122, 255]; // Blue accent
        const textColor = [51, 51, 51]; // Dark text
        const lightGray = [128, 128, 128]; // Light gray for secondary text
        
        let yPosition = 20;
        const leftMargin = 20;
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        
        // Helper function to add new page if needed
        function checkPageBreak(requiredSpace = 20) {
          if (yPosition + requiredSpace > pageHeight - 20) {
            doc.addPage();
            yPosition = 20;
          }
        }
        
        // Helper function to add section header
        function addSectionHeader(title, icon = '') {
          checkPageBreak(30);
          doc.setFontSize(16);
          doc.setTextColor(...accentColor);
          doc.setFont('helvetica', 'bold');
          doc.text(`${icon} ${title}`, leftMargin, yPosition);
          yPosition += 15;
          
          // Add underline
          doc.setDrawColor(...accentColor);
          doc.setLineWidth(0.5);
          doc.line(leftMargin, yPosition - 5, pageWidth - 20, yPosition - 5);
          yPosition += 10;
        }
        
        // Helper function to add field
        function addField(label, value, isSubItem = false) {
          checkPageBreak();
          const indent = isSubItem ? leftMargin + 10 : leftMargin;
          
          doc.setFontSize(10);
          doc.setTextColor(...textColor);
          doc.setFont('helvetica', 'bold');
          doc.text(`${label}:`, indent, yPosition);
          
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...lightGray);
          const labelWidth = doc.getTextWidth(`${label}: `);
          doc.text(value || 'Not specified', indent + labelWidth, yPosition);
          yPosition += 12;
        }
        
        // Header
        doc.setFontSize(20);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Security Companion - Profile Data Export', leftMargin, yPosition);
        yPosition += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(...lightGray);
        doc.setFont('helvetica', 'normal');
        doc.text(`Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, leftMargin, yPosition);
        yPosition += 20;
        
        // Profile Section
        addSectionHeader('Profile Information', 'ğŸ‘¤');
        addField('Full Name', profile.name || 'Officer Name');
        addField('Badge Number', profile.badge || '#12345');
        addField('Department', profile.department || 'Not specified');
        
        // Format shift display
        let shiftDisplay = 'Not specified';
        if (profile.shift) {
          const shiftMap = {
            'day': 'Day Shift (6 AM - 6 PM)',
            'night': 'Night Shift (6 PM - 6 AM)',
            'swing': 'Swing Shift (2 PM - 10 PM)',
            'rotating': 'Rotating'
          };
          shiftDisplay = shiftMap[profile.shift] || profile.shift;
        }
        addField('Shift', shiftDisplay);
        yPosition += 10;
        
        // Emergency Contacts Section
        addSectionHeader('Emergency Contacts', 'ğŸ“');
        addField('Emergency Services', '911');
        addField('Supervisor', contacts.supervisor || '555-0123');
        addField('Dispatch Center', contacts.dispatch || '555-0124');
        addField('Medical Emergency', contacts.medical || '555-0125');
        yPosition += 10;
        
        // App Settings Section
        addSectionHeader('App Settings', 'âš™ï¸');
        addField('Theme', settings.theme === 'light' ? 'Light Mode' : 'Dark Mode');
        addField('Large Text', settings.largeText === 'true' ? 'Enabled' : 'Disabled');
        
        // Check location and notification permissions
        let locationStatus = 'Not enabled';
        let notificationStatus = 'Not enabled';
        
        if (navigator.permissions) {
          // These are async but we'll show current state
          if (document.getElementById('locationBtn').textContent === 'Enabled') {
            locationStatus = 'Enabled';
          }
        }
        
        if (Notification.permission === 'granted') {
          notificationStatus = 'Enabled';
        }
        
        addField('Location Services', locationStatus);
        addField('Notifications', notificationStatus);
        yPosition += 10;
        
        // Recent Activity Summary
        addSectionHeader('Activity Summary', 'ğŸ“Š');
        addField('Completed Patrols', patrols.length.toString());
        addField('Incident Reports', incidents.length.toString());
        addField('Shift Reports', shifts.length.toString());
        yPosition += 10;
        
        // Recent Patrols (if any)
        if (patrols.length > 0) {
          addSectionHeader('Recent Patrols', 'ğŸš¶');
          const recentPatrols = patrols.slice(-5); // Last 5 patrols
          recentPatrols.forEach((patrol, index) => {
            checkPageBreak(15);
            doc.setFontSize(10);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text(`Patrol ${index + 1}:`, leftMargin + 10, yPosition);
            yPosition += 8;
            
            if (patrol.date) addField('Date', new Date(patrol.date).toLocaleDateString(), true);
            if (patrol.location) addField('Location', patrol.location, true);
            if (patrol.duration) addField('Duration', patrol.duration, true);
            if (patrol.notes) {
              const notes = patrol.notes.length > 50 ? patrol.notes.substring(0, 50) + '...' : patrol.notes;
              addField('Notes', notes, true);
            }
            yPosition += 5;
          });
        }
        
        // Recent Incidents (if any)
        if (incidents.length > 0) {
          addSectionHeader('Recent Incident Reports', 'ğŸ“');
          const recentIncidents = incidents.slice(-3); // Last 3 incidents
          recentIncidents.forEach((incident, index) => {
            checkPageBreak(20);
            doc.setFontSize(10);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text(`Incident ${index + 1}:`, leftMargin + 10, yPosition);
            yPosition += 8;
            
            if (incident.date) addField('Date', new Date(incident.date).toLocaleDateString(), true);
            if (incident.type) addField('Type', incident.type, true);
            if (incident.location) addField('Location', incident.location, true);
            if (incident.severity) addField('Severity', incident.severity, true);
            if (incident.description) {
              const desc = incident.description.length > 60 ? incident.description.substring(0, 60) + '...' : incident.description;
              addField('Description', desc, true);
            }
            yPosition += 5;
          });
        }
        
        // App Information
        addSectionHeader('App Information', 'â„¹ï¸');
        addField('Version', '1.0.0');
        addField('Last Updated', 'Today');
        
        // Calculate storage usage
        let totalSize = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length;
          }
        }
        addField('Storage Used', `${(totalSize / 1024).toFixed(1)} KB`);
        addField('Device', navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop');
        
        // Footer
        checkPageBreak(30);
        yPosition += 10;
        doc.setFontSize(8);
        doc.setTextColor(...lightGray);
        doc.setFont('helvetica', 'italic');
        doc.text('Security Companion v1.0 - Built for security professionals', leftMargin, yPosition);
        yPosition += 8;
        doc.text('This document contains sensitive information. Handle according to your organization\'s data security policies.', leftMargin, yPosition);
        
        // Save the PDF
        const fileName = `security-companion-profile-${profile.name ? profile.name.replace(/\s+/g, '-').toLowerCase() : 'officer'}-${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
        showSuccess('Profile data exported to PDF successfully!');
        
      } catch (error) {
        console.error('PDF export error:', error);
        showError('Failed to export PDF. Please try again.');
      }
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            
            if (await showConfirm('This will overwrite your current data. Continue?')) {
              if (data.profile) localStorage.setItem('userProfile', JSON.stringify(data.profile));
              if (data.contacts) localStorage.setItem('emergencyContacts', JSON.stringify(data.contacts));
              if (data.patrols) localStorage.setItem('completedPatrols', JSON.stringify(data.patrols));
              if (data.incidents) localStorage.setItem('savedIncidentReports', JSON.stringify(data.incidents));
              if (data.shifts) localStorage.setItem('savedShiftReports', JSON.stringify(data.shifts));
              if (data.settings) {
                if (data.settings.theme) localStorage.setItem('theme', data.settings.theme);
                if (data.settings.largeText) localStorage.setItem('largeText', data.settings.largeText);
              }
              
              showSuccess('Data imported successfully! Please refresh the page.');
            }
          } catch (error) {
            showError('Invalid backup file format.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    async function clearCache() {
      if (await showConfirm('Clear app cache? This will not delete your saved data.')) {
        // Clear service worker cache if available
        if ('caches' in window) {
          caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
          });
        }
        showSuccess('Cache cleared successfully!');
      }
    }

    async function resetApp() {
      if (await showConfirm('This will delete ALL your data and reset the app. This cannot be undone. Continue?')) {
        if (await showConfirm('Are you absolutely sure? This will permanently delete all your reports, patrols, and settings.')) {
          localStorage.clear();
          sessionStorage.clear();
          showSuccess('App reset successfully! The page will now reload.');
          window.location.reload();
        }
      }
    }

    // Device info
    function loadDeviceInfo() {
      document.getElementById('deviceInfo').textContent = navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop';
      
      // Calculate storage usage
      let totalSize = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          totalSize += localStorage[key].length;
        }
      }
      document.getElementById('storageUsed').textContent = `${(totalSize / 1024).toFixed(1)} KB`;
      
      document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initTheme();
      initTextSize();
      loadProfile();
      loadContacts();
      loadDeviceInfo();
      
      // Check permissions
      if (navigator.permissions) {
        navigator.permissions.query({ name: 'geolocation' }).then(permission => {
          if (permission.state === 'granted') {
            document.getElementById('locationBtn').textContent = 'Enabled';
            document.getElementById('locationBtn').classList.add('primary');
          }
        });
      }
      
      if (Notification.permission === 'granted') {
        document.getElementById('notificationBtn').textContent = 'Enabled';
        document.getElementById('notificationBtn').classList.add('primary');
      }
    });
  </script>
</body>
</html>