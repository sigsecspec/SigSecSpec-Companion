<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mission Schedule - Security Companion</title>
  <link rel="stylesheet" href="app-styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f0f0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="push-notifications.js"></script>
  <script src="popup-system.js"></script>
  <script src="emergency-common.js"></script>
</head>
<body class="bg-pattern">
  <!-- Header -->
  <header class="app-header">
    <div class="flex items-center gap-3">
      <div class="app-logo">
        <img src="patch-bg.png" alt="Security Logo">
      </div>
      <div class="header-content">
        <h1>Mission Schedule</h1>
        <p>
          <span class="status-indicator" id="scheduleStatus"></span>
          <span id="scheduleStatusText">Managing missions</span>
        </p>
      </div>
    </div>
    <div class="header-actions">
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>
      <button class="touch-btn" onclick="toggleTextSize()" aria-label="Toggle text size">A+</button>
    </div>
  </header>

  <!-- Emergency Button - Bottom Right -->
  <button class="emergency-btn-fixed" onclick="triggerEmergency()" aria-label="Emergency alert">
    🚨
  </button>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Schedule Overview -->
    <section class="mobile-card mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Schedule Overview</h2>
        <button class="touch-btn primary" onclick="openMissionScheduler()">
          <span class="mr-1">➕</span> Add Mission
        </button>
      </div>
      <div id="scheduleStats" class="grid grid-cols-3 gap-4 text-center">
        <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
          <div class="text-2xl font-bold text-blue-500" id="upcomingCount">0</div>
          <div class="text-sm" style="color: var(--text-secondary)">Upcoming</div>
        </div>
        <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
          <div class="text-2xl font-bold text-green-500" id="completedCount">0</div>
          <div class="text-sm" style="color: var(--text-secondary)">Completed</div>
        </div>
        <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
          <div class="text-2xl font-bold text-orange-500" id="totalHours">0</div>
          <div class="text-sm" style="color: var(--text-secondary)">Total Hours</div>
        </div>
      </div>
    </section>

    <!-- Active Mission -->
    <section class="mobile-card mb-6" id="activeMissionSection" style="display: none;">
      <h3 class="text-lg font-semibold mb-3">🟢 Current Mission</h3>
      <div id="activeMissionDetails">
        <!-- Active mission details will be populated here -->
      </div>
    </section>

    <!-- Upcoming Missions -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-3">📅 Upcoming Missions</h3>
      <div id="upcomingMissions" class="space-y-3">
        <!-- Upcoming missions will be populated here -->
      </div>
    </section>

    <!-- Past Missions & Reports -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-3">📋 Past Missions & Reports</h3>
      <div class="mb-3 text-sm" style="color: var(--text-secondary);">
        <span class="inline-flex items-center gap-1">
          <span>🔒</span> Past missions and reports are locked and cannot be edited
        </span>
      </div>
      <div id="pastMissions" class="space-y-3">
        <!-- Past missions will be populated here -->
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-grid">
      <a href="index.html" class="nav-item">
        <div class="nav-icon">🏠</div>
        <span>Home</span>
      </a>
      <a href="schedule.html" class="nav-item active">
        <div class="nav-icon">📋</div>
        <span>Schedule</span>
      </a>
      <a href="reports.html" class="nav-item">
        <div class="nav-icon">📝</div>
        <span>Reports</span>
      </a>
      <a href="patrol.html" class="nav-item">
        <div class="nav-icon">🚶</div>
        <span>Patrol</span>
      </a>
      <a href="shift.html" class="nav-item">
        <div class="nav-icon">⏰</div>
        <span>Shift</span>
      </a>
    </div>
  </nav>

  <!-- Mission Scheduler Modal -->
  <div id="missionSchedulerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="overflow-y: auto;">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 w-full max-w-md" style="background: var(--bg-primary); border: 1px solid var(--border);">
      <h3 class="text-xl font-bold mb-4">📅 Schedule Mission</h3>
      
      <form id="missionSchedulerForm" class="space-y-4">
        <!-- Mission Title -->
        <div>
          <label class="block text-sm font-medium mb-2">Mission Title</label>
          <input type="text" id="missionTitle" class="w-full px-3 py-2 rounded-lg" 
                 style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);"
                 placeholder="Enter mission title" required>
        </div>

        <!-- Date -->
        <div>
          <label class="block text-sm font-medium mb-2">Date</label>
          <input type="date" id="missionDate" class="w-full px-3 py-2 rounded-lg" 
                 style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);" required>
        </div>

        <!-- Time Range -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-2">Start Time</label>
            <input type="time" id="missionStartTime" class="w-full px-3 py-2 rounded-lg" 
                   style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">End Time</label>
            <input type="time" id="missionEndTime" class="w-full px-3 py-2 rounded-lg" 
                   style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);" required>
          </div>
        </div>

        <!-- Location -->
        <div>
          <label class="block text-sm font-medium mb-2">Location</label>
          <input type="text" id="missionLocation" class="w-full px-3 py-2 rounded-lg"
                 style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);"
                 placeholder="Mission location (optional)">
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium mb-2">Description</label>
          <textarea id="missionDescription" rows="3" class="w-full px-3 py-2 rounded-lg"
                    style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);"
                    placeholder="Mission description (optional)"></textarea>
        </div>

        <!-- Priority -->
        <div>
          <label class="block text-sm font-medium mb-2">Priority</label>
          <select id="missionPriority" class="w-full px-3 py-2 rounded-lg"
                  style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);">
            <option value="normal">Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3 pt-4">
          <button type="button" class="touch-btn flex-1" onclick="closeMissionScheduler()">
            Cancel
          </button>
          <button type="submit" class="touch-btn primary flex-1">
            Schedule Mission
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Mission Details Modal -->
  <div id="missionDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="overflow-y: auto;">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 w-full max-w-md" style="background: var(--bg-primary); border: 1px solid var(--border);">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" id="modalTitle">Mission Details</h3>
        <button class="icon-btn" onclick="closeMissionDetails()">✕</button>
      </div>
      
      <div id="missionDetailsContent">
        <!-- Mission details content will be populated here -->
      </div>

      <div class="flex gap-3 pt-4" id="missionActions">
        <!-- Action buttons will be populated based on mission status -->
      </div>
    </div>
  </div>

  <!-- Early Start Popup Modal -->
  <div id="earlyStartModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 w-full max-w-md" style="background: var(--bg-primary); border: 1px solid var(--border);">
      <div class="text-center">
        <div class="text-4xl mb-4">⏰</div>
        <h3 class="text-xl font-bold mb-4" style="color: var(--warning);">Too Early!</h3>
        <p id="earlyStartMessage" class="text-center mb-6" style="color: var(--text-secondary); line-height: 1.5;"></p>
        <button class="touch-btn primary w-full" onclick="closeEarlyStartPopup()">
          Got it! I'll wait
        </button>
      </div>
    </div>
  </div>

  <!-- Early End Popup Modal -->
  <div id="earlyEndModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 w-full max-w-md" style="background: var(--bg-primary); border: 1px solid var(--border);">
      <div class="text-center">
        <div class="text-4xl mb-4">🛑</div>
        <h3 class="text-xl font-bold mb-4" style="color: var(--warning);">Mission Still Active!</h3>
        <p id="earlyEndMessage" class="text-center mb-6" style="color: var(--text-secondary); line-height: 1.5;"></p>
        <div class="flex gap-3">
          <button class="touch-btn primary w-full" onclick="closeEarlyEndPopup()">
            Continue Mission
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Already In Mission Popup Modal -->
  <div id="alreadyInMissionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 w-full max-w-md" style="background: var(--bg-primary); border: 1px solid var(--border);">
      <div class="text-center">
        <div class="text-4xl mb-4">😅</div>
        <h3 class="text-xl font-bold mb-4" style="color: var(--warning);">Your already in a mission silly</h3>
        <p class="text-center mb-6" style="color: var(--text-secondary); line-height: 1.5;">
          You can't start a new mission while you're already on duty! Finish your current mission first.
        </p>
        <button class="touch-btn primary w-full" onclick="closeAlreadyInMissionPopup()">
          Ooh okay
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="app-common.js"></script>
  <script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize theme and text size
      initTheme();
      initTextSize();
      
      loadScheduleData();
      setActiveNavItem('schedule');
      
      // Update status indicator
      const statusEl = document.getElementById('scheduleStatus');
      const statusTextEl = document.getElementById('scheduleStatusText');
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      
      if (activeMission && activeMission.status === 'active') {
        statusEl.className = 'status-indicator status-active';
        statusTextEl.textContent = 'Mission in progress';
      } else {
        statusEl.className = 'status-indicator status-pending';
        statusTextEl.textContent = 'Ready to schedule';
      }
      
      // Set minimum date to today for new missions
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('missionDate').min = today;
      
      // Resume overtime monitoring if needed
      resumeOvertimeMonitoring();
      
      // Auto-refresh schedule every minute
      setInterval(loadScheduleData, 60000);
      
      // Update status periodically
      setInterval(function() {
        const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
        if (activeMission && activeMission.status === 'active') {
          statusEl.className = 'status-indicator status-active';
          statusTextEl.textContent = 'Mission in progress';
        } else {
          statusEl.className = 'status-indicator status-pending';
          statusTextEl.textContent = 'Ready to schedule';
        }
      }, 5000);
      
      // Add touch feedback to interactive elements
      addTouchFeedback();
    });

    // Load and display schedule data
    function loadScheduleData() {
      loadActiveMission();
      loadUpcomingMissions();
      loadPastMissions();
      updateScheduleStats();
    }

    // Load active mission
    function loadActiveMission() {
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      const section = document.getElementById('activeMissionSection');
      const container = document.getElementById('activeMissionDetails');
      
      if (activeMission && activeMission.status === 'active') {
        const startTime = new Date(activeMission.startTime);
        const duration = Math.floor((new Date() - startTime) / (1000 * 60 * 60));
        
        container.innerHTML = `
          <div class="p-3 rounded-lg" style="background: var(--bg-secondary); border: 2px solid var(--success);">
            <div class="flex items-center justify-between mb-2">
              <div class="font-medium">${activeMission.originalMission?.title || 'Manual Mission'}</div>
              <div class="text-sm px-2 py-1 rounded" style="background: var(--success); color: white;">Active</div>
            </div>
            <div class="text-sm" style="color: var(--text-secondary);">
              <div>Started: ${startTime.toLocaleString()}</div>
              <div>Duration: ${duration}h ${Math.floor(((new Date() - startTime) % (1000 * 60 * 60)) / (1000 * 60))}m</div>
              ${activeMission.originalMission?.location ? `<div>📍 ${activeMission.originalMission.location}</div>` : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="touch-btn danger flex-1" onclick="endCurrentMission()">
                End Mission
              </button>
              <button class="touch-btn" onclick="viewMissionDetails('active', '${activeMission.id}')">
                View Details
              </button>
            </div>
          </div>
        `;
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    }

    // Load upcoming missions
    function loadUpcomingMissions() {
      const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
      const container = document.getElementById('upcomingMissions');
      const now = new Date();
      
      const upcomingMissions = scheduledMissions
        .filter(mission => {
          const missionDateTime = new Date(mission.date + 'T' + mission.startTime);
          return missionDateTime > now && mission.status === 'scheduled';
        })
        .sort((a, b) => {
          const dateA = new Date(a.date + 'T' + a.startTime);
          const dateB = new Date(b.date + 'T' + b.startTime);
          return dateA - dateB;
        });
      
      if (upcomingMissions.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8" style="color: var(--text-muted);">
            <div class="text-3xl mb-2">📅</div>
            <div>No upcoming missions</div>
            <div class="text-sm mt-1">Schedule your next mission to get started</div>
          </div>
        `;
        return;
      }
      
      let content = '';
      upcomingMissions.forEach(mission => {
        const missionDateTime = new Date(mission.date + 'T' + mission.startTime);
        const timeUntil = missionDateTime - now;
        const hoursUntil = Math.floor(timeUntil / (1000 * 60 * 60));
        const daysUntil = Math.floor(hoursUntil / 24);
        
        let timeText = '';
        if (daysUntil > 0) {
          timeText = `in ${daysUntil} day${daysUntil > 1 ? 's' : ''}`;
        } else if (hoursUntil > 0) {
          timeText = `in ${hoursUntil} hour${hoursUntil > 1 ? 's' : ''}`;
        } else {
          timeText = 'starting soon';
        }
        
        const priorityColor = mission.priority === 'urgent' ? 'var(--error)' : 
                            mission.priority === 'high' ? 'var(--warning)' : 'var(--info)';
        
        content += `
          <div class="p-3 rounded-lg cursor-pointer hover:bg-opacity-80 transition-all" 
               style="background: var(--bg-tertiary); border-left: 4px solid ${priorityColor};"
               onclick="viewMissionDetails('scheduled', '${mission.id}')">
            <div class="flex items-center justify-between mb-2">
              <div class="font-medium">${mission.title}</div>
              <div class="text-xs px-2 py-1 rounded" style="background: ${priorityColor}; color: white;">
                ${mission.priority.toUpperCase()}
              </div>
            </div>
            <div class="text-sm" style="color: var(--text-secondary);">
              <div>${missionDateTime.toLocaleDateString()} ${mission.startTime} - ${mission.endTime}</div>
              <div class="text-blue-500">${timeText}</div>
              ${mission.location ? `<div>📍 ${mission.location}</div>` : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="touch-btn primary flex-1" onclick="event.stopPropagation(); startScheduledMission('${mission.id}')">
                Start Mission
              </button>
              <button class="touch-btn" onclick="event.stopPropagation(); editMission('${mission.id}')">
                Edit
              </button>
              <button class="touch-btn danger" onclick="event.stopPropagation(); deleteMission('${mission.id}')">
                Delete
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = content;
    }

    // Load past missions and reports
    function loadPastMissions() {
      const missionHistory = JSON.parse(localStorage.getItem('missionHistory') || '[]');
      const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
      const container = document.getElementById('pastMissions');
      const now = new Date();
      
      // Get past scheduled missions (that haven't been started)
      const pastScheduled = scheduledMissions.filter(mission => {
        const missionDateTime = new Date(mission.date + 'T' + mission.endTime);
        return missionDateTime < now && mission.status === 'scheduled';
      });
      
      // Combine and sort by date (most recent first)
      const allPastMissions = [...missionHistory, ...pastScheduled]
        .sort((a, b) => {
          const dateA = new Date(a.endTime || a.date + 'T' + a.endTime);
          const dateB = new Date(b.endTime || b.date + 'T' + b.endTime);
          return dateB - dateA;
        });
      
      if (allPastMissions.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8" style="color: var(--text-muted);">
            <div class="text-3xl mb-2">📋</div>
            <div>No past missions yet</div>
            <div class="text-sm mt-1">Complete your first mission to see history</div>
          </div>
        `;
        return;
      }
      
      let content = '';
      allPastMissions.slice(0, 20).forEach(mission => { // Show last 20 missions
        const isCompleted = mission.status === 'completed';
        const startTime = new Date(mission.startTime || mission.date + 'T' + mission.startTime);
        const endTime = mission.endTime ? new Date(mission.endTime) : null;
        
        let statusIcon = '🔒';
        let statusText = 'Locked';
        let statusColor = 'var(--text-muted)';
        
        if (isCompleted) {
          statusIcon = '✅';
          statusText = 'Completed';
          statusColor = 'var(--success)';
        } else {
          statusIcon = '⏰';
          statusText = 'Expired';
          statusColor = 'var(--warning)';
        }
        
        content += `
          <div class="p-3 rounded-lg" style="background: var(--bg-tertiary); opacity: 0.8;">
            <div class="flex items-center justify-between mb-2">
              <div class="font-medium">${mission.originalMission?.title || mission.title || 'Mission'}</div>
              <div class="flex items-center gap-2">
                <span>${statusIcon}</span>
                <div class="text-xs px-2 py-1 rounded" style="background: ${statusColor}; color: white;">
                  ${statusText}
                </div>
              </div>
            </div>
            <div class="text-sm" style="color: var(--text-secondary);">
              <div>${startTime.toLocaleDateString()} ${startTime.toLocaleTimeString()}</div>
              ${endTime ? `<div>Ended: ${endTime.toLocaleTimeString()}</div>` : ''}
              ${mission.location || mission.originalMission?.location ? `<div>📍 ${mission.location || mission.originalMission?.location}</div>` : ''}
            </div>
            <div class="mt-3">
              <button class="touch-btn w-full" onclick="viewMissionDetails('${isCompleted ? 'completed' : 'past'}', '${mission.id}')">
                <span class="mr-1">📋</span> View Details & Reports
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = content;
    }

    // Update schedule statistics
    function updateScheduleStats() {
      const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
      const missionHistory = JSON.parse(localStorage.getItem('missionHistory') || '[]');
      const now = new Date();
      
      // Count upcoming missions
      const upcomingCount = scheduledMissions.filter(mission => {
        const missionDateTime = new Date(mission.date + 'T' + mission.startTime);
        return missionDateTime > now && mission.status === 'scheduled';
      }).length;
      
      // Count completed missions
      const completedCount = missionHistory.length;
      
      // Calculate total hours from completed missions
      const totalHours = missionHistory.reduce((total, mission) => {
        if (mission.startTime && mission.endTime) {
          const start = new Date(mission.startTime);
          const end = new Date(mission.endTime);
          const hours = (end - start) / (1000 * 60 * 60);
          return total + hours;
        }
        return total;
      }, 0);
      
      document.getElementById('upcomingCount').textContent = upcomingCount;
      document.getElementById('completedCount').textContent = completedCount;
      document.getElementById('totalHours').textContent = Math.round(totalHours);
    }

    // Mission Scheduler Functions
    function openMissionScheduler() {
      document.getElementById('missionSchedulerModal').classList.remove('hidden');
      document.getElementById('missionSchedulerModal').classList.add('flex');
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('missionDate').value = today;
    }

    function closeMissionScheduler() {
      document.getElementById('missionSchedulerModal').classList.add('hidden');
      document.getElementById('missionSchedulerModal').classList.remove('flex');
      document.getElementById('missionSchedulerForm').reset();
    }

    // Handle mission form submission
    document.getElementById('missionSchedulerForm').addEventListener('submit', function(e) {
      e.preventDefault();
      saveMission();
    });

    function saveMission() {
      const title = document.getElementById('missionTitle').value;
      const date = document.getElementById('missionDate').value;
      const startTime = document.getElementById('missionStartTime').value;
      const endTime = document.getElementById('missionEndTime').value;
      const location = document.getElementById('missionLocation').value;
      const description = document.getElementById('missionDescription').value;
      const priority = document.getElementById('missionPriority').value;

      // Validate inputs
      if (!title || !date || !startTime || !endTime) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }

      // Validate time range
      if (startTime >= endTime) {
        showNotification('End time must be after start time', 'error');
        return;
      }

      // Create mission object
      const mission = {
        id: Date.now().toString(),
        title,
        date,
        startTime,
        endTime,
        location,
        description,
        priority,
        status: 'scheduled',
        createdAt: new Date().toISOString()
      };

      // Save to localStorage
      const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
      scheduledMissions.push(mission);
      localStorage.setItem('scheduledMissions', JSON.stringify(scheduledMissions));

      // Close modal and refresh
      closeMissionScheduler();
      loadScheduleData();
      showNotification('Mission scheduled successfully!', 'success');
    }

    // Mission action functions
    function startScheduledMission(missionId) {
      const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
      const mission = scheduledMissions.find(m => m.id === missionId);
      
      if (!mission) {
        showNotification('Mission not found', 'error');
        return;
      }

      // Check if there's already an active mission
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      if (activeMission && activeMission.status === 'active') {
        showAlreadyInMissionPopup();
        return;
      }

      // Check if it's too early to start the mission (before 15 minutes)
      const now = new Date();
      const missionStartTime = new Date(mission.date + 'T' + mission.startTime);
      const timeUntilStart = missionStartTime - now;
      const minutesUntilStart = Math.floor(timeUntilStart / (1000 * 60));
      
      if (timeUntilStart > 15 * 60 * 1000) { // More than 15 minutes early
        const hoursUntil = Math.floor(minutesUntilStart / 60);
        const remainingMinutes = minutesUntilStart % 60;
        
        let timeMessage = '';
        if (hoursUntil > 0) {
          timeMessage = `${hoursUntil} hour${hoursUntil > 1 ? 's' : ''} and ${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`;
        } else {
          timeMessage = `${minutesUntilStart} minute${minutesUntilStart !== 1 ? 's' : ''}`;
        }
        
        let message = '';
        if (minutesUntilStart > 60) {
          message = `Woah! It's too early for this mission. You have ${timeMessage} until shift start. Take a break and come back closer to mission time! ⏰`;
        } else {
          message = `Hold on! It's still ${timeMessage} until your mission starts. Maybe grab a coffee and wait a bit longer? ☕`;
        }
        
        showEarlyStartPopup(message);
        return;
      }

      // Start the mission
      const newActiveMission = {
        id: Date.now().toString(),
        startTime: new Date().toISOString(),
        status: 'active',
        type: 'scheduled',
        originalMission: mission
      };

      localStorage.setItem('activeMission', JSON.stringify(newActiveMission));
      
      // Update mission status
      mission.status = 'started';
      localStorage.setItem('scheduledMissions', JSON.stringify(scheduledMissions));
      
      // Start overtime monitoring
      startOvertimeMonitoring(newActiveMission);
      
      loadScheduleData();
      showNotification('Mission started successfully!', 'success');
    }

    function editMission(missionId) {
      const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
      const mission = scheduledMissions.find(m => m.id === missionId);
      
      if (!mission) {
        showNotification('Mission not found', 'error');
        return;
      }

      // Check if mission is in the past
      const missionDateTime = new Date(mission.date + 'T' + mission.startTime);
      if (missionDateTime < new Date()) {
        showNotification('Cannot edit past missions', 'warning');
        return;
      }

      // Populate form with mission data
      document.getElementById('missionTitle').value = mission.title;
      document.getElementById('missionDate').value = mission.date;
      document.getElementById('missionStartTime').value = mission.startTime;
      document.getElementById('missionEndTime').value = mission.endTime;
      document.getElementById('missionLocation').value = mission.location || '';
      document.getElementById('missionDescription').value = mission.description || '';
      document.getElementById('missionPriority').value = mission.priority;

      // Store mission ID for updating
      document.getElementById('missionSchedulerForm').dataset.editingId = missionId;
      
      openMissionScheduler();
    }

    function deleteMission(missionId) {
      if (!confirm('Are you sure you want to delete this mission?')) {
        return;
      }

      const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
      const updatedMissions = scheduledMissions.filter(m => m.id !== missionId);
      
      localStorage.setItem('scheduledMissions', JSON.stringify(updatedMissions));
      loadScheduleData();
      showNotification('Mission deleted successfully', 'success');
    }

    function endCurrentMission() {
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      if (!activeMission) {
        showNotification('No active mission found', 'error');
        return;
      }

      // Check if it's too early to end the mission
      const now = new Date();
      const originalMission = activeMission.originalMission;
      
      if (originalMission) {
        const missionEndTime = new Date(originalMission.date + 'T' + originalMission.endTime);
        const timeUntilEnd = missionEndTime - now;
        const minutesUntilEnd = Math.floor(timeUntilEnd / (1000 * 60));
        
        if (timeUntilEnd > 0) { // Mission hasn't reached its scheduled end time
          const hoursUntil = Math.floor(minutesUntilEnd / 60);
          const remainingMinutes = minutesUntilEnd % 60;
          
          let timeMessage = '';
          if (hoursUntil > 0) {
            timeMessage = `${hoursUntil} hour${hoursUntil > 1 ? 's' : ''} and ${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`;
          } else {
            timeMessage = `${minutesUntilEnd} minute${minutesUntilEnd !== 1 ? 's' : ''}`;
          }
          
          let message = '';
          if (minutesUntilEnd > 60) {
            message = `Woah, not so fast! This mission time hasn't ended yet. You still have ${timeMessage} left on the clock. Stay vigilant! 🕐`;
          } else {
            message = `Hold up! You've got ${timeMessage} left in this mission. Finish strong! 💪`;
          }
          
          showEarlyEndPopup(message, () => {
            // Allow force end if user really wants to
            forceEndMission();
          });
          return;
        }
      }

      // Proceed with normal mission end
      if (!confirm('Are you sure you want to end the current mission?')) {
        return;
      }

      endMissionNow();
    }
    
    function forceEndMission() {
      if (confirm('Are you sure you want to end the mission early? This will be noted in your report.')) {
        endMissionNow();
      }
    }
    
    function endMissionNow() {
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      if (!activeMission) {
        return;
      }

      // Clear overtime monitoring
      clearOvertimeMonitoring();

      // Create completed mission record
      const completedMission = {
        ...activeMission,
        endTime: new Date().toISOString(),
        status: 'completed'
      };

      // Add to mission history
      const missionHistory = JSON.parse(localStorage.getItem('missionHistory') || '[]');
      missionHistory.unshift(completedMission);
      localStorage.setItem('missionHistory', JSON.stringify(missionHistory.slice(0, 50)));

      // Remove active mission
      localStorage.removeItem('activeMission');

      loadScheduleData();
      showNotification('Mission ended successfully', 'success');
    }

    // View mission details
    function viewMissionDetails(type, missionId) {
      let mission = null;
      
      if (type === 'active') {
        mission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      } else if (type === 'scheduled') {
        const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
        mission = scheduledMissions.find(m => m.id === missionId);
      } else if (type === 'completed' || type === 'past') {
        const missionHistory = JSON.parse(localStorage.getItem('missionHistory') || '[]');
        mission = missionHistory.find(m => m.id === missionId);
        
        // Also check scheduled missions for past ones
        if (!mission) {
          const scheduledMissions = JSON.parse(localStorage.getItem('scheduledMissions') || '[]');
          mission = scheduledMissions.find(m => m.id === missionId);
        }
      }

      if (mission) {
        showMissionDetailsModal(mission, type);
      }
    }
    
    function showMissionDetailsModal(mission, type) {
      const modal = document.getElementById('missionDetailsModal');
      const title = document.getElementById('modalTitle');
      const content = document.getElementById('missionDetailsContent');
      const actions = document.getElementById('missionActions');
      
      // Set title based on type
      const titles = {
        'active': '🟢 Active Mission Details',
        'scheduled': '📅 Scheduled Mission Details',
        'completed': '✅ Completed Mission Details',
        'past': '📋 Past Mission Details'
      };
      title.textContent = titles[type] || 'Mission Details';
      
      // Build content based on mission type and data
      let missionData = mission.originalMission || mission;
      let contentHTML = '';
      
      // Basic mission info
      contentHTML += `
        <div class="space-y-4">
          <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
            <h4 class="font-semibold mb-2">📋 Mission Information</h4>
            <div class="space-y-2 text-sm">
              <div><strong>Title:</strong> ${missionData.title || 'Mission'}</div>
              ${missionData.date ? `<div><strong>Date:</strong> ${missionData.date}</div>` : ''}
              ${missionData.startTime ? `<div><strong>Scheduled:</strong> ${missionData.startTime} - ${missionData.endTime}</div>` : ''}
              ${missionData.location ? `<div><strong>Location:</strong> 📍 ${missionData.location}</div>` : ''}
              ${missionData.priority ? `<div><strong>Priority:</strong> <span style="color: ${getPriorityColor(missionData.priority)}">${missionData.priority.toUpperCase()}</span></div>` : ''}
              ${missionData.description ? `<div><strong>Description:</strong> ${missionData.description}</div>` : ''}
            </div>
          </div>
      `;
      
      // Add timing information for active/completed missions
      if (type === 'active' || type === 'completed') {
        const startTime = new Date(mission.startTime);
        const endTime = mission.endTime ? new Date(mission.endTime) : new Date();
        const duration = Math.floor((endTime - startTime) / (1000 * 60));
        const hours = Math.floor(duration / 60);
        const minutes = duration % 60;
        
        contentHTML += `
          <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
            <h4 class="font-semibold mb-2">⏱️ Timing Details</h4>
            <div class="space-y-2 text-sm">
              <div><strong>Started:</strong> ${startTime.toLocaleString()}</div>
              ${mission.endTime ? `<div><strong>Ended:</strong> ${new Date(mission.endTime).toLocaleString()}</div>` : '<div><strong>Status:</strong> <span style="color: var(--success)">Currently Active</span></div>'}
              <div><strong>Duration:</strong> ${hours}h ${minutes}m</div>
            </div>
          </div>
        `;
      }
      
      // Add reports section for completed missions
      if (type === 'completed') {
        const reports = getReportsForMission(mission.id);
        contentHTML += `
          <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
            <h4 class="font-semibold mb-2">📝 Reports & Documentation</h4>
            <div class="space-y-2 text-sm">
              ${reports.length > 0 ? 
                reports.map(report => `
                  <div class="p-2 rounded" style="background: var(--bg-secondary);">
                    <div><strong>${report.type}:</strong> ${report.title}</div>
                    <div class="text-xs" style="color: var(--text-secondary);">${new Date(report.timestamp).toLocaleString()}</div>
                  </div>
                `).join('') : 
                '<div style="color: var(--text-secondary);">No reports filed for this mission</div>'
              }
              <button class="touch-btn primary w-full mt-2" onclick="viewAllReports('${mission.id}')">
                📋 View All Reports
              </button>
            </div>
          </div>
        `;
      }
      
      contentHTML += '</div>';
      content.innerHTML = contentHTML;
      
      // Set up action buttons
      let actionsHTML = '';
      if (type === 'active') {
        actionsHTML = `
          <button class="touch-btn danger flex-1" onclick="closeMissionDetails(); endCurrentMission();">
            End Mission
          </button>
          <button class="touch-btn flex-1" onclick="closeMissionDetails()">
            Close
          </button>
        `;
      } else if (type === 'scheduled') {
        actionsHTML = `
          <button class="touch-btn primary flex-1" onclick="closeMissionDetails(); startScheduledMission('${mission.id}');">
            Start Mission
          </button>
          <button class="touch-btn flex-1" onclick="closeMissionDetails(); editMission('${mission.id}');">
            Edit
          </button>
          <button class="touch-btn flex-1" onclick="closeMissionDetails()">
            Close
          </button>
        `;
      } else {
        actionsHTML = `
          <button class="touch-btn primary flex-1" onclick="exportMissionData('${mission.id}')">
            📤 Export Data
          </button>
          <button class="touch-btn flex-1" onclick="closeMissionDetails()">
            Close
          </button>
        `;
      }
      
      actions.innerHTML = actionsHTML;
      
      // Show modal
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function closeMissionDetails() {
      const modal = document.getElementById('missionDetailsModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    function getPriorityColor(priority) {
      const colors = {
        'urgent': 'var(--error)',
        'high': 'var(--warning)',
        'normal': 'var(--info)'
      };
      return colors[priority] || colors.normal;
    }
    
    function getReportsForMission(missionId) {
      // Get reports associated with this mission
      const allReports = JSON.parse(localStorage.getItem('incidentReports') || '[]');
      return allReports.filter(report => report.missionId === missionId);
    }
    
    function viewAllReports(missionId) {
      // Navigate to reports page with mission filter
      window.location.href = `reports.html?mission=${missionId}`;
    }
    
    function exportMissionData(missionId) {
      // Export mission data as JSON
      const missionHistory = JSON.parse(localStorage.getItem('missionHistory') || '[]');
      const mission = missionHistory.find(m => m.id === missionId);
      
      if (mission) {
        const reports = getReportsForMission(missionId);
        const exportData = {
          mission: mission,
          reports: reports,
          exportDate: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `mission-${missionId}-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(url);
        showNotification('Mission data exported successfully!', 'success');
      }
    }

    // Popup Functions
    function showEarlyStartPopup(message) {
      document.getElementById('earlyStartMessage').textContent = message;
      document.getElementById('earlyStartModal').classList.remove('hidden');
      document.getElementById('earlyStartModal').classList.add('flex');
    }
    
    function closeEarlyStartPopup() {
      document.getElementById('earlyStartModal').classList.add('hidden');
      document.getElementById('earlyStartModal').classList.remove('flex');
    }
    
    function showEarlyEndPopup(message, forceEndCallback) {
      document.getElementById('earlyEndMessage').textContent = message;
      document.getElementById('earlyEndModal').classList.remove('hidden');
      document.getElementById('earlyEndModal').classList.add('flex');
      
      // Store the callback for force end
      window.currentForceEndCallback = forceEndCallback;
    }
    
    function closeEarlyEndPopup() {
      document.getElementById('earlyEndModal').classList.add('hidden');
      document.getElementById('earlyEndModal').classList.remove('flex');
      window.currentForceEndCallback = null;
    }
    
    function forceEndFromPopup() {
      closeEarlyEndPopup();
      if (window.currentForceEndCallback) {
        window.currentForceEndCallback();
      }
    }
    
    // Already In Mission Popup Functions
    function showAlreadyInMissionPopup() {
      document.getElementById('alreadyInMissionModal').classList.remove('hidden');
      document.getElementById('alreadyInMissionModal').classList.add('flex');
    }
    
    function closeAlreadyInMissionPopup() {
      document.getElementById('alreadyInMissionModal').classList.add('hidden');
      document.getElementById('alreadyInMissionModal').classList.remove('flex');
    }
    
    // Overtime Monitoring
    let overtimeInterval = null;
    let overtimeNotificationCount = 0;
    
    function startOvertimeMonitoring(activeMission) {
      // Clear any existing monitoring
      clearOvertimeMonitoring();
      
      if (!activeMission.originalMission) {
        return; // Can't monitor overtime without scheduled end time
      }
      
      const missionEndTime = new Date(activeMission.originalMission.date + 'T' + activeMission.originalMission.endTime);
      
      // Check every minute for overtime
      overtimeInterval = setInterval(() => {
        const now = new Date();
        const overtimeMs = now - missionEndTime;
        
        if (overtimeMs > 0) { // Mission is running overtime
          const overtimeMinutes = Math.floor(overtimeMs / (1000 * 60));
          
          // Send notification every 15 minutes starting at 15 minutes overtime
          if (overtimeMinutes >= 15 && overtimeMinutes % 15 === 0) {
            const notificationId = Math.floor(overtimeMinutes / 15);
            
            // Only send if we haven't sent this specific notification yet
            if (notificationId > overtimeNotificationCount) {
              overtimeNotificationCount = notificationId;
              sendOvertimeNotification(overtimeMinutes);
            }
          }
        }
      }, 60000); // Check every minute
      
      // Store monitoring info
      localStorage.setItem('overtimeMonitoring', JSON.stringify({
        missionId: activeMission.id,
        endTime: missionEndTime.toISOString(),
        notificationCount: 0
      }));
    }
    
    function clearOvertimeMonitoring() {
      if (overtimeInterval) {
        clearInterval(overtimeInterval);
        overtimeInterval = null;
      }
      overtimeNotificationCount = 0;
      localStorage.removeItem('overtimeMonitoring');
    }
    
    function sendOvertimeNotification(overtimeMinutes) {
      const hours = Math.floor(overtimeMinutes / 60);
      const minutes = overtimeMinutes % 60;
      
      let timeText = '';
      if (hours > 0) {
        timeText = `${hours} hour${hours > 1 ? 's' : ''} and ${minutes} minute${minutes !== 1 ? 's' : ''}`;
      } else {
        timeText = `${overtimeMinutes} minute${overtimeMinutes !== 1 ? 's' : ''}`;
      }
      
      let message = '';
      let title = '';
      
      if (overtimeMinutes === 15) {
        title = '⏰ Still On The Clock!';
        message = `Hey! You're ${timeText} past your scheduled end time. Don't forget to clock out when you're ready! 🕐`;
      } else if (overtimeMinutes === 30) {
        title = '⏰ Overtime Alert!';
        message = `You've been on duty for an extra ${timeText}! Time to wrap up and clock out. You've earned your rest! 💪`;
      } else if (overtimeMinutes >= 60) {
        title = '⏰ Extended Overtime!';
        message = `Wow! You've been working ${timeText} overtime! Please remember to end your mission and get some well-deserved rest. 🛌`;
      } else {
        title = '⏰ Overtime Reminder';
        message = `You're ${timeText} past your scheduled end time. Please remember to clock out when you're finished! ⏱️`;
      }
      
      // Use the notification system if available
      if (window.securityNotifications) {
        window.securityNotifications.showLocalNotification(
          title,
          message,
          {
            tag: 'overtime-reminder',
            requireInteraction: true,
            vibrate: [200, 100, 200, 100, 200],
            data: { 
              type: 'overtime', 
              url: '/schedule.html',
              overtimeMinutes: overtimeMinutes
            }
          }
        );
      } else {
        showNotification(message, 'warning');
      }
    }
    
    // Resume overtime monitoring on page load if needed
    function resumeOvertimeMonitoring() {
      const monitoringInfo = JSON.parse(localStorage.getItem('overtimeMonitoring') || 'null');
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      
      if (monitoringInfo && activeMission && activeMission.id === monitoringInfo.missionId) {
        overtimeNotificationCount = monitoringInfo.notificationCount || 0;
        startOvertimeMonitoring(activeMission);
      }
    }

    // Notification helper
    function showNotification(message, type = 'info') {
      if (window.showNotification) {
        window.showNotification(message, type);
      } else {
        alert(message);
      }
    }
  </script>
</body>
</html>