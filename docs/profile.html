<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile — Security Companion</title>
  <link rel="stylesheet" href="app-styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f0f0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="push-notifications.js"></script>
  <script src="emergency-common.js"></script>
  <script src="popup-system.js"></script>
  <script src="page-transitions.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      margin: 0 auto 1rem;
    }

    .contact-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      margin-bottom: 0.75rem;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .contact-item:hover {
      border-color: var(--accent-primary);
      transform: translateY(-1px);
    }

    .contact-item:active {
      transform: scale(0.98);
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-secondary);
    }

    .setting-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body class="bg-pattern">
  <!-- Header -->
  <header class="app-header">
    <div class="flex items-center gap-3">
      <div class="app-logo">
        <img src="patch-bg.png" alt="Security Logo">
      </div>
      <div class="header-content">
        <h1>Profile & Settings</h1>
        <p>Manage your account and preferences</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>
    </div>
  </header>

  <!-- Emergency Button - Bottom Right -->
  <button class="emergency-btn-fixed" onclick="triggerEmergency()" aria-label="Emergency alert">
    🚨
  </button>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Profile Section -->
    <section class="mobile-card mb-6">
      <div class="text-center">
        <div class="avatar" id="profileAvatar">👤</div>
        <h2 class="text-xl font-bold mb-2" id="profileName">Officer Name</h2>
        <p style="color: var(--text-secondary)" id="profileBadge">Badge #12345</p>
      </div>
      
      <div class="mt-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Full Name</label>
          <input type="text" id="officerName" class="form-input" placeholder="Enter your full name">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Badge Number</label>
          <input type="text" id="badgeNumber" class="form-input" placeholder="Enter badge number">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Department</label>
          <input type="text" id="department" class="form-input" placeholder="Enter department">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Shift</label>
          <select id="shiftType" class="form-input">
            <option value="">Select shift</option>
            <option value="day">Day Shift (6 AM - 6 PM)</option>
            <option value="night">Night Shift (6 PM - 6 AM)</option>
            <option value="swing">Swing Shift (2 PM - 10 PM)</option>
            <option value="rotating">Rotating</option>
          </select>
        </div>
        
        <button class="touch-btn primary w-full" onclick="saveProfile()">
          <span class="mr-2">💾</span> Save Profile
        </button>
      </div>
    </section>

    <!-- Guard Availability Section -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-4">🗓️ Availability Settings</h3>
      
      <div class="space-y-4">
        <!-- Weekly Availability -->
        <div>
          <h4 class="text-md font-medium mb-3">Weekly Schedule</h4>
          <div class="space-y-2" id="weeklyAvailability">
            <!-- Days will be populated here -->
          </div>
        </div>

        <!-- Shift Preferences -->
        <div class="mt-4">
          <h4 class="text-md font-medium mb-3">Preferred Shifts</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center p-3 rounded-lg cursor-pointer" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
              <input type="checkbox" id="shift-morning" class="mr-2" style="width: 18px; height: 18px;">
              <div>
                <div class="font-medium">Morning</div>
                <div class="text-xs" style="color: var(--text-secondary)">6 AM - 2 PM</div>
              </div>
            </label>
            <label class="flex items-center p-3 rounded-lg cursor-pointer" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
              <input type="checkbox" id="shift-afternoon" class="mr-2" style="width: 18px; height: 18px;">
              <div>
                <div class="font-medium">Afternoon</div>
                <div class="text-xs" style="color: var(--text-secondary)">2 PM - 10 PM</div>
              </div>
            </label>
            <label class="flex items-center p-3 rounded-lg cursor-pointer" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
              <input type="checkbox" id="shift-night" class="mr-2" style="width: 18px; height: 18px;">
              <div>
                <div class="font-medium">Night</div>
                <div class="text-xs" style="color: var(--text-secondary)">10 PM - 6 AM</div>
              </div>
            </label>
            <label class="flex items-center p-3 rounded-lg cursor-pointer" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
              <input type="checkbox" id="shift-weekend" class="mr-2" style="width: 18px; height: 18px;">
              <div>
                <div class="font-medium">Weekends</div>
                <div class="text-xs" style="color: var(--text-secondary)">Available</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Time Off / Unavailable Dates -->
        <div class="mt-4">
          <h4 class="text-md font-medium mb-3">Time Off / Unavailable Dates</h4>
          <div id="unavailableDates" class="space-y-2 mb-3">
            <!-- Unavailable dates will be listed here -->
          </div>
          <button class="touch-btn w-full" onclick="addUnavailableDate()">
            <span class="mr-2">➕</span> Add Unavailable Date
          </button>
        </div>

        <!-- Maximum Hours Per Week -->
        <div class="mt-4">
          <label class="block text-sm font-medium mb-2">Maximum Hours Per Week</label>
          <input type="number" id="maxHoursPerWeek" class="form-input" placeholder="40" min="0" max="168">
        </div>

        <!-- Overtime Availability -->
        <div class="mt-4">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="overtimeAvailable" class="mr-3" style="width: 18px; height: 18px;">
            <div>
              <div class="font-medium">Available for Overtime</div>
              <div class="text-sm" style="color: var(--text-secondary)">Can work extra shifts when needed</div>
            </div>
          </label>
        </div>

        <!-- Emergency Call Availability -->
        <div class="mt-4">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="emergencyCallAvailable" class="mr-3" style="width: 18px; height: 18px;">
            <div>
              <div class="font-medium">Available for Emergency Calls</div>
              <div class="text-sm" style="color: var(--text-secondary)">Can be contacted for urgent coverage</div>
            </div>
          </label>
        </div>

        <!-- Availability Notes -->
        <div class="mt-4">
          <label class="block text-sm font-medium mb-2">Additional Notes</label>
          <textarea id="availabilityNotes" class="form-input" rows="3" placeholder="Any specific availability requirements or notes..."></textarea>
        </div>

        <button class="touch-btn primary w-full mt-4" onclick="saveAvailability()">
          <span class="mr-2">💾</span> Save Availability
        </button>
      </div>
    </section>

    <!-- Emergency Contacts -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-4">📞 Emergency Contacts</h3>
      
      <a href="tel:911" class="contact-item">
        <div class="text-2xl mr-4">🚨</div>
        <div class="flex-1">
          <div class="font-semibold">Emergency Services</div>
          <div class="text-sm" style="color: var(--text-secondary)">911</div>
        </div>
        <div style="color: var(--text-muted)">→</div>
      </a>
      
      <a href="tel:555-0123" class="contact-item">
        <div class="text-2xl mr-4">👮</div>
        <div class="flex-1">
          <div class="font-semibold">Supervisor</div>
          <div class="text-sm" style="color: var(--text-secondary)" id="supervisorPhone">555-0123</div>
        </div>
        <div style="color: var(--text-muted)">→</div>
      </a>
      
      <a href="tel:555-0124" class="contact-item">
        <div class="text-2xl mr-4">🏢</div>
        <div class="flex-1">
          <div class="font-semibold">Dispatch Center</div>
          <div class="text-sm" style="color: var(--text-secondary)" id="dispatchPhone">555-0124</div>
        </div>
        <div style="color: var(--text-muted)">→</div>
      </a>
      
      <a href="tel:555-0125" class="contact-item">
        <div class="text-2xl mr-4">🚑</div>
        <div class="flex-1">
          <div class="font-semibold">Medical Emergency</div>
          <div class="text-sm" style="color: var(--text-secondary)" id="medicalPhone">555-0125</div>
        </div>
        <div style="color: var(--text-muted)">→</div>
      </a>
      
      <button class="touch-btn w-full mt-4" onclick="editContacts()">
        <span class="mr-2">✏️</span> Edit Contacts
      </button>
    </section>

    <!-- App Settings -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-4">⚙️ App Settings</h3>
      
      <div class="setting-item">
        <div>
          <div class="font-medium">Dark Mode</div>
          <div class="text-sm" style="color: var(--text-secondary)">Switch between light and dark themes</div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()"></button>
      </div>
      
      <div class="setting-item">
        <div>
          <div class="font-medium">Location Services</div>
          <div class="text-sm" style="color: var(--text-secondary)">Allow app to access your location</div>
        </div>
        <button class="touch-btn" onclick="requestLocation()" id="locationBtn">Enable</button>
      </div>
      
      <div class="setting-item">
        <div>
          <div class="font-medium">Notifications</div>
          <div class="text-sm" style="color: var(--text-secondary)">Receive alerts and reminders</div>
        </div>
        <button class="touch-btn" onclick="requestNotifications()" id="notificationBtn" data-notification-toggle>Enable</button>
      </div>
    </section>

    <!-- Data Management -->
    <section class="mobile-card mb-6">
      <h3 class="text-lg font-semibold mb-4">💾 Data Management</h3>
      
      <div class="space-y-3">
        <button class="touch-btn w-full" onclick="exportData()">
          <span class="mr-2">📤</span> Export Data
        </button>
        
        <button class="touch-btn w-full" onclick="importData()">
          <span class="mr-2">📥</span> Import Data
        </button>
        
        <button class="touch-btn w-full" onclick="clearCache()">
          <span class="mr-2">🗑️</span> Clear Cache
        </button>
        
        <button class="touch-btn danger w-full" onclick="resetApp()">
          <span class="mr-2">⚠️</span> Reset All Data
        </button>
      </div>
    </section>

    <!-- App Information -->
    <section class="mobile-card">
      <h3 class="text-lg font-semibold mb-4">ℹ️ App Information</h3>
      
      <div class="space-y-3 text-sm">
        <div class="flex justify-between">
          <span>Version</span>
          <span style="color: var(--text-secondary)">1.0.0</span>
        </div>
        
        <div class="flex justify-between">
          <span>Last Updated</span>
          <span style="color: var(--text-secondary)" id="lastUpdated">Today</span>
        </div>
        
        <div class="flex justify-between">
          <span>Storage Used</span>
          <span style="color: var(--text-secondary)" id="storageUsed">--</span>
        </div>
        
        <div class="flex justify-between">
          <span>Device</span>
          <span style="color: var(--text-secondary)" id="deviceInfo">--</span>
        </div>
      </div>
      
      <div class="mt-6 pt-4 border-t" style="border-color: var(--border-secondary)">
        <div class="text-center text-sm" style="color: var(--text-muted)">
          Security Companion v1.0<br>
          Built for security professionals
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-grid">
      <a href="index.html" class="nav-item">
        <div class="nav-icon">🏠</div>
        <span>Home</span>
      </a>
      <a href="schedule.html" class="nav-item">
        <div class="nav-icon">📋</div>
        <span>Schedule</span>
      </a>
      <a href="reports.html" class="nav-item">
        <div class="nav-icon">📝</div>
        <span>Reports</span>
      </a>
      <a href="patrol.html" class="nav-item">
        <div class="nav-icon">🚶</div>
        <span>Patrol</span>
      </a>
      <a href="profile.html" class="nav-item active">
        <div class="nav-icon">👤</div>
        <span>Profile</span>
      </a>
    </div>
  </nav>

  <!-- Contact Edit Modal -->
  <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="mobile-card max-w-sm mx-4">
      <h3 class="text-xl font-bold mb-4">✏️ Edit Emergency Contacts</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Supervisor Phone</label>
          <input type="tel" id="editSupervisor" class="form-input" placeholder="555-0123">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Dispatch Phone</label>
          <input type="tel" id="editDispatch" class="form-input" placeholder="555-0124">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Medical Phone</label>
          <input type="tel" id="editMedical" class="form-input" placeholder="555-0125">
        </div>
      </div>
      
      <div class="flex gap-3 mt-6">
        <button class="touch-btn flex-1" onclick="cancelEditContacts()">Cancel</button>
        <button class="touch-btn primary flex-1" onclick="saveContacts()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Theme management
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
    }


    // Profile management
    function loadProfile() {
      const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
      
      document.getElementById('officerName').value = profile.name || '';
      document.getElementById('badgeNumber').value = profile.badge || '';
      document.getElementById('department').value = profile.department || '';
      document.getElementById('shiftType').value = profile.shift || '';
      
      // Update display
      document.getElementById('profileName').textContent = profile.name || 'Officer Name';
      document.getElementById('profileBadge').textContent = profile.badge ? `Badge #${profile.badge}` : 'Badge #12345';
      
      // Update avatar
      const avatar = document.getElementById('profileAvatar');
      if (profile.name) {
        avatar.textContent = profile.name.charAt(0).toUpperCase();
      }
    }

    function saveProfile() {
      const profile = {
        name: document.getElementById('officerName').value.trim(),
        badge: document.getElementById('badgeNumber').value.trim(),
        department: document.getElementById('department').value.trim(),
        shift: document.getElementById('shiftType').value
      };
      
      localStorage.setItem('userProfile', JSON.stringify(profile));
      localStorage.setItem('officerName', profile.name); // For other pages
      
      // Update display
      document.getElementById('profileName').textContent = profile.name || 'Officer Name';
      document.getElementById('profileBadge').textContent = profile.badge ? `Badge #${profile.badge}` : 'Badge #12345';
      
      // Update avatar
      const avatar = document.getElementById('profileAvatar');
      if (profile.name) {
        avatar.textContent = profile.name.charAt(0).toUpperCase();
      }
      
      showSuccess('Profile saved successfully!');
    }

    // Contact management
    function loadContacts() {
      const contacts = JSON.parse(localStorage.getItem('emergencyContacts') || '{}');
      
      document.getElementById('supervisorPhone').textContent = contacts.supervisor || '555-0123';
      document.getElementById('dispatchPhone').textContent = contacts.dispatch || '555-0124';
      document.getElementById('medicalPhone').textContent = contacts.medical || '555-0125';
      
      // Update links
      document.querySelector('a[href^="tel:555-0123"]').href = `tel:${contacts.supervisor || '555-0123'}`;
      document.querySelector('a[href^="tel:555-0124"]').href = `tel:${contacts.dispatch || '555-0124'}`;
      document.querySelector('a[href^="tel:555-0125"]').href = `tel:${contacts.medical || '555-0125'}`;
    }

    function editContacts() {
      const contacts = JSON.parse(localStorage.getItem('emergencyContacts') || '{}');
      
      document.getElementById('editSupervisor').value = contacts.supervisor || '';
      document.getElementById('editDispatch').value = contacts.dispatch || '';
      document.getElementById('editMedical').value = contacts.medical || '';
      
      document.getElementById('contactModal').classList.remove('hidden');
      document.getElementById('contactModal').classList.add('flex');
    }

    function cancelEditContacts() {
      document.getElementById('contactModal').classList.add('hidden');
      document.getElementById('contactModal').classList.remove('flex');
    }

    function saveContacts() {
      const contacts = {
        supervisor: document.getElementById('editSupervisor').value.trim(),
        dispatch: document.getElementById('editDispatch').value.trim(),
        medical: document.getElementById('editMedical').value.trim()
      };
      
      localStorage.setItem('emergencyContacts', JSON.stringify(contacts));
      loadContacts();
      cancelEditContacts();
      showSuccess('Emergency contacts saved!');
    }

    // Permission requests
    async function requestLocation() {
      try {
        const permission = await navigator.permissions.query({ name: 'geolocation' });
        if (permission.state === 'granted') {
          document.getElementById('locationBtn').textContent = 'Enabled';
          document.getElementById('locationBtn').classList.add('primary');
        } else {
          navigator.geolocation.getCurrentPosition(
            () => {
              document.getElementById('locationBtn').textContent = 'Enabled';
              document.getElementById('locationBtn').classList.add('primary');
            },
            () => {
              showWarning('Location access denied. Please enable in browser settings.');
            }
          );
        }
      } catch (error) {
        console.error('Location permission error:', error);
      }
    }

    async function requestNotifications() {
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          document.getElementById('notificationBtn').textContent = 'Enabled';
          document.getElementById('notificationBtn').classList.add('primary');
          new Notification('Security Companion', {
            body: 'Notifications enabled successfully!',
            icon: '/icon-192.png'
          });
        } else {
          showWarning('Notification permission denied.');
        }
      } catch (error) {
        console.error('Notification permission error:', error);
      }
    }

    // Data management
    function exportData() {
      try {
        // Get all data
        const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
        const contacts = JSON.parse(localStorage.getItem('emergencyContacts') || '{}');
        const availability = JSON.parse(localStorage.getItem('guardAvailability') || '{}');
        const unavailableDates = JSON.parse(localStorage.getItem('unavailableDates') || '[]');
        const patrols = JSON.parse(localStorage.getItem('completedPatrols') || '[]');
        const incidents = JSON.parse(localStorage.getItem('savedIncidentReports') || '[]');
        const shifts = JSON.parse(localStorage.getItem('savedShiftReports') || '[]');
        const settings = {
          theme: localStorage.getItem('theme') || 'dark',
          largeText: localStorage.getItem('largeText') || 'false'
        };
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // PDF styling
        const primaryColor = [15, 15, 15]; // Dark theme primary
        const accentColor = [0, 122, 255]; // Blue accent
        const textColor = [51, 51, 51]; // Dark text
        const lightGray = [128, 128, 128]; // Light gray for secondary text
        
        let yPosition = 20;
        const leftMargin = 20;
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        
        // Helper function to add new page if needed
        function checkPageBreak(requiredSpace = 20) {
          if (yPosition + requiredSpace > pageHeight - 20) {
            doc.addPage();
            yPosition = 20;
          }
        }
        
        // Helper function to add section header
        function addSectionHeader(title, icon = '') {
          checkPageBreak(30);
          doc.setFontSize(16);
          doc.setTextColor(...accentColor);
          doc.setFont('helvetica', 'bold');
          doc.text(`${icon} ${title}`, leftMargin, yPosition);
          yPosition += 15;
          
          // Add underline
          doc.setDrawColor(...accentColor);
          doc.setLineWidth(0.5);
          doc.line(leftMargin, yPosition - 5, pageWidth - 20, yPosition - 5);
          yPosition += 10;
        }
        
        // Helper function to add field
        function addField(label, value, isSubItem = false) {
          checkPageBreak();
          const indent = isSubItem ? leftMargin + 10 : leftMargin;
          
          doc.setFontSize(10);
          doc.setTextColor(...textColor);
          doc.setFont('helvetica', 'bold');
          doc.text(`${label}:`, indent, yPosition);
          
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...lightGray);
          const labelWidth = doc.getTextWidth(`${label}: `);
          doc.text(value || 'Not specified', indent + labelWidth, yPosition);
          yPosition += 12;
        }
        
        // Header
        doc.setFontSize(20);
        doc.setTextColor(...primaryColor);
        doc.setFont('helvetica', 'bold');
        doc.text('Security Companion - Profile Data Export', leftMargin, yPosition);
        yPosition += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(...lightGray);
        doc.setFont('helvetica', 'normal');
        doc.text(`Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, leftMargin, yPosition);
        yPosition += 20;
        
        // Profile Section
        addSectionHeader('Profile Information', '👤');
        addField('Full Name', profile.name || 'Officer Name');
        addField('Badge Number', profile.badge || '#12345');
        addField('Department', profile.department || 'Not specified');
        
        // Format shift display
        let shiftDisplay = 'Not specified';
        if (profile.shift) {
          const shiftMap = {
            'day': 'Day Shift (6 AM - 6 PM)',
            'night': 'Night Shift (6 PM - 6 AM)',
            'swing': 'Swing Shift (2 PM - 10 PM)',
            'rotating': 'Rotating'
          };
          shiftDisplay = shiftMap[profile.shift] || profile.shift;
        }
        addField('Shift', shiftDisplay);
        yPosition += 10;
        
        // Availability Section
        if (availability && Object.keys(availability).length > 0) {
          addSectionHeader('Availability Settings', '🗓️');
          
          // Weekly availability
          if (availability.weekly) {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const availableDays = days.filter(day => availability.weekly[day] && availability.weekly[day].available);
            if (availableDays.length > 0) {
              doc.setFontSize(10);
              doc.setTextColor(...textColor);
              doc.setFont('helvetica', 'bold');
              doc.text('Available Days:', leftMargin, yPosition);
              yPosition += 8;
              
              availableDays.forEach(day => {
                const dayData = availability.weekly[day];
                const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                addField(dayName, `${dayData.start} - ${dayData.end}`, true);
              });
            }
          }
          
          // Shift preferences
          if (availability.shifts) {
            const activeShifts = Object.keys(availability.shifts).filter(shift => availability.shifts[shift]);
            if (activeShifts.length > 0) {
              addField('Preferred Shifts', activeShifts.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', '));
            }
          }
          
          addField('Maximum Hours/Week', availability.maxHours ? `${availability.maxHours} hours` : '40 hours');
          addField('Overtime Available', availability.overtime ? 'Yes' : 'No');
          addField('Emergency Calls', availability.emergencyCall ? 'Available' : 'Not Available');
          
          // Unavailable dates
          if (unavailableDates && unavailableDates.length > 0) {
            doc.setFontSize(10);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text('Upcoming Unavailable Dates:', leftMargin, yPosition);
            yPosition += 8;
            
            unavailableDates.slice(0, 5).forEach(date => {
              const startDate = new Date(date.start).toLocaleDateString();
              const endDate = new Date(date.end).toLocaleDateString();
              const dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;
              addField(dateRange, date.reason || 'No reason specified', true);
            });
          }
          
          yPosition += 10;
        }
        
        // Emergency Contacts Section
        addSectionHeader('Emergency Contacts', '📞');
        addField('Emergency Services', '911');
        addField('Supervisor', contacts.supervisor || '555-0123');
        addField('Dispatch Center', contacts.dispatch || '555-0124');
        addField('Medical Emergency', contacts.medical || '555-0125');
        yPosition += 10;
        
        // App Settings Section
        addSectionHeader('App Settings', '⚙️');
        addField('Theme', settings.theme === 'light' ? 'Light Mode' : 'Dark Mode');
        addField('Large Text', settings.largeText === 'true' ? 'Enabled' : 'Disabled');
        
        // Check location and notification permissions
        let locationStatus = 'Not enabled';
        let notificationStatus = 'Not enabled';
        
        if (navigator.permissions) {
          // These are async but we'll show current state
          if (document.getElementById('locationBtn').textContent === 'Enabled') {
            locationStatus = 'Enabled';
          }
        }
        
        if (Notification.permission === 'granted') {
          notificationStatus = 'Enabled';
        }
        
        addField('Location Services', locationStatus);
        addField('Notifications', notificationStatus);
        yPosition += 10;
        
        // Recent Activity Summary
        addSectionHeader('Activity Summary', '📊');
        addField('Completed Patrols', patrols.length.toString());
        addField('Incident Reports', incidents.length.toString());
        addField('Shift Reports', shifts.length.toString());
        yPosition += 10;
        
        // Recent Patrols (if any)
        if (patrols.length > 0) {
          addSectionHeader('Recent Patrols', '🚶');
          const recentPatrols = patrols.slice(-5); // Last 5 patrols
          recentPatrols.forEach((patrol, index) => {
            checkPageBreak(15);
            doc.setFontSize(10);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text(`Patrol ${index + 1}:`, leftMargin + 10, yPosition);
            yPosition += 8;
            
            if (patrol.date) addField('Date', new Date(patrol.date).toLocaleDateString(), true);
            if (patrol.location) addField('Location', patrol.location, true);
            if (patrol.duration) addField('Duration', patrol.duration, true);
            if (patrol.notes) {
              const notes = patrol.notes.length > 50 ? patrol.notes.substring(0, 50) + '...' : patrol.notes;
              addField('Notes', notes, true);
            }
            yPosition += 5;
          });
        }
        
        // Recent Incidents (if any)
        if (incidents.length > 0) {
          addSectionHeader('Recent Incident Reports', '📝');
          const recentIncidents = incidents.slice(-3); // Last 3 incidents
          recentIncidents.forEach((incident, index) => {
            checkPageBreak(20);
            doc.setFontSize(10);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text(`Incident ${index + 1}:`, leftMargin + 10, yPosition);
            yPosition += 8;
            
            if (incident.date) addField('Date', new Date(incident.date).toLocaleDateString(), true);
            if (incident.type) addField('Type', incident.type, true);
            if (incident.location) addField('Location', incident.location, true);
            if (incident.severity) addField('Severity', incident.severity, true);
            if (incident.description) {
              const desc = incident.description.length > 60 ? incident.description.substring(0, 60) + '...' : incident.description;
              addField('Description', desc, true);
            }
            yPosition += 5;
          });
        }
        
        // App Information
        addSectionHeader('App Information', 'ℹ️');
        addField('Version', '1.0.0');
        addField('Last Updated', 'Today');
        
        // Calculate storage usage
        let totalSize = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length;
          }
        }
        addField('Storage Used', `${(totalSize / 1024).toFixed(1)} KB`);
        addField('Device', navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop');
        
        // Footer
        checkPageBreak(30);
        yPosition += 10;
        doc.setFontSize(8);
        doc.setTextColor(...lightGray);
        doc.setFont('helvetica', 'italic');
        doc.text('Security Companion v1.0 - Built for security professionals', leftMargin, yPosition);
        yPosition += 8;
        doc.text('This document contains sensitive information. Handle according to your organization\'s data security policies.', leftMargin, yPosition);
        
        // Save the PDF
        const fileName = `security-companion-profile-${profile.name ? profile.name.replace(/\s+/g, '-').toLowerCase() : 'officer'}-${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
        showSuccess('Profile data exported to PDF successfully!');
        
      } catch (error) {
        console.error('PDF export error:', error);
        showError('Failed to export PDF. Please try again.');
      }
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            
            if (await showConfirm('This will overwrite your current data. Continue?')) {
              if (data.profile) localStorage.setItem('userProfile', JSON.stringify(data.profile));
              if (data.contacts) localStorage.setItem('emergencyContacts', JSON.stringify(data.contacts));
              if (data.availability) localStorage.setItem('guardAvailability', JSON.stringify(data.availability));
              if (data.unavailableDates) localStorage.setItem('unavailableDates', JSON.stringify(data.unavailableDates));
              if (data.patrols) localStorage.setItem('completedPatrols', JSON.stringify(data.patrols));
              if (data.incidents) localStorage.setItem('savedIncidentReports', JSON.stringify(data.incidents));
              if (data.shifts) localStorage.setItem('savedShiftReports', JSON.stringify(data.shifts));
              if (data.settings) {
                if (data.settings.theme) localStorage.setItem('theme', data.settings.theme);
                if (data.settings.largeText) localStorage.setItem('largeText', data.settings.largeText);
              }
              
              showSuccess('Data imported successfully! Please refresh the page.');
            }
          } catch (error) {
            showError('Invalid backup file format.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    async function clearCache() {
      if (await showConfirm('Clear app cache? This will not delete your saved data.')) {
        // Clear service worker cache if available
        if ('caches' in window) {
          caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
          });
        }
        showSuccess('Cache cleared successfully!');
      }
    }

    async function resetApp() {
      if (await showConfirm('This will delete ALL your data and reset the app. This cannot be undone. Continue?')) {
        if (await showConfirm('Are you absolutely sure? This will permanently delete all your reports, patrols, and settings.')) {
          localStorage.clear();
          sessionStorage.clear();
          showSuccess('App reset successfully! The page will now reload.');
          window.location.reload();
        }
      }
    }

    // Device info
    function loadDeviceInfo() {
      document.getElementById('deviceInfo').textContent = navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop';
      
      // Calculate storage usage
      let totalSize = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          totalSize += localStorage[key].length;
        }
      }
      document.getElementById('storageUsed').textContent = `${(totalSize / 1024).toFixed(1)} KB`;
      
      document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
    }

    // Availability Management Functions
    function initializeAvailability() {
      // Initialize weekly availability
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const container = document.getElementById('weeklyAvailability');
      
      let html = '';
      days.forEach((day, index) => {
        html += `
          <div class="p-3 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="flex items-center justify-between mb-2">
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="day-${day.toLowerCase()}" class="mr-2" style="width: 18px; height: 18px;" onchange="toggleDayAvailability('${day.toLowerCase()}')">
                <span class="font-medium">${day}</span>
              </label>
              <button class="text-sm" style="color: var(--text-secondary);" onclick="customizeDayHours('${day.toLowerCase()}')" id="customize-${day.toLowerCase()}" style="display: none;">
                Customize
              </button>
            </div>
            <div id="hours-${day.toLowerCase()}" class="hidden">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs" style="color: var(--text-secondary);">Start Time</label>
                  <input type="time" id="start-${day.toLowerCase()}" class="form-input text-sm" value="09:00">
                </div>
                <div>
                  <label class="text-xs" style="color: var(--text-secondary);">End Time</label>
                  <input type="time" id="end-${day.toLowerCase()}" class="form-input text-sm" value="17:00">
                </div>
              </div>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
      
      // Load saved availability
      loadAvailability();
      loadUnavailableDates();
    }
    
    function toggleDayAvailability(day) {
      const checkbox = document.getElementById(`day-${day}`);
      const customizeBtn = document.getElementById(`customize-${day}`);
      const hoursDiv = document.getElementById(`hours-${day}`);
      
      if (checkbox.checked) {
        customizeBtn.style.display = 'inline-block';
        hoursDiv.classList.remove('hidden');
      } else {
        customizeBtn.style.display = 'none';
        hoursDiv.classList.add('hidden');
      }
    }
    
    function customizeDayHours(day) {
      const hoursDiv = document.getElementById(`hours-${day}`);
      hoursDiv.classList.toggle('hidden');
    }
    
    function loadAvailability() {
      const availability = JSON.parse(localStorage.getItem('guardAvailability') || '{}');
      
      // Load weekly availability
      if (availability.weekly) {
        Object.keys(availability.weekly).forEach(day => {
          const checkbox = document.getElementById(`day-${day}`);
          const startInput = document.getElementById(`start-${day}`);
          const endInput = document.getElementById(`end-${day}`);
          
          if (checkbox && availability.weekly[day].available) {
            checkbox.checked = true;
            toggleDayAvailability(day);
            
            if (startInput && availability.weekly[day].start) {
              startInput.value = availability.weekly[day].start;
            }
            if (endInput && availability.weekly[day].end) {
              endInput.value = availability.weekly[day].end;
            }
          }
        });
      }
      
      // Load shift preferences
      if (availability.shifts) {
        Object.keys(availability.shifts).forEach(shift => {
          const checkbox = document.getElementById(`shift-${shift}`);
          if (checkbox) {
            checkbox.checked = availability.shifts[shift];
          }
        });
      }
      
      // Load other settings
      if (availability.maxHours) {
        document.getElementById('maxHoursPerWeek').value = availability.maxHours;
      }
      if (availability.overtime !== undefined) {
        document.getElementById('overtimeAvailable').checked = availability.overtime;
      }
      if (availability.emergencyCall !== undefined) {
        document.getElementById('emergencyCallAvailable').checked = availability.emergencyCall;
      }
      if (availability.notes) {
        document.getElementById('availabilityNotes').value = availability.notes;
      }
    }
    
    function saveAvailability() {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const weekly = {};
      
      // Collect weekly availability
      days.forEach(day => {
        const checkbox = document.getElementById(`day-${day}`);
        const startInput = document.getElementById(`start-${day}`);
        const endInput = document.getElementById(`end-${day}`);
        
        weekly[day] = {
          available: checkbox ? checkbox.checked : false,
          start: startInput ? startInput.value : '09:00',
          end: endInput ? endInput.value : '17:00'
        };
      });
      
      // Collect shift preferences
      const shifts = {
        morning: document.getElementById('shift-morning').checked,
        afternoon: document.getElementById('shift-afternoon').checked,
        night: document.getElementById('shift-night').checked,
        weekend: document.getElementById('shift-weekend').checked
      };
      
      // Collect other settings
      const availability = {
        weekly: weekly,
        shifts: shifts,
        maxHours: parseInt(document.getElementById('maxHoursPerWeek').value) || 40,
        overtime: document.getElementById('overtimeAvailable').checked,
        emergencyCall: document.getElementById('emergencyCallAvailable').checked,
        notes: document.getElementById('availabilityNotes').value.trim(),
        unavailableDates: JSON.parse(localStorage.getItem('unavailableDates') || '[]'),
        lastUpdated: new Date().toISOString()
      };
      
      localStorage.setItem('guardAvailability', JSON.stringify(availability));
      showSuccess('Availability settings saved successfully!');
    }
    
    function addUnavailableDate() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="mobile-card max-w-sm mx-4">
          <h3 class="text-xl font-bold mb-4">Add Unavailable Date</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Start Date</label>
              <input type="date" id="unavailStartDate" class="form-input" min="${new Date().toISOString().split('T')[0]}">
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2">End Date</label>
              <input type="date" id="unavailEndDate" class="form-input" min="${new Date().toISOString().split('T')[0]}">
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2">Reason (Optional)</label>
              <input type="text" id="unavailReason" class="form-input" placeholder="Vacation, Personal, Medical, etc.">
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button class="touch-btn flex-1" onclick="this.closest('.fixed').remove()">Cancel</button>
            <button class="touch-btn primary flex-1" onclick="saveUnavailableDate()">Save</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Set default end date to same as start date
      document.getElementById('unavailStartDate').addEventListener('change', function() {
        const endDate = document.getElementById('unavailEndDate');
        if (!endDate.value) {
          endDate.value = this.value;
        }
        endDate.min = this.value;
      });
    }
    
    function saveUnavailableDate() {
      const startDate = document.getElementById('unavailStartDate').value;
      const endDate = document.getElementById('unavailEndDate').value;
      const reason = document.getElementById('unavailReason').value.trim();
      
      if (!startDate || !endDate) {
        showWarning('Please select both start and end dates');
        return;
      }
      
      const unavailableDates = JSON.parse(localStorage.getItem('unavailableDates') || '[]');
      unavailableDates.push({
        id: Date.now().toString(),
        start: startDate,
        end: endDate,
        reason: reason,
        createdAt: new Date().toISOString()
      });
      
      localStorage.setItem('unavailableDates', JSON.stringify(unavailableDates));
      document.querySelector('.fixed').remove();
      loadUnavailableDates();
      showSuccess('Unavailable dates added successfully!');
    }
    
    function loadUnavailableDates() {
      const container = document.getElementById('unavailableDates');
      const unavailableDates = JSON.parse(localStorage.getItem('unavailableDates') || '[]');
      
      // Filter out past dates
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const futureDates = unavailableDates.filter(date => new Date(date.end) >= today);
      
      if (futureDates.length === 0) {
        container.innerHTML = '<div class="text-sm" style="color: var(--text-muted);">No unavailable dates scheduled</div>';
        return;
      }
      
      let html = '';
      futureDates.forEach(date => {
        const startDate = new Date(date.start).toLocaleDateString();
        const endDate = new Date(date.end).toLocaleDateString();
        const dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;
        
        html += `
          <div class="p-2 rounded flex justify-between items-center" style="background: var(--bg-tertiary);">
            <div>
              <div class="text-sm font-medium">${dateRange}</div>
              ${date.reason ? `<div class="text-xs" style="color: var(--text-secondary);">${date.reason}</div>` : ''}
            </div>
            <button class="text-sm" style="color: var(--error);" onclick="removeUnavailableDate('${date.id}')">
              Remove
            </button>
          </div>
        `;
      });
      container.innerHTML = html;
      
      // Update localStorage to remove past dates
      localStorage.setItem('unavailableDates', JSON.stringify(futureDates));
    }
    
    function removeUnavailableDate(id) {
      if (!confirm('Remove this unavailable date?')) {
        return;
      }
      
      const unavailableDates = JSON.parse(localStorage.getItem('unavailableDates') || '[]');
      const updated = unavailableDates.filter(date => date.id !== id);
      localStorage.setItem('unavailableDates', JSON.stringify(updated));
      loadUnavailableDates();
      showSuccess('Unavailable date removed');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initTheme();
      loadProfile();
      loadContacts();
      loadDeviceInfo();
      initializeAvailability();
      
      // Check permissions
      if (navigator.permissions) {
        navigator.permissions.query({ name: 'geolocation' }).then(permission => {
          if (permission.state === 'granted') {
            document.getElementById('locationBtn').textContent = 'Enabled';
            document.getElementById('locationBtn').classList.add('primary');
          }
        });
      }
      
      if (Notification.permission === 'granted') {
        document.getElementById('notificationBtn').textContent = 'Enabled';
        document.getElementById('notificationBtn').classList.add('primary');
      }
    });
  </script>
</body>
</html>