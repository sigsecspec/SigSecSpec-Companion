<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Incident Report — Signature Security Specialist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#0f0f0f; --card:#121212; --muted:#bfc0b0; --accent:#aeae5a; --accent-2:#5c6249; --glass:rgba(255,255,255,0.04); }
    html,body{ background:#0f0f0f url('patch-bg.png') center center / 300px no-repeat; color:#fff; height:100%; margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; display:flex; flex-direction:column; }
    .app-card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,0.04); border-radius:12px; padding:1rem; }
    #bottomNav{ position:fixed; left:0; right:0; bottom:0; width:100%; height:var(--bottom-nav-height,56px); display:flex; justify-content:space-around; align-items:center; gap:.25rem; background:rgba(17,17,17,0.9); backdrop-filter:saturate(180%) blur(10px); border-top:1px solid rgba(255,255,255,0.06); z-index:60; padding:0 .5rem calc(env(safe-area-inset-bottom,0px)); }
    #bottomNav a{ flex:1 1 0; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nav-link{ border-radius:10px; padding:.5rem .75rem; transition:background 160ms ease; }
    .nav-link[aria-current="page"]{ background:rgba(255,255,255,0.08); }
    #mainContent{ padding-bottom: calc(var(--bottom-nav-height,56px) + env(safe-area-inset-bottom,0px) + 12px); }
    .accent{ color:var(--accent); }
    @media print{
      html,body{ background:#fff !important; color:#000 !important; }
      header,#bottomNav{ display:none !important; }
      #mainContent{ padding:0 !important; }
      #formControls,#statusLine,.controls-bar{ display:none !important; }
      #templatePreview{ border:0 !important; padding:0 !important; color:#000 !important; font-size:12pt; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; }
    }
  </style>
</head>
<body>
  <header class="p-4 pb-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-extrabold">Signature Security Specialist</h1>
      <p class="text-sm text-gray-400">Incident Report — fill, preview, copy</p>
    </div>
    <div class="flex space-x-2">
      <button onclick="toggleLarge()" class="bg-[#111] px-3 py-2 rounded-md border border-white/10">A+</button>
    </div>
  </header>

  <main id="mainContent" class="flex-1 overflow-auto p-5">
    <section class="max-w-4xl mx-auto space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end controls-bar">
        <div class="text-sm text-gray-300">Incident Report</div>
        <div class="flex flex-wrap gap-2 md:justify-end">
          <button id="btnImportIncident" class="px-3 py-2 rounded-md bg-[#111] border border-white/10">Import Latest Incident</button>
          <button id="btnSaveDraft" class="px-3 py-2 rounded-md bg-[#111] border border-white/10">Save Draft</button>
          <button id="btnLoadDraft" class="px-3 py-2 rounded-md bg-[#111] border border-white/10">Load Draft</button>
          <button id="btnClear" class="px-3 py-2 rounded-md bg-[#111] border border-white/10">Clear</button>
          <button id="btnSaveReport" class="px-3 py-2 rounded-md bg-[#111] border border-white/10">Save Report</button>
          <button id="btnCopy" class="px-3 py-2 rounded-md bg-[#111] border border-white/10">Copy</button>
        </div>
      </div>
      <div id="statusLine" class="text-sm text-gray-400"></div>
      <div id="formControls" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
      <div class="app-card">
        <div class="font-semibold mb-2">Preview</div>
        <pre id="templatePreview" class="whitespace-pre-wrap text-sm text-gray-200"></pre>
      </div>
    </section>
  </main>

  <nav id="bottomNav">
    <a href="index.html" class="nav-link">Home</a>
    <a href="codes.html" class="nav-link">Codes</a>
    <a href="radio.html" class="nav-link">Phonetics</a>
    <a href="incident.html" class="nav-link" aria-current="page">Incident</a>
    <a href="shift.html" class="nav-link">Shift</a>
    <a href="reports.html" class="nav-link">Reports</a>
  </nav>

  <script>
    function toggleLarge(){ document.body.classList.toggle('text-lg'); localStorage.setItem('sss_large', document.body.classList.contains('text-lg')); }
    document.addEventListener('DOMContentLoaded',()=>{ if(localStorage.getItem('sss_large')==='true') document.body.classList.add('text-lg'); });
    // Fixed bottom nav; no scroll toggling required

    const STORE_KEYS = { profile:'sss_profile', incidents:'sss_incidents', templateDrafts:'sss_template_drafts', savedIncidentReports:'sss_saved_incident_reports' };
    function loadJson(key,fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; } }
    function saveJson(key,value){ localStorage.setItem(key, JSON.stringify(value)); }

    const fieldsContainer = document.getElementById('formControls');
    const previewEl = document.getElementById('templatePreview');
    const statusEl = document.getElementById('statusLine');
    const btnImport = document.getElementById('btnImportIncident');
    const btnSave = document.getElementById('btnSaveDraft');
    const btnLoad = document.getElementById('btnLoadDraft');
    const btnClear = document.getElementById('btnClear');
    const btnCopy = document.getElementById('btnCopy');
    const btnSaveReport = document.getElementById('btnSaveReport');

    const TEMPLATE = {
      id: 'incident_report',
      name: 'Incident Report',
      fields: [
        { key:'dateTime', label:'Date / Time', type:'datetime-local' },
        { key:'guardName', label:'Guard Name', type:'text' },
        { key:'post', label:'Post / Location', type:'text' },
        { key:'location', label:'Where (Location)', type:'text' },
        { key:'locationDetails', label:'Where (Details)', type:'text' },
        { key:'incidentType', label:'Incident Type', type:'select', options:['Trespass','Disturbance','Theft','Medical','Property Damage','Other'] },
        { key:'participants', label:'Who (Participants)', type:'participants', roles:['Suspect','Victim','Witness'] },
        { key:'what', label:'Narrative', type:'textarea', rows:4, placeholder:'Objective narrative. Tip: tap role labels below to insert tokens (e.g., suspect1); tokens expand to names in preview.' },
        { key:'details', label:'Actions Taken / Additional Details', type:'textarea', rows:4 },
        { key:'injuries', label:'Injuries', type:'textarea', rows:2 },
        { key:'evidence', label:'Evidence/Attachments', type:'textarea', rows:2 },
        { key:'reportingParty', label:'Reporting Party', type:'text' }
      ],
      body: (
        'Incident Report\n' +
        'Who:\n{whoSection}\n\n' +
        'Narrative:\n{whatExpanded}\n\n' +
        'When:\n{when}\n\n' +
        'Where:\n{where}\n\n' +
        'Type: {incidentType}\n' +
        'Details:\n{detailsExpanded}\n\n' +
        'Injuries:\n{injuries}\n\n' +
        'Evidence/Attachments:\n{evidence}\n\n' +
        'Reporting Party: {reportingParty}\n' +
        'Officer: {guardName}\n' +
        'Post: {post}'
      )
    };

    let fieldValues = {};

    function toDisplay(value){ return (value==null || String(value).trim()==='') ? 'N/A' : String(value); }
    function ensureArray(v){ return Array.isArray(v) ? v : []; }
    function normalizeRole(role){
      const r = String(role||'').toLowerCase();
      if (r.startsWith('sus')) return 'suspect';
      if (r.startsWith('vic')) return 'victim';
      if (r.startsWith('wit')) return 'witness';
      if (r.startsWith('subj')) return 'suspect';
      return r || 'other';
    }
    function groupParticipants(list){
      const groups = { suspect: [], victim: [], witness: [], other: [] };
      ensureArray(list).forEach(p => {
        const name = (p && p.name) ? String(p.name).trim() : '';
        const role = normalizeRole(p && p.role);
        groups[role] = groups[role] || [];
        groups[role].push(name);
      });
      Object.keys(groups).forEach(k => { groups[k] = groups[k].filter(Boolean); });
      return groups;
    }
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function buildTokenMap(groups){
      const map = {};
      const add = (base, names) => { names.forEach((nm, idx) => { if (!nm) return; map[base + String(idx+1)] = nm; }); };
      add('suspect', groups.suspect||[]);
      add('subject', groups.suspect||[]);
      add('victim', groups.victim||[]);
      add('witness', groups.witness||[]);
      return map;
    }
    function expandTokens(text, tokenMap){
      const keys = Object.keys(tokenMap);
      if (!text || keys.length === 0) return text || '';
      const pattern = new RegExp('\\b(' + keys.map(escapeRegExp).join('|') + ')\\b', 'gi');
      return text.replace(pattern, (m) => tokenMap[m.toLowerCase()] || m);
    }
    function buildWhoSection(groups){
      const lines = [];
      const pushLines = (label, arr) => { arr.forEach((nm, i) => { lines.push(`- ${label} ${i+1}: ${nm}`); }); };
      if ((groups.suspect||[]).length) pushLines('Suspect', groups.suspect);
      if ((groups.victim||[]).length) pushLines('Victim', groups.victim);
      if ((groups.witness||[]).length) pushLines('Witness', groups.witness);
      return lines.length ? lines.join('\n') : 'N/A';
    }
    function insertAtCursor(textarea, text){
      if(!textarea) return;
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const before = textarea.value.slice(0, start);
      const after = textarea.value.slice(end);
      textarea.value = before + text + after;
      const pos = start + text.length;
      textarea.selectionStart = textarea.selectionEnd = pos;
      textarea.focus();
    }
    function insertTokenIntoNarrative(token){
      const ta = document.querySelector('textarea[data-key="what"]');
      const toInsert = (token || '').trim();
      if(!ta || !toInsert) return;
      insertAtCursor(ta, toInsert + ' ');
      ta.dispatchEvent(new Event('input', { bubbles:true }));
    }
    function compileBody(){
      const participants = ensureArray(fieldValues.participants);
      const groups = groupParticipants(participants);
      const tokenMap = buildTokenMap(groups);
      const whenText = toDisplay(fieldValues.dateTime);
      const whereText = toDisplay([fieldValues.location||'', fieldValues.locationDetails||''].filter(Boolean).join(' — '));
      const computed = {
        whoSection: buildWhoSection(groups),
        when: whenText,
        where: whereText,
        whatExpanded: expandTokens(fieldValues.what || '', tokenMap),
        detailsExpanded: expandTokens(fieldValues.details || '', tokenMap)
      };
      return TEMPLATE.body.replace(/\{(.*?)\}/g, (_,k)=> (k in computed) ? toDisplay(computed[k]) : toDisplay(fieldValues[k]));
    }

    function saveIncidentReport(){
      if (!isIncidentWsComplete()) { statusEl.textContent='Please complete Who, What, When, and Where before saving.'; return; }
      const bodyText = compileBody();
      const arr = loadJson(STORE_KEYS.savedIncidentReports, []);
      const record = {
        id: 'inc_'+Date.now(),
        category: 'incident',
        templateId: TEMPLATE.id,
        at: Date.now(),
        fields: { ...fieldValues },
        meta: {
          dateTime: fieldValues.dateTime || '',
          type: fieldValues.incidentType || '',
          post: fieldValues.post || '',
          where: [fieldValues.location||'', fieldValues.locationDetails||''].filter(Boolean).join(' — ')
        },
        body: bodyText
      };
      arr.unshift(record);
      saveJson(STORE_KEYS.savedIncidentReports, arr);
      statusEl.textContent = 'Incident report saved.';
    }

    function formatDateTimeForInput(iso){ try{ if(!iso) return ''; const d=new Date(iso); if(isNaN(d.getTime())) return ''; const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }catch{return '';} }

    function createInput(field){
      const commonCls = 'w-full bg-[#111] border border-white/10 rounded-md px-3 py-2';
      let el;
      if(field.type==='textarea'){
        el=document.createElement('textarea'); el.className=commonCls; el.rows=field.rows||3; if(field.placeholder) el.placeholder=field.placeholder; el.value=fieldValues[field.key]||''; el.addEventListener('input',onChange);
      } else if(field.type==='participants'){
        const container = document.createElement('div');
        container.className = 'space-y-2';
        const roles = Array.isArray(field.roles) && field.roles.length ? field.roles : ['Suspect','Victim','Witness'];
        if (!Array.isArray(fieldValues[field.key])) fieldValues[field.key] = [];

        function renderRows(){
          container.innerHTML = '';
          const list = ensureArray(fieldValues[field.key]);
          const counters = {};
          list.forEach((p) => { const r = normalizeRole(p.role||''); counters[r] = (counters[r]||0) + 1; p._idx = counters[r]; });
          list.forEach((p, idx) => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';

            const roleSel = document.createElement('select');
            roleSel.className = 'bg-[#111] border border-white/10 rounded-md px-2 py-2';
            roles.forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; roleSel.appendChild(o); });
            roleSel.value = p.role || roles[0];

            const label = document.createElement('button');
            label.type = 'button';
            label.className = 'text-xs text-gray-400 w-24 text-left underline decoration-dotted decoration-white/20 cursor-pointer';
            label.textContent = `${roleSel.value} ${p._idx || 1}`;
            label.title = 'Tap to insert role token into Narrative';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Name';
            nameInput.className = 'flex-1 ' + commonCls;
            nameInput.value = p.name || '';

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'px-2 py-2 bg-[#111] border border-white/10 rounded-md';
            delBtn.textContent = 'Remove';

            const insertBtn = document.createElement('button');
            insertBtn.type = 'button';
            insertBtn.className = 'px-2 py-2 bg-[#111] border border-white/10 rounded-md';
            insertBtn.textContent = 'Insert to Narrative';

            roleSel.addEventListener('change', () => {
              const arr = ensureArray(fieldValues[field.key]);
              if (!arr[idx]) return; arr[idx].role = roleSel.value; renderRows(); updatePreview();
            });
            nameInput.addEventListener('input', () => {
              const arr = ensureArray(fieldValues[field.key]);
              if (!arr[idx]) return; arr[idx].name = nameInput.value; updatePreview();
            });
            delBtn.addEventListener('click', () => {
              const arr = ensureArray(fieldValues[field.key]);
              arr.splice(idx,1); fieldValues[field.key] = arr; renderRows(); updatePreview();
            });

            label.addEventListener('click', () => {
              const base = normalizeRole(roleSel.value);
              const token = `${base}${p._idx || 1}`;
              insertTokenIntoNarrative(token);
            });
            insertBtn.addEventListener('click', () => {
              const arr = ensureArray(fieldValues[field.key]);
              const current = arr[idx] || {};
              const name = String(current.name||'').trim();
              const base = normalizeRole(roleSel.value);
              const fallback = `${base}${p._idx || 1}`;
              insertTokenIntoNarrative(name || fallback);
            });

            row.appendChild(roleSel);
            row.appendChild(label);
            row.appendChild(nameInput);
            row.appendChild(delBtn);
            row.appendChild(insertBtn);
            container.appendChild(row);
          });

          const btnRow = document.createElement('div');
          btnRow.className = 'flex flex-wrap gap-2';
          roles.forEach(r => {
            const btn = document.createElement('button');
            btn.type = 'button'; btn.className = 'px-2 py-2 bg-[#111] border border-white/10 rounded-md'; btn.textContent = `Add ${r}`;
            btn.addEventListener('click', () => {
              const arr = ensureArray(fieldValues[field.key]); arr.push({ role: r, name: '' }); fieldValues[field.key] = arr; renderRows(); updatePreview();
            });
            btnRow.appendChild(btn);
          });
          const hint = document.createElement('div'); hint.className = 'text-xs text-gray-400'; hint.textContent = 'Tip: Tap role label to insert token or use Insert to add the name. Tokens expand to full names in preview/copy.';
          container.appendChild(btnRow);
          container.appendChild(hint);
        }
        renderRows();
        el = container;
      } else if(field.type==='select'){
        el=document.createElement('select'); el.className=commonCls; (field.options||[]).forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; el.appendChild(o); }); el.value=fieldValues[field.key]|| (field.options?.[0]||''); el.addEventListener('change',onChange);
      } else {
        el=document.createElement('input'); el.type=field.type||'text'; el.className=commonCls; el.value=fieldValues[field.key]||''; el.addEventListener('input',onChange);
      }
      el.dataset.key = field.key; return el;
    }

    function renderFields(){
      fieldsContainer.innerHTML='';
      TEMPLATE.fields.forEach(field=>{
        const wrap=document.createElement('label'); wrap.className='block';
        const title=document.createElement('div'); title.className='text-sm text-gray-300 mb-1'; title.textContent=field.label;
        const input=createInput(field);
        wrap.appendChild(title); wrap.appendChild(input); fieldsContainer.appendChild(wrap);
      });
      updatePreview();
    }

    function updatePreview(){ previewEl.textContent = compileBody(); }
    function onChange(e){ const key=e.target.dataset.key; if(!key) return; fieldValues[key] = (e.target.type==='checkbox') ? e.target.checked : e.target.value; updatePreview(); }

    function prefillDefaults(){
      const prof=loadJson(STORE_KEYS.profile,{});
      if('guardName' in fieldValues && !fieldValues.guardName) fieldValues.guardName = prof.name || '';
      const nowIso = new Date().toISOString();
      TEMPLATE.fields.forEach(f=>{
        if(f.type==='datetime-local' && !fieldValues[f.key]) fieldValues[f.key] = formatDateTimeForInput(nowIso);
      });
    }

    function importFromIncident(){
      const inc = (loadJson(STORE_KEYS.incidents, [])[0]) || null;
      if(!inc){ statusEl.textContent='No incident found to import.'; return; }
      const map = { dateTime: formatDateTimeForInput(inc.at), post: inc.post||'', incidentType: inc.type||'', summary: inc.desc||'' };
      Object.keys(map).forEach(k=>{ if(k in fieldValues) fieldValues[k] = map[k]; });
      statusEl.textContent='Imported latest incident.';
      renderFields();
    }

    function saveDraft(){ const drafts = loadJson(STORE_KEYS.templateDrafts, {}); drafts[TEMPLATE.id] = fieldValues; saveJson(STORE_KEYS.templateDrafts, drafts); statusEl.textContent='Draft saved.'; }
    function loadDraft(){ const drafts = loadJson(STORE_KEYS.templateDrafts, {}); fieldValues = { ...(drafts[TEMPLATE.id] || {}) }; statusEl.textContent=drafts[TEMPLATE.id]?'Draft loaded.':'No draft saved.'; renderFields(); }
    function clearFields(){ fieldValues={}; prefillDefaults(); statusEl.textContent='Cleared.'; renderFields(); }

    function isIncidentWsComplete(){
      const hasWhat = String(fieldValues.what||'').trim().length > 0;
      const hasWhen = String(fieldValues.dateTime||'').trim().length > 0;
      const hasWhere = String([fieldValues.location||'', fieldValues.locationDetails||''].join('')).trim().length > 0;
      const participants = ensureArray(fieldValues.participants);
      const hasWho = participants.some(p => (p && String(p.name||'').trim().length > 0));
      return hasWhat && hasWhen && hasWhere && hasWho;
    }

    async function copyToClipboard(){
      if (!isIncidentWsComplete()) { statusEl.textContent='Please complete Who, What, When, and Where before copying.'; return; }
      const text = compileBody();
      try{ await navigator.clipboard.writeText(text); statusEl.textContent='Copied to clipboard.'; }
      catch{
        try{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); statusEl.textContent='Copied to clipboard.'; }
        catch{ statusEl.textContent='Copy failed. Select and copy manually.'; }
      }
    }

    btnImport.addEventListener('click', importFromIncident);
    btnSave.addEventListener('click', saveDraft);
    btnLoad.addEventListener('click', loadDraft);
    btnClear.addEventListener('click', clearFields);
    btnCopy.addEventListener('click', copyToClipboard);
    btnSaveReport.addEventListener('click', saveIncidentReport);

    // init
    fieldValues = {};
    prefillDefaults();
    renderFields();
  </script>
</body>
</html>
